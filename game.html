<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è§…é•¿ç”Ÿ1.7</title>
    <link rel="stylesheet" href="css/xiuxian-style.css">
    
    <!-- æ¸¸æˆä¸“ç”¨æ•°æ®éš”ç¦»è„šæœ¬ - å¿…é¡»åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰åŠ è½½ -->
    <script>
        // ä¸ºä¸»æ¸¸æˆåˆ›å»ºç‹¬ç«‹çš„æ•°æ®å‘½åç©ºé—´
        (function() {
            const GAME_PREFIX = 'game_';
            const GAME_DB_NAME = 'game_xiuxian_dlc_db';
            const GAME_VECTOR_DB_NAME = 'game_VectorDB';
            
            // åŒ…è£…localStorageï¼Œè‡ªåŠ¨æ·»åŠ game_å‰ç¼€
            const originalLocalStorage = {
                getItem: localStorage.getItem.bind(localStorage),
                setItem: localStorage.setItem.bind(localStorage),
                removeItem: localStorage.removeItem.bind(localStorage),
                clear: localStorage.clear.bind(localStorage)
            };
            
            // é‡å†™localStorageæ–¹æ³•
            Storage.prototype.getItem = function(key) {
                return originalLocalStorage.getItem(GAME_PREFIX + key);
            };
            
            Storage.prototype.setItem = function(key, value) {
                return originalLocalStorage.setItem(GAME_PREFIX + key, value);
            };
            
            Storage.prototype.removeItem = function(key) {
                return originalLocalStorage.removeItem(GAME_PREFIX + key);
            };
            
            // clearæ–¹æ³•åªæ¸…é™¤game_å‰ç¼€çš„æ•°æ®
            Storage.prototype.clear = function() {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(GAME_PREFIX)) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => originalLocalStorage.removeItem(key));
            };
            
            // ä¿å­˜é…ç½®ä¾›DLCManagerä½¿ç”¨
            window.GAME_CONFIG = {
                DB_NAME: GAME_DB_NAME,
                VECTOR_DB_NAME: GAME_VECTOR_DB_NAME
            };
            
            console.log('[ä¸»æ¸¸æˆ] æ•°æ®éš”ç¦»å·²å¯ç”¨ - localStorageå‰ç¼€:', GAME_PREFIX);
            console.log('[ä¸»æ¸¸æˆ] DLCæ•°æ®åº“å:', GAME_DB_NAME);
        })();
    </script>
</head>

<body>
    <!-- ç§»åŠ¨ç«¯Tabåˆ‡æ¢ -->
    <div class="mobile-tabs">
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="game" onclick="switchMobileTab('game')">
                ğŸ® æ¸¸æˆ
            </button>
            <button class="tab-btn" data-tab="status" onclick="switchMobileTab('status')">
                ğŸ“Š çŠ¶æ€
            </button>
        </div>
    </div>
    <!-- é…ç½®å¼¹çª—é€šè¿‡JSç”Ÿæˆ -->
    <script src="./js/config-modal.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½é…ç½®å¼¹çª—
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadConfigModal();
                // åˆå§‹åŒ–äººç‰©å›¾è°±
                setTimeout(initCharacterGraphSystem, 1500);
            });
        } else {
            loadConfigModal();
            // åˆå§‹åŒ–äººç‰©å›¾è°±
            setTimeout(initCharacterGraphSystem, 1500);
        }
        
        // åˆå§‹åŒ–äººç‰©å›¾è°±ç³»ç»Ÿ
        async function initCharacterGraphSystem() {
            try {
                console.log('[äººç‰©å›¾è°±] å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿ...');
                
                // ğŸ”§ ç­‰å¾…æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ
                let retryCount = 0;
                const maxRetries = 30; // 3ç§’ï¼Œæ¯100msæ£€æŸ¥ä¸€æ¬¡
                
                while ((!window.characterGraphManager || !window.characterGraphIntegration || !window.initializeCharacterGraphHooks) && retryCount < maxRetries) {
                    console.log(`[äººç‰©å›¾è°±] â³ ç­‰å¾…æ‰€æœ‰æ¨¡å—åŠ è½½... (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retryCount++;
                }
                
                // æ£€æŸ¥æ¨¡å—æ˜¯å¦éƒ½å¯ç”¨
                if (!window.characterGraphManager) {
                    console.error('[äººç‰©å›¾è°±] âŒ CharacterGraphManager æœªæ‰¾åˆ°');
                    return;
                }
                if (!window.characterGraphIntegration) {
                    console.error('[äººç‰©å›¾è°±] âŒ CharacterGraphIntegration æœªæ‰¾åˆ°');
                    return;
                }
                if (!window.initializeCharacterGraphHooks) {
                    console.error('[äººç‰©å›¾è°±] âŒ CharacterGraphHooks æœªæ‰¾åˆ°');
                    return;
                }
                
                // æŒ‰é¡ºåºåˆå§‹åŒ–
                console.log('[äººç‰©å›¾è°±] ğŸ”„ åˆå§‹åŒ–ç®¡ç†å™¨...');
                await window.characterGraphManager.init();
                console.log('âœ… äººç‰©å›¾è°±ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                
                console.log('[äººç‰©å›¾è°±] ğŸ”„ åˆå§‹åŒ–é›†æˆ...');
                await window.characterGraphIntegration.init();
                console.log('âœ… äººç‰©å›¾è°±é›†æˆåˆå§‹åŒ–å®Œæˆ');
                
                console.log('[äººç‰©å›¾è°±] ğŸ”„ åˆå§‹åŒ–é’©å­...');
                window.initializeCharacterGraphHooks();
                console.log('âœ… äººç‰©å›¾è°±é’©å­åˆå§‹åŒ–å®Œæˆ');
                
                console.log('[äººç‰©å›¾è°±] âœ… ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('[äººç‰©å›¾è°±] âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // å…¨å±€å‡½æ•°ï¼šåˆ‡æ¢ç§»åŠ¨ç«¯tab
        function switchMobileTab(tabName) {
            console.log('[ç§»åŠ¨ç«¯Tab] åˆ‡æ¢åˆ°:', tabName);
            
            try {
                // ç§»é™¤æ‰€æœ‰activeç±»
                const tabBtns = document.querySelectorAll('.tab-btn');
                console.log('[ç§»åŠ¨ç«¯Tab] æ‰¾åˆ°tabæŒ‰é’®æ•°é‡:', tabBtns.length);
                tabBtns.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const gamePanel = document.querySelector('.game-panel');
                const statusPanel = document.querySelector('.status-panel');
                console.log('[ç§»åŠ¨ç«¯Tab] æ‰¾åˆ°é¢æ¿:', {
                    gamePanel: !!gamePanel,
                    statusPanel: !!statusPanel
                });
                
                if (gamePanel) gamePanel.classList.remove('active');
                if (statusPanel) statusPanel.classList.remove('active');

                // æ·»åŠ å¯¹åº”çš„activeç±»
                const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
                console.log('[ç§»åŠ¨ç«¯Tab] ç›®æ ‡tab:', !!targetTab);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                if (tabName === 'game') {
                    if (gamePanel) {
                        gamePanel.classList.add('active');
                        console.log('[ç§»åŠ¨ç«¯Tab] å·²æ¿€æ´»æ¸¸æˆé¢æ¿');
                    }
                } else if (tabName === 'status') {
                    if (statusPanel) {
                        statusPanel.classList.add('active');
                        console.log('[ç§»åŠ¨ç«¯Tab] å·²æ¿€æ´»çŠ¶æ€é¢æ¿');
                    }
                }
            } catch (error) {
                console.error('[ç§»åŠ¨ç«¯Tab] åˆ‡æ¢å¤±è´¥:', error);
            }
        }
    </script>

    <div class="container">
        <!-- ä¸­é—´æ¸¸æˆé¢æ¿ -->
        <div class="panel game-panel active">
            <div style="display: flex; justify-content: space-between; align-items: center;padding:10px;box-sizing: border-box;">
                <h2>ä¿®ä»™æ¨¡æ‹Ÿå™¨</h2>
                <button class="config-toggle-btn" onclick="openConfigModal()"> è®¾ç½®</button>
            </div>
            <div id="gameHistory"></div>
            <div id="debugOutput" style="display:none; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; white-space: pre-wrap; background:#0b1220; color:#e6edf3; border-radius:8px; padding:12px; margin-top:10px; max-height: 50vh; overflow:auto; border:1px solid #1f2a44;"></div>
            <div class="controls" style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-primary" id="startGame" onclick="startGame()"
                    style="display: none;">å¼€å§‹æ¸¸æˆ</button>
                <div style="display: flex; gap: 10px;" class="mobile-input-container">
                    <button class="btn btn-delete-mode" id="deleteToggleBtn" onclick="toggleDeleteMode()"
                        style="padding: 10px 20px;">
                        ğŸ—‘ï¸
                    </button>
                    <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„è¡ŒåŠ¨..."
                        style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <button class="btn btn-primary" id="sendBtn" onclick="sendUserInput()"
                        style="padding: 10px 30px;">å‘é€</button>
                </div>
                <div id="deleteControls" style="display: none; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">âœ… ç¡®è®¤åˆ é™¤é€‰ä¸­æ¶ˆæ¯</button>
                    <button class="btn btn-secondary" onclick="cancelDelete()" style="flex: 1;">âŒ å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§çŠ¶æ€é¢æ¿å®¹å™¨ï¼ˆç”±æ¸¸æˆé…ç½®æ–‡ä»¶åŠ¨æ€ç”Ÿæˆï¼‰ -->
        <div id="statusPanelContainer" class="panel status-panel">
            <!-- çŠ¶æ€é¢æ¿HTMLå°†ç”±é…ç½®æ–‡ä»¶ï¼ˆå¦‚ xiuxian-config.jsï¼‰åŠ¨æ€æ’å…¥ -->
            <!-- å¦‚æœé…ç½®æ–‡ä»¶æœªåŠ è½½ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå¤‡ç”¨å†…å®¹ -->
        </div>
    </div>

    <!-- Transformers.js - æµè§ˆå™¨ç«¯AIæ¨¡å‹åº“ï¼ˆå¯é€‰ï¼Œä»…åœ¨ä½¿ç”¨æµè§ˆå™¨æ¨¡å‹æ—¶éœ€è¦ï¼‰ -->
    <script type="module" id="transformersScript">
        // åŠ¨æ€åŠ è½½ï¼Œé¿å…å½±å“é¡µé¢åŠ è½½é€Ÿåº¦
        // è°ƒè¯•æ—¥å¿—å¼€å…³ï¼ˆé»˜è®¤å…³é—­ï¼‰ã€‚å¦‚éœ€æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼Œå¯åœ¨æ§åˆ¶å°æ‰§è¡Œï¼šwindow.DEBUG_TRANSFORMERS = true
        window.DEBUG_TRANSFORMERS = (typeof window.DEBUG_TRANSFORMERS !== 'undefined') ? window.DEBUG_TRANSFORMERS : false;
        // ğŸ†• æ·»åŠ å…¨å±€fetchæ‹¦æˆªå™¨ä»¥è¿½è¸ªæ¨¡å‹ä¸‹è½½è¿›åº¦
        window._setupProgressTracking = function() {
            if (window._progressTrackingSetup) return;
            window._progressTrackingSetup = true;
            
            const originalFetch = window.fetch;
            window.fetch = async function(...args) {
                const [url] = args;
                
                // åªæ‹¦æˆªæ¨¡å‹æ–‡ä»¶ä¸‹è½½ï¼ˆ.onnx, .jsonç­‰ï¼‰
                const isModelFile = typeof url === 'string' && 
                    (url.includes('onnx') || url.includes('Xenova') || url.includes('tokenizer'));
                
                if (!isModelFile || !window._modelLoadProgress) {
                    return originalFetch.apply(this, args);
                }
                
                console.log(`[æ¨¡å‹ä¸‹è½½] å¼€å§‹ä¸‹è½½: ${url.split('/').pop()}`);
                
                const response = await originalFetch.apply(this, args);
                
                if (!response.ok) {
                    console.error(`[æ¨¡å‹ä¸‹è½½] ä¸‹è½½å¤±è´¥: ${response.status} ${response.statusText}`);
                    return response;
                }
                
                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length') || 0;
                const fileName = url.split('/').pop();
                
                console.log(`[æ¨¡å‹ä¸‹è½½] ${fileName} - å¤§å°: ${(contentLength / 1024 / 1024).toFixed(2)} MB`);
                
                let receivedLength = 0;
                const chunks = [];
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    // æ›´æ–°å…¨å±€è¿›åº¦
                    if (window._modelLoadProgress) {
                        window._modelLoadProgress.files.set(fileName, {
                            loaded: receivedLength,
                            total: contentLength
                        });
                        
                        // è®¡ç®—æ€»è¿›åº¦
                        let totalLoaded = 0;
                        let totalSize = 0;
                        window._modelLoadProgress.files.forEach(file => {
                            totalLoaded += file.loaded;
                            totalSize += file.total;
                        });
                        
                        window._modelLoadProgress.loaded = totalLoaded;
                        window._modelLoadProgress.total = totalSize || 15000000; // é»˜è®¤15MB
                        
                        // æ›´æ–°UI
                        window._updateProgressUI && window._updateProgressUI();
                    }
                }
                
                console.log(`[æ¨¡å‹ä¸‹è½½] âœ… ${fileName} ä¸‹è½½å®Œæˆ`);
                
                // é‡æ–°ç»„è£…å“åº”
                const chunksAll = new Uint8Array(receivedLength);
                let position = 0;
                for (let chunk of chunks) {
                    chunksAll.set(chunk, position);
                    position += chunk.length;
                }
                
                return new Response(chunksAll, {
                    status: response.status,
                    statusText: response.statusText,
                    headers: response.headers
                });
            };
        };
        
        window.loadTransformersJS = async function() {
            if (window.transformersLoaded) return;
            
            // å¯åŠ¨è¿›åº¦è¿½è¸ª
            window._setupProgressTracking();
            
            console.log('[Transformers.js] å¼€å§‹åŠ è½½åº“æ–‡ä»¶...');
            
            try {
                const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0');
                
                // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ¸…é™¤é»˜è®¤çš„ /models/ è·¯å¾„å‰ç¼€
                env.localModelPath = './';  // è®¾ç½®ä¸ºå½“å‰ç›®å½•ï¼Œé¿å…è·¯å¾„é‡å¤
                env.allowRemoteModels = true;  // å…è®¸CDNå›é€€
                
                window.transformers = { pipeline, env };
                window.transformersLoaded = true;
                console.log('[Transformers.js] âœ… åº“åŠ è½½æˆåŠŸ');
                console.log('[Transformers.js] æœ¬åœ°æ¨¡å‹åŸºç¡€è·¯å¾„:', env.localModelPath);
            } catch (error) {
                console.error('[Transformers.js] âŒ åº“åŠ è½½å¤±è´¥:', error);
                throw error;
            }
        };

        function logItemOp(op) {
            if (!gameState.localOps) gameState.localOps = { items: [], attrs: [], equip: [] };
            gameState.localOps.items.push(Object.assign({}, op, { ts: Date.now() }));
        }

        function logAttrOp(op) {
            if (!gameState.localOps) gameState.localOps = { items: [], attrs: [], equip: [] };
            gameState.localOps.attrs.push(Object.assign({}, op, { ts: Date.now() }));
        }

        function logEquipOp(op) {
            if (!gameState.localOps) gameState.localOps = { items: [], attrs: [], equip: [] };
            gameState.localOps.equip.push(Object.assign({}, op, { ts: Date.now() }));
        }
    </script>

    <script src="supply.js"></script>
    <script src="matrix-manager.js"></script>
    <script src="game-framework.js"></script>
    <script src="xiuxian-config.js?v=20251118-2"></script>
    <script src="combat-skills.js"></script>
    <script src="combat-system-part1.js"></script>
    <script src="combat-system-complete.js"></script>
    <script src="js/game-core-systems.js"></script>
    <script src="js/api-calling-functions.js"></script>
    <script src="js/dynamic-world-functions.js"></script>
    <script src="js/variable-instruction-parser-v3.1.js"></script>

    
    <!-- âœ… æ¿€è¿›é‡æ„æ–°å¢æ¨¡å— - å¾…åˆ›å»ºå®Œæ•´ç‰ˆæœ¬ -->
    <script src="dlc-manager.js"></script>
    <script src="js/knowledge-manager-full.js"></script>
    <script src="js/dlc-ui-full.js"></script>
    <script src="js/message-editor.js"></script>
    <script src="js/message-floor-indicator.js"></script>
    <script src="js/shared/data-isolation.js"></script>
    <script src="js/shared/mobile-ui.js"></script>
    <script src="js/shared/ai-response-handler.js"></script>
    <script src="js/user-input-handler.js"></script>
    <script src="js/ai-message-builder.js"></script>
    <script src="js/viewer-components.js"></script>
    <script src="js/history-matrix-modal-functions.js"></script>
    <script src="js/json-repair-enhanced.js"></script>
    <script src="js/game-initialization.js"></script>
    
    <!-- äººç‰©å›¾è°±ç³»ç»Ÿ -->
    <script src="js/character-graph-manager.js"></script>
    <script>
        console.log('[è°ƒè¯•] character-graph-manager.js åŠ è½½å®Œæˆï¼Œwindow.characterGraphManager =', !!window.characterGraphManager);
    </script>
    <script src="js/character-graph-integration.js"></script>
    <script>
        console.log('[è°ƒè¯•] character-graph-integration.js åŠ è½½å®Œæˆï¼Œwindow.characterGraphIntegration =', !!window.characterGraphIntegration);
    </script>
    <script src="js/character-graph-ui.js"></script>
    <script src="js/character-graph-hooks.js"></script>
    <script>
        console.log('[è°ƒè¯•] character-graph-hooks.js åŠ è½½å®Œæˆï¼Œwindow.initializeCharacterGraphHooks =', !!window.initializeCharacterGraphHooks);
    </script>
    
    <script src="character-creation.js?v=20251118-2"></script>
    
    <script>
        // è§’è‰²åˆ›å»ºçŠ¶æ€ï¼ˆä»é…ç½®æ–‡ä»¶ä¸­è·å–ï¼‰
        // æ³¨æ„ï¼šè¿™ä¸ªå˜é‡ç°åœ¨ç”± xiuxian-config.js æä¾›ï¼Œå¦‚æœæœªåŠ è½½åˆ™ä½¿ç”¨å¤‡ç”¨æ•°æ®
        if (!window.characterCreation) {
            window.characterCreation = {
                difficulty: 'normal',
                maxPoints: 100,
                remainingPoints: 100,
                baseAttributes: {
                    physique: 10,      // æ ¹éª¨
                    fortune: 10,       // æ°”è¿
                    comprehension: 10, // æ‚Ÿæ€§
                    spirit: 10,        // ç¥è¯†
                    potential: 10,     // æ½œåŠ›
                    charisma: 10       // é­…åŠ›
                },
                selectedTalents: [],
                selectedGender: 'male',
                selectedOrigin: 'commoner',
                usedPoints: 0
            };
        }
        // åˆ›å»ºå±€éƒ¨å¼•ç”¨ï¼Œæ–¹ä¾¿ä»£ç ä½¿ç”¨ï¼ˆä¸ä½¿ç”¨consté¿å…é‡å¤å£°æ˜ï¼‰
        var characterCreation = window.characterCreation;

        // å‡ºèº«åˆ—è¡¨ï¼ˆä»é…ç½®æ–‡ä»¶ä¸­è·å–ï¼Œå¦‚æœé…ç½®æ–‡ä»¶æœªåŠ è½½åˆ™ä½¿ç”¨å¤‡ç”¨æ•°æ®ï¼‰
        if (!window.origins) {
            window.origins = [
            {
                id: 'commoner',
                name: 'å‡¡äºº',
                description: 'æ™®é€šçš„å‡¡äººï¼Œä¸€åˆ‡ä»é›¶å¼€å§‹',
                pointsModifier: 0,
                attributeEffects: {}
            },
            {
                id: 'slave',
                name: 'å¥´éš¶',
                description: 'å‘å¾®çš„å¥´éš¶å‡ºèº«ï¼Œé¥±å—æŠ˜ç£¨ä½†æ„å¿—åšéŸ§',
                pointsModifier: 20,
                attributeEffects: { physique: -5, spirit: 3, potential: -3, charisma: -5 }
            },
            {
                id: 'noble',
                name: 'å®˜å®¦ä¸–å®¶',
                description: 'å‡ºèº«åé—¨æœ›æ—ï¼Œä»å°é”¦è¡£ç‰é£Ÿ',
                pointsModifier: -30,
                attributeEffects: { fortune: 18, charisma: 8, physique: -3, spirit: 5 }
            },
            {
                id: 'martial',
                name: 'æ­¦æ—ä¾ å®¢',
                description: 'è¡Œèµ°æ±Ÿæ¹–çš„ä¾ å®¢ï¼Œèº«æ‰‹ä¸å‡¡',
                pointsModifier: -15,
                attributeEffects: { physique: 8, spirit: 10, charisma: 3 }
            },
            {
                id: 'outer_disciple',
                name: 'ä¿®ä»™å¤–é—¨å¼Ÿå­',
                description: 'ä¿®ä»™é—¨æ´¾çš„å¤–é—¨å¼Ÿå­ï¼Œå·²å…¥ä¿®ä»™ä¹‹é—¨',
                pointsModifier: -20,
                attributeEffects: { comprehension: 15, potential: 5, spirit: 3, fortune: 3 }
            },
            {
                id: 'inner_disciple',
                name: 'ä¿®ä»™å†…é—¨å¼Ÿå­',
                description: 'ä¿®ä»™é—¨æ´¾çš„å†…é—¨å¼Ÿå­ï¼Œå¤©èµ„ä¼˜å¼‚',
                pointsModifier: -40,
                attributeEffects: { comprehension: 18, potential: 8, spirit: 8, fortune: 5, physique: 5 }
            },
            {
                id: 'rogue_cultivator',
                name: 'æ•£ä¿®',
                description: 'ç‹¬è‡ªä¿®ç‚¼çš„æ•£ä¿®ï¼Œè‡ªç”±ä½†è‰°éš¾',
                pointsModifier: -10,
                attributeEffects: { comprehension: 15, fortune: -3, spirit: 5, potential: 3 }
            },
            {
                id: 'poor_family',
                name: 'å¯’é—¨å­å¼Ÿ',
                description: 'å‡ºèº«è´«å¯’å®¶åº­ï¼Œè‡ªå¹¼åƒè‹¦è€åŠ³',
                pointsModifier: 10,
                attributeEffects: { physique: 3, spirit: 5, fortune: -5, potential: 13 }
            },
            {
                id: 'cultivation_family',
                name: 'ä¿®çœŸä¸–å®¶',
                description: 'ä¿®çœŸä¸–å®¶åè£”ï¼Œå®¶å­¦æ¸Šæºæ·±åš',
                pointsModifier: -35,
                attributeEffects: { comprehension: 8, spirit: 18, fortune: 5, charisma: 5, potential: 5 }
            },
            {
                id: 'sect_prodigy',
                name: 'å®—é—¨æ–°ç§€',
                description: 'å®—é—¨é‡ç‚¹åŸ¹å…»çš„å¤©æ‰å¼Ÿå­',
                pointsModifier: -35,
                attributeEffects: { comprehension: 10, potential: 18, spirit: 5, fortune: 5 }
            },
            {
                id: 'royal_noble',
                name: 'ç‹æœè´µèƒ„',
                description: 'ç‹æœçš‡å®¤æˆå‘˜ï¼Œèº«ä»½å°Šè´µæ— æ¯”',
                pointsModifier: -45,
                attributeEffects: { charisma: 20, fortune: 10, spirit: 5, physique: -5, comprehension: 3 }
            },
            {
                id: 'spirit_farmer',
                name: 'çµç”°ä½ƒæˆ·',
                description: 'ä¸–ä»£è€•ç§çµç”°çš„ä½ƒå†œï¼Œç†Ÿæ‚‰çµæ¤',
                pointsModifier: 5,
                attributeEffects: { physique: 5, comprehension: 8, fortune: -3, charisma: -3 }
            },
            {
                id: 'demon_slave',
                name: 'é­”å°Šæ€§å¥´',
                description: 'æ›¾ä¸ºé­”å°Šå¥´å½¹ï¼Œèº«å¿ƒå—åˆ›ä½†æ„å¿—ä¸ç­',
                pointsModifier: 25,
                attributeEffects: { physique: -8, spirit: 8, charisma: -8, potential: 5, fortune: -5 }
            },
            {
                id: 'ghost_officer',
                name: 'é¬¼å·®é˜´å',
                description: 'é˜´å¸é¬¼å·®ï¼ŒæŒç®¡ç”Ÿæ­»ç°¿å½•',
                pointsModifier: -25,
                attributeEffects: { spirit: 20, comprehension: 5, physique: -5, charisma: -3, fortune: 3 }
            },
            {
                id: 'earth_student',
                name: 'åœ°çƒå­¦å­',
                description: 'ç°å®åœ°çƒçš„å­¦ç”Ÿï¼Œåœ°çƒå‘ç”Ÿäº†çµæ°”å¤è‹',
                pointsModifier: -20,
                attributeEffects: { comprehension: 10, spirit: 5, fortune: 5, charisma: -3 }
            },
            {
                id: 'demon_beast',
                name: 'å¦–æ—å°å¦–',
                description: 'å¦–æ—å‡ºèº«ï¼Œå…½æ€§æœªæ³¯ä½†æ½œåŠ›å·¨å¤§',
                pointsModifier: -15,
                attributeEffects: { physique: 15, potential: 8, spirit: 3, charisma: -5, comprehension: -3 }
            },
            {
                id: 'mine_slave',
                name: 'çµçŸ³çŸ¿å¥´',
                description: 'çµçŸ³çŸ¿ä¸­çš„è‹¦å·¥ï¼Œå¸¸å¹´åŠ³ä½œä½“é­„å¼ºå¥',
                pointsModifier: 15,
                attributeEffects: { physique: 18, spirit: 3, fortune: -8, charisma: -5, potential: -3 }
            },
            {
                id: 'sword_spirit',
                name: 'å¤å‰‘å‰‘çµ',
                description: 'ä¸Šå¤ç¥å‰‘çš„å™¨çµï¼Œå‰‘é“å¤©èµ‹å“ç»',
                pointsModifier: -30,
                attributeEffects: { spirit: 20, comprehension: 8, potential: 5, physique: -5 }
            },
            {
                id: 'alchemy_boy',
                name: 'ç‚¼ä¸¹ç«¥å­',
                description: 'ç‚¼ä¸¹å¸ˆåº§ä¸‹ç«¥å­ï¼Œç²¾é€šä¸¹é“',
                pointsModifier: -18,
                attributeEffects: { comprehension: 18, spirit: 5, fortune: 3, physique: -3 }
            },
            {
                id: 'border_soldier',
                name: 'è¾¹é•‡æˆå’',
                description: 'è¾¹å¢ƒå®ˆå†›ï¼Œä¹…ç»æˆ˜é˜µèº«ç»ç™¾æˆ˜',
                pointsModifier: -12,
                attributeEffects: { physique: 20, spirit: 5, charisma: 3, comprehension: -3 }
            },
            {
                id: 'ship_slave',
                name: 'çµèˆŸèˆ¹å¥´',
                description: 'çµèˆŸä¸Šçš„è‹¦åŠ›ï¼Œè§è¯†å¹¿åšä½†åœ°ä½ä½ä¸‹',
                pointsModifier: 8,
                attributeEffects: { physique: 15, spirit: 3, fortune: -5, charisma: -5, comprehension: 3 }
            },
            {
                id: 'cursed_clan',
                name: 'è¯…å’’ä¹‹æ—',
                description: 'èƒŒè´Ÿè¿œå¤è¯…å’’çš„ç§æ—ï¼Œå‘½è¿å¤šèˆ›',
                pointsModifier: 20,
                attributeEffects: { potential: 8, spirit: 8, fortune: -20, physique: -5, charisma: -5 }
            }
            ];
        }
        // åˆ›å»ºå±€éƒ¨å¼•ç”¨ï¼Œæ–¹ä¾¿ä»£ç ä½¿ç”¨ï¼ˆä¸ä½¿ç”¨consté¿å…é‡å¤å£°æ˜ï¼‰
        var origins = window.origins;

        // å¤©èµ‹åˆ—è¡¨
        const talents = [
            // æ­£é¢å¤©èµ‹ï¼ˆæ¶ˆè€—ç‚¹æ•°ï¼‰
            {
                id: 'genius',
                name: 'å¤©èµ‹å¼‚ç¦€',
                type: 'positive',
                cost: -15,
                description: 'å¤©ç”Ÿçµæ ¹è¶…å‡¡ï¼Œä¿®ç‚¼é€Ÿåº¦æå¿«',
                effects: { comprehension: 8, potential: 5 }
            },
            {
                id: 'strong_body',
                name: 'å…ˆå¤©é“ä½“',
                type: 'positive',
                cost: -10,
                description: 'å¤©ç”Ÿé“ä½“ï¼Œæ ¹éª¨ç»ä½³',
                effects: { physique: 10, spirit: 5 }
            },
            {
                id: 'lucky_star',
                name: 'æ°”è¿ä¹‹å­',
                type: 'positive',
                cost: -10,
                description: 'å¤©ç”Ÿå¥½è¿ï¼Œå®¹æ˜“è·å¾—æœºç¼˜',
                effects: { fortune: 15, charisma: 3 }
            },
            {
                id: 'swift_comprehension',
                name: 'è¿‡ç›®ä¸å¿˜',
                type: 'positive',
                cost: -8,
                description: 'æ‚Ÿæ€§æƒŠäººï¼Œé¢†æ‚ŸåŠ›è¶…ç¾¤',
                effects: { comprehension: 12 }
            },
            {
                id: 'charm_master',
                name: 'å€¾å›½å€¾åŸ',
                type: 'positive',
                cost: -10,
                description: 'å®¹è²Œå‡ºä¼—ï¼Œé­…åŠ›è¶…ç¾¤',
                effects: { charisma: 10, fortune: 3 }
            },
            {
                id: 'furnace_cauldron_body',
                name: 'ç‚‰é¼ä¹‹ä½“',
                type: 'positive',
                cost: -10,
                description: 'ç‚‰é¼ä½“è´¨ï¼Œå®¹æ˜“é­åˆ°å¼‚æ€§è§Šè§',
                effects: { charisma: 15, fortune: -3 }
            },
            {
                id: 'strong_spirit',
                name: 'ç¥è¯†è¿‡äºº',
                type: 'positive',
                cost: -12,
                description: 'ç¥è¯†å¼ºå¤§ï¼Œæ„ŸçŸ¥æ•é”',
                effects: { spirit: 12, comprehension: 3 }
            },
            {
                id: 'dao_affinity',
                name: 'å¤§é“äº²å’Œ',
                type: 'positive',
                cost: -20,
                description: 'ä¸å¤©åœ°å¤§é“äº²å’Œï¼Œä¿®ç‚¼äº‹åŠåŠŸå€',
                effects: { comprehension: 10, potential: 8, spirit: 5 }
            },
            {
                id: 'dao_heart_mirror',
                name: 'é“å¿ƒæ˜é•œ',
                type: 'positive',
                cost: -15,
                description: 'é“å¿ƒåšå®šå¦‚é•œï¼Œä¸æŸ“å°˜åŸƒ',
                effects: { spirit: 10, comprehension: 5, charisma: 3 }
            },
            {
                id: 'nine_tribulation_body',
                name: 'ä¹åŠ«è½®å›ä¸ç­ä½“',
                type: 'positive',
                cost: -50,
                description: 'ä¼ è¯´ä¸­çš„ä¸ç­ä½“è´¨ï¼Œå†ç»ä¹åŠ«è€Œä¸ç­',
                effects: { physique: 15, potential: 15, spirit: 10, fortune: 10 }
            },
            {
                id: 'chaos_primordial_body',
                name: 'æ··æ²Œé¸¿è’™é“èƒä½“',
                type: 'positive',
                cost: -50,
                description: 'æ··æ²Œåˆå¼€æ—¶è¯ç”Ÿçš„è‡³é«˜ä½“è´¨',
                effects: { comprehension: 15, potential: 15, spirit: 10, physique: 10 }
            },
            {
                id: 'myriad_law_void_body',
                name: 'ä¸‡æ³•çš†ç©ºæ— å¢ä½“',
                type: 'positive',
                cost: -45,
                description: 'ä¸‡æ³•ä¸ä¾µï¼Œçº¤å°˜ä¸æŸ“çš„åœ£æ´ä½“è´¨',
                effects: { spirit: 15, comprehension: 12, fortune: 8 }
            },
            {
                id: 'nine_nether_soul_body',
                name: 'ä¹å¹½ç„ç…å™¬é­‚ä½“',
                type: 'positive',
                cost: -40,
                description: 'ä¹å¹½ä¹‹åŠ›åŠ èº«ï¼Œå¯åå™¬é­‚é­„',
                effects: { spirit: 15, physique: 10, potential: 8 }
            },
            {
                id: 'star_resonance_body',
                name: 'å‘¨å¤©æ˜Ÿè¾°å…±é¸£ä½“',
                type: 'positive',
                cost: -45,
                description: 'ä¸å‘¨å¤©æ˜Ÿè¾°å…±é¸£ï¼Œå€Ÿæ˜Ÿè¾°ä¹‹åŠ›',
                effects: { spirit: 12, comprehension: 12, fortune: 10 }
            },
            {
                id: 'five_element_creation_body',
                name: 'äº”è¡Œé€ åŒ–ç”Ÿç”Ÿä½“',
                type: 'positive',
                cost: -40,
                description: 'æŒæ¡äº”è¡Œé€ åŒ–ä¹‹åŠ›ï¼Œç”Ÿç”Ÿä¸æ¯',
                effects: { comprehension: 12, potential: 12, physique: 8 }
            },
            {
                id: 'qiankun_unity_body',
                name: 'ä¹¾å¤ä¸€ç‚å½’å…ƒä½“',
                type: 'positive',
                cost: -45,
                description: 'ä¹¾å¤ä¹‹åŠ›å½’äºä¸€ä½“ï¼Œä¸‡æ³•å½’å…ƒ',
                effects: { spirit: 15, comprehension: 10, potential: 10 }
            },
            {
                id: 'great_sun_glazed_body',
                name: 'å¤§æ—¥ç‰ç’ƒé‡‘èº«ä½“',
                type: 'positive',
                cost: -40,
                description: 'å¦‚å¤§æ—¥èˆ¬ç’€ç’¨çš„é‡‘èº«ä½“è´¨',
                effects: { physique: 15, spirit: 10, charisma: 8 }
            },
            {
                id: 'heavenly_demon_body',
                name: 'ä»–åŒ–è‡ªåœ¨å¤©é­”ä½“',
                type: 'positive',
                cost: -40,
                description: 'å¤©é­”ä¹‹ä½“ï¼Œå¯åŒ–ä¸‡ç‰©ä¸ºå·±ç”¨',
                effects: { charisma: 15, spirit: 10, potential: 8 }
            },
            {
                id: 'primordial_qi_body',
                name: 'å¤ªåˆä¸€æ°”ç„èƒ',
                type: 'positive',
                cost: -45,
                description: 'å¤ªåˆä¹‹æ°”å­•è‚²çš„ç„å¦™ä½“è´¨',
                effects: { potential: 15, comprehension: 12, spirit: 10 }
            },
            {
                id: 'nine_aperture_sword_heart',
                name: 'ä¹çªé€šæ˜å‰‘å¿ƒ',
                type: 'positive',
                cost: -35,
                description: 'å‰‘é“å¤©èµ‹å“ç»ï¼Œä¹çªé€šæ˜',
                effects: { comprehension: 12, spirit: 10, potential: 8 }
            },
            {
                id: 'xuanhuang_virtue_body',
                name: 'ç„é»„åšå¾·åœ£ä½“',
                type: 'positive',
                cost: -40,
                description: 'ç„é»„åŠŸå¾·åŠ èº«çš„åœ£æ´ä½“è´¨',
                effects: { fortune: 15, charisma: 10, spirit: 8 }
            },
            {
                id: 'mortal_tribulation_bone',
                name: 'çº¢å°˜ç™¾åŠ«ä»™éª¨',
                type: 'positive',
                cost: -35,
                description: 'å†ç»çº¢å°˜ç™¾åŠ«è€Œæˆçš„ä»™éª¨',
                effects: { physique: 12, potential: 10, fortune: 5 }
            },
            {
                id: 'five_element_reverse_body',
                name: 'äº”è¡Œé¢ å€’æ³•èº¯',
                type: 'positive',
                cost: -30,
                description: 'å¯é¢ å€’äº”è¡Œä¹‹åŠ›çš„ç‰¹æ®Šä½“è´¨',
                effects: { comprehension: 10, potential: 10, spirit: 5 }
            },
            {
                id: 'void_talisman_medium',
                name: 'è™šç©ºç”»ç¬¦çµåª’',
                type: 'positive',
                cost: -30,
                description: 'å¯åœ¨è™šç©ºä¸­ç”»ç¬¦çš„å¤©èµ‹',
                effects: { spirit: 12, comprehension: 8, potential: 5 }
            },
            {
                id: 'myriad_poison_mother_body',
                name: 'ä¸‡æ¯’è›Šæ¯æºèƒ',
                type: 'positive',
                cost: -35,
                description: 'ä¸‡æ¯’ä¹‹æ¯ï¼Œç™¾æ¯’ä¸ä¾µ',
                effects: { physique: 12, spirit: 10, potential: 8 }
            },
            {
                id: 'devouring_demon_body',
                name: 'åå¤©é­”çªä¹‹èº¯',
                type: 'positive',
                cost: -40,
                description: 'å¯åå™¬å¤©åœ°ä¸‡ç‰©çš„é­”çªä½“è´¨',
                effects: { potential: 15, physique: 10, spirit: 8 }
            },
            {
                id: 'azure_emperor_longevity_body',
                name: 'é’å¸é•¿ç”Ÿå®ä½“',
                type: 'positive',
                cost: -45,
                description: 'é’å¸ä¼ æ‰¿çš„é•¿ç”Ÿä½“è´¨',
                effects: { physique: 12, potential: 12, fortune: 10, charisma: 8 }
            },
            {
                id: 'hunyuan_wuji_body',
                name: 'æ··å…ƒæ— æé“èƒ',
                type: 'positive',
                cost: -50,
                description: 'æ··å…ƒæ— æï¼Œé“æ³•è‡ªç„¶çš„è‡³é«˜ä½“è´¨',
                effects: { comprehension: 15, spirit: 15, potential: 12 }
            },
            {
                id: 'mirage_sea_foundation',
                name: 'å¹»æµ·èœƒæ¥¼ä»™åŸº',
                type: 'positive',
                cost: -35,
                description: 'å¦‚å¹»æµ·èœƒæ¥¼èˆ¬è™šå®éš¾è¾¨çš„ä»™åŸº',
                effects: { spirit: 12, charisma: 10, fortune: 8 }
            },
            // è´Ÿé¢å¤©èµ‹ï¼ˆå¢åŠ ç‚¹æ•°ï¼‰
            {
                id: 'weak_body',
                name: 'ä½“å¼±å¤šç—…',
                type: 'negative',
                cost: 15,
                description: 'èº«ä½“è™šå¼±ï¼Œæ ¹éª¨æ¬ ä½³',
                effects: { physique: -8, spirit: -4 }
            },
            {
                id: 'bad_luck',
                name: 'éœ‰è¿ç¼ èº«',
                type: 'negative',
                cost: 15,
                description: 'è¿æ°”ä¸ä½³ï¼Œå®¹æ˜“é‡åˆ°éº»çƒ¦',
                effects: { fortune: -10 }
            },
            {
                id: 'slow_mind',
                name: 'æ„šé’è¿Ÿç¼“',
                type: 'negative',
                cost: 10,
                description: 'èµ„è´¨å¹³åº¸ï¼Œæ‚Ÿæ€§è¾ƒå·®',
                effects: { comprehension: -8 }
            },
            {
                id: 'weak_spirit',
                name: 'ç¥è¯†è–„å¼±',
                type: 'negative',
                cost: 10,
                description: 'ç¥è¯†è™šå¼±ï¼Œæ„ŸçŸ¥è¿Ÿé’',
                effects: { spirit: -8 }
            },
            {
                id: 'ugly',
                name: 'å…¶è²Œä¸æ‰¬',
                type: 'negative',
                cost: 10,
                description: 'ç›¸è²Œå¹³å¹³ï¼Œéš¾ä»¥å¸å¼•ä»–äºº',
                effects: { charisma: -8 }
            },
            {
                id: 'karma_debt',
                name: 'å› æœä¸šéšœ',
                type: 'negative',
                cost: 18,
                description: 'å‰ä¸–é€ å­½ï¼Œèµ·å§‹å¤©è°´å€¼è¾ƒé«˜',
                effects: { karmaPunishment: 30 }
            },
            {
                id: 'soul_fragment',
                name: 'é­‚å¿†ç¢ç‰‡',
                type: 'negative',
                cost: 20,
                description: 'çµé­‚æ®‹ç¼ºï¼Œè®°å¿†ç ´ç¢ä¸å…¨',
                effects: { spirit: -10, comprehension: -5, potential: -5 }
            },
            {
                id: 'karma_fire',
                name: 'ä¸šç«ç¼ èº«',
                type: 'negative',
                cost: 25,
                description: 'ä¸šç«ç„šèº«ï¼Œç—›è‹¦ä¸å ª',
                effects: { physique: -8, spirit: -8, fortune: -8, karmaPunishment: 50 }
            },
            {
                id: 'trace_separation_body',
                name: 'æº¯ç›¸ç¦»æçœŸèº¯',
                type: 'negative',
                cost: 30,
                description: 'çœŸèº¯ç¦»æï¼Œéš¾ä»¥å‡èš',
                effects: { physique: -12, potential: -10, spirit: -8 }
            },
            {
                id: 'dark_sorrow_fate',
                name: 'é—‡è´¨åŒæ‚²å‘½æ ¼',
                type: 'negative',
                cost: 25,
                description: 'å‘½æ ¼æ‚²è‹¦ï¼Œä¸é»‘æš—å…±ç”Ÿ',
                effects: { fortune: -15, charisma: -8, spirit: -5 }
            },
            {
                id: 'scar_locked_body',
                name: 'å‰ç—•æ°¸é”¢é“èº«',
                type: 'negative',
                cost: 28,
                description: 'é“èº«è¢«æ°¸æ’ä¼¤ç—•é”å›°',
                effects: { potential: -15, physique: -10, comprehension: -5 }
            },
            {
                id: 'void_burden_womb',
                name: 'è™šå•®æ‰¿è´Ÿçµèƒ',
                type: 'negative',
                cost: 22,
                description: 'çµèƒè¢«è™šæ— ä¾µèš€ï¼Œæ‰¿è´Ÿé‡æ‹…',
                effects: { spirit: -10, potential: -8, fortune: -5 }
            },
            {
                id: 'lost_path_origin',
                name: 'æƒ˜å¾„ç‹¬è¡Œæœ¬æº',
                type: 'negative',
                cost: 20,
                description: 'æœ¬æºè¿·å¤±ï¼Œå­¤ç‹¬å‰è¡Œ',
                effects: { comprehension: -10, charisma: -8, fortune: -5 }
            },
            {
                id: 'ember_remnant_body',
                name: 'çƒ¬æœ«ä½™å“æ®‹èº¯',
                type: 'negative',
                cost: 25,
                description: 'å¦‚ç°çƒ¬èˆ¬æ®‹ç ´çš„èº¯ä½“',
                effects: { physique: -15, potential: -8, spirit: -5 }
            },
            {
                id: 'silent_cycle_womb',
                name: 'ç¼„é»˜å›ç¯åœ£èƒ',
                type: 'negative',
                cost: 18,
                description: 'åœ£èƒé™·å…¥æ²‰é»˜çš„è½®å›',
                effects: { charisma: -10, spirit: -8, comprehension: -5 }
            },
            {
                id: 'eclipse_void_womb',
                name: 'èš€å…‰æ˜ è™šç„èƒ',
                type: 'negative',
                cost: 22,
                description: 'ç„èƒè¢«è™šæ— ä¹‹å…‰ä¾µèš€',
                effects: { spirit: -12, fortune: -8, potential: -5 }
            },
            {
                id: 'yin_yang_chaos_demon_body',
                name: 'é˜´é˜³é€†ä¹±é­”èƒ',
                type: 'negative',
                cost: 25,
                description: 'é˜´é˜³é€†ä¹±çš„é­”æ€§ä½“è´¨',
                effects: { physique: -10, spirit: -10, fortune: -8 }
            },
            {
                id: 'xuanming_weak_water_body',
                name: 'ç„å†¥å¼±æ°´æ³•èƒ',
                type: 'negative',
                cost: 20,
                description: 'ç„å†¥å¼±æ°´ä¾µèš€çš„æ³•èƒ',
                effects: { physique: -12, potential: -8, comprehension: -5 }
            }
        ];

        // æ¸¸æˆçŠ¶æ€ - è®¾ç½®ä¸ºå…¨å±€å˜é‡ä¾›äººç‰©å›¾è°±ä½¿ç”¨
        window.gameState = {
            variables: {
                currentDateTime: "",  // å½“å‰æ—¥æœŸæ—¶é—´
                name: "",
                age: 0,  // å¹´é¾„
                gender: "",
                realm: "",
                identity: "",  // èº«ä»½
                spiritStones: 0,  // çµçŸ³ï¼ˆç‹¬ç«‹å˜é‡ï¼‰
                karmaFortune: 0,  // æœºç¼˜å€¼
                karmaPunishment: 0,  // å¤©è°´å€¼
                cultivationProgress: 0,  // ä¿®ç‚¼è¿›åº¦ï¼ˆå½“å‰å€¼ï¼‰
                cultivationProgressMax: 100,  // ä¿®ç‚¼è¿›åº¦ï¼ˆæœ€å¤§å€¼ï¼‰
                hp: 100,  // ä½“åŠ›å½“å‰å€¼
                hpMax: 100,  // ä½“åŠ›æœ€å¤§å€¼
                mp: 100,  // æ³•åŠ›å½“å‰å€¼
                mpMax: 100,  // æ³•åŠ›æœ€å¤§å€¼
                talents: [],  // å¤©èµ‹åˆ—è¡¨
                // ğŸ†• ç‚¼ä¸¹ç‚¼å™¨ç­‰çº§
                alchemyLevel: "æœªå…¥é—¨",  // ç‚¼ä¸¹ç­‰çº§ "æœªå…¥é—¨" æˆ– "1å“åˆæœŸ"åˆ°"9å“åœ†æ»¡"
                craftingLevel: "æœªå…¥é—¨",  // ç‚¼å™¨ç­‰çº§ "æœªå…¥é—¨" æˆ– "1å“åˆæœŸ"åˆ°"9å“åœ†æ»¡"
                // ğŸ†• åŠ¿åŠ›ä¿¡æ¯
                faction: null,  // åŠ¿åŠ›ä¿¡æ¯ {name: "åŠ¿åŠ›å", leader: "é¢†è¢–", location: "æ‰€åœ¨åœ°", members: ["æˆå‘˜1", "æˆå‘˜2"], description: "ä»‹ç»"}
                attributes: {
                    physique: 0,      // æ ¹éª¨
                    fortune: 0,       // æ°”è¿
                    comprehension: 0, // æ‚Ÿæ€§
                    spirit: 0,        // ç¥è¯†
                    potential: 0,     // æ½œåŠ›
                    charisma: 0       // é­…åŠ›
                },
                equipment: {
                    head: null,
                    clothes: null,
                    feet: null,
                    treasure1: null,
                    treasure2: null,
                    treasure3: null
                },
                items: [],
                techniques: [],  // åŠŸæ³•åˆ—è¡¨ [{name: "å¤ªä¸Šæ´ç„çµå®ç»", type: "åŠŸæ³•", power: 100, mpCost: 50, description: "ä¸Šå¤ç„é—¨æ­£å®—å¿ƒæ³•"}]
                spells: [],  // æ³•æœ¯åˆ—è¡¨ [{name: "ä¹å¤©ç„ç«ç…ç¥å’’", type: "æ³•æœ¯", power: 80, mpCost: 30, description: "å¬å”¤å¤©ç«ç„šæ•Œ"}]
                relationships: [],
                location: "",
                history: []
            },
            previousVariables: null, // ç”¨äºè®¡ç®—å˜åŒ–
            conversationHistory: [], // åªå­˜å‚¨å‰§æƒ…ï¼Œä¸å«å˜é‡å’Œé€‰é¡¹
            variableSnapshots: [], // æ¯æ¡æ¶ˆæ¯å¯¹åº”çš„å˜é‡å¿«ç…§
            isGameStarted: false,
            isProcessing: false,
            localOps: { items: [], attrs: [], equip: [] },
            deleteMode: false, // åˆ é™¤æ¨¡å¼æ ‡å¿—
            // åŠ¨æ€ä¸–ç•Œç›¸å…³
            dynamicWorld: {
                enabled: false,
                history: [], // åŠ¨æ€ä¸–ç•Œç”Ÿæˆçš„å†å²è®°å½•
                floor: 0, // å½“å‰æ¥¼å±‚
                isProcessing: false,
                messageInterval: 1, // ç”Ÿæˆé—´éš”ï¼ˆæ¯Næ¬¡ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆä¸€æ¬¡ï¼‰
                messageCounter: 0 // ç”¨æˆ·æ¶ˆæ¯è®¡æ•°å™¨
            },
            // æ“ä½œç¼“å­˜ï¼šè®°å½•ç”¨æˆ·çš„UIæ“ä½œï¼Œåœ¨ä¸‹æ¬¡ä¸AIäº¤äº’æ—¶è‡ªåŠ¨é™„åŠ 
            pendingActions: {
                pills: {},      // è®°å½•æœç”¨çš„ä¸¹è¯ {ä¸¹è¯å: æ•°é‡}
                equipment: null // è®°å½•æœ€åè£…å¤‡çš„è£…å¤‡å
            }
        };

        // APIé…ç½®
        const apiConfig = {
            type: 'openai',
            endpoint: '',
            key: '',
            model: 'gpt-4o-mini',
            availableModels: []
        };

        // é¢å¤–APIé…ç½®
        const extraApiConfig = {
            enabled: false,
            type: 'openai',
            endpoint: '',
            key: '',
            model: 'gpt-4o-mini',
            availableModels: []
        };

        // ==================== æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿ ====================
        // å·²è¿ç§»åˆ° game-core-systems.js
        // åŒ…æ‹¬ï¼šinitDB, saveGameHistory, saveGameToSlot, loadGameHistory, 
        // loadGameFromSlot, getAllSaves, deleteSave, clearGameHistory,
        // exportSaveToFile, exportCurrentGame, importSaveFromFile,
        // loadSaveData, syncVectorLibraryFromHistory

        // ä»¥ä¸‹å‡½æ•°å·²è¿ç§»åˆ° game-core-systems.js:
        // - saveCurrentGame
        // - showLoadSaveMenu  
        // - loadSelectedSave
        // - deleteSelectedSave
        // - closeLoadSaveMenu

        // æ˜¾ç¤ºä¸»èœå•
        function showMainMenu() {
            const historyDiv = document.getElementById('gameHistory');
            historyDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px;">
                    <h1 style="color: #667eea; font-size: 48px; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
                         è§…é•¿ç”Ÿ1.7
                    </h1>
                    <p style="color: #666; font-size: 18px; margin-bottom: 50px;">è¸ä¸Šä¿®ä»™ä¹‹è·¯ï¼Œé€†å¤©æ”¹å‘½</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 20px; max-width: 400px;">
                        <button onclick="startNewGame()" 
                                style="padding: 20px 40px; font-size: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                            ğŸŒŸ å¼€å§‹æ–°æ¸¸æˆ
                        </button>
                        
                        <button onclick="showLoadSaveMenu()" 
                                style="padding: 20px 40px; font-size: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(240, 147, 251, 0.6)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(240, 147, 251, 0.4)'">
                            ğŸ“‚ åŠ è½½å­˜æ¡£
                        </button>
                        
                        <button onclick="importSaveFromFile()" 
                                style="padding: 20px 40px; font-size: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(79, 172, 254, 0.6)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(79, 172, 254, 0.4)'">
                            ğŸ“¥ å¯¼å…¥å­˜æ¡£
                        </button>
                    </div>
                    
                    <p style="color: #999; font-size: 14px; margin-top: 50px;">æç¤ºï¼šè¯·å…ˆåœ¨è®¾ç½®é…ç½®APIè¿æ¥</p>
                </div>
            `;
        }

        // å¼€å§‹æ–°æ¸¸æˆ
        async function startNewGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.variables = {
                name: "",
                gender: "",
                realm: "",
                identity: "",
                karmaFortune: 0,
                karmaPunishment: 0,
                cultivationProgress: 0,
                cultivationProgressMax: 100,
                hp: 100,
                hpMax: 100,
                mp: 100,
                mpMax: 100,
                talents: [],
                attributes: {
                    physique: 0,
                    fortune: 0,
                    comprehension: 0,
                    spirit: 0,
                    potential: 0,
                    charisma: 0
                },
                equipment: {
                    head: null,
                    clothes: null,
                    feet: null,
                    treasure1: null,
                    treasure2: null,
                    treasure3: null
                },
                items: [],
                techniques: [],
                spells: [],
                relationships: [],
                location: "",
                history: []
            };
            gameState.previousVariables = null;
            gameState.conversationHistory = [];
            gameState.variableSnapshots = [];
            gameState.isGameStarted = false;
            gameState.characterInfo = null;

            // æ¸…ç©ºå‘é‡åº“ï¼ˆæ–°æ¸¸æˆä¸åº”ä¿ç•™æ—§å­˜æ¡£çš„è®°å¿†ï¼‰
            if (window.contextVectorManager) {
                window.contextVectorManager.clear();
                // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿IndexedDBæ¸…ç©ºå®Œæˆ
                try {
                    await window.contextVectorManager.saveToIndexedDB();
                    console.log('[æ–°æ¸¸æˆ] âœ… å·²æ¸…ç©ºå‘é‡åº“ï¼ˆå«IndexedDBï¼‰');
                } catch (err) {
                    console.error('[æ–°æ¸¸æˆ] âŒ æ¸…ç©ºå‘é‡åº“å¤±è´¥:', err);
                }
            }
            
            // ğŸ†• æ¸…ç©ºçŸ©é˜µï¼ˆæ–°æ¸¸æˆä¸åº”ä¿ç•™æ—§å­˜æ¡£çš„çŸ©é˜µæ•°æ®ï¼‰
            if (window.matrixManager) {
                window.matrixManager.clear();
                console.log('[æ–°æ¸¸æˆ] âœ… å·²æ¸…ç©ºçŸ©é˜µæ•°æ®');
            }
            
            // ğŸ†• æ¸…ç©ºäººç‰©å›¾è°±ï¼ˆæ–°æ¸¸æˆä¸åº”ä¿ç•™æ—§å­˜æ¡£çš„äººç‰©ï¼‰
            if (window.characterGraphManager) {
                window.characterGraphManager.characters.clear();
                window.characterGraphManager.vectors.clear();
                window.characterGraphManager.stats = {
                    totalCharacters: 0,
                    lastUpdate: null,
                    matchCount: 0,
                    avgMatchScore: 0
                };
                // æ¸…ç©ºIndexedDBä¸­çš„äººç‰©å›¾è°±æ•°æ®
                (async () => {
                    try {
                        const db = window.characterGraphManager.indexedDB;
                        if (db) {
                            const transaction = db.transaction(['characters'], 'readwrite');
                            const store = transaction.objectStore('characters');
                            await store.clear();
                            console.log('[æ–°æ¸¸æˆ] å·²æ¸…ç©ºäººç‰©å›¾è°±IndexedDB');
                        }
                    } catch (error) {
                        console.error('[æ–°æ¸¸æˆ] æ¸…ç©ºäººç‰©å›¾è°±å¤±è´¥:', error);
                    }
                })();
                console.log('[æ–°æ¸¸æˆ] å·²æ¸…ç©ºäººç‰©å›¾è°±');
            }

            // é‡ç½®åŠ¨æ€ä¸–ç•Œæ•°æ®
            gameState.dynamicWorld = {
                enabled: gameState.dynamicWorld?.enabled || false, // ä¿ç•™å¯ç”¨çŠ¶æ€è®¾ç½®
                history: [],
                floor: 0,
                isProcessing: false,
                messageInterval: gameState.dynamicWorld?.messageInterval || 1, // ä¿ç•™é—´éš”è®¾ç½®
                messageCounter: 0 // é‡ç½®è®¡æ•°å™¨
            };
            console.log('[æ–°æ¸¸æˆ] å·²é‡ç½®åŠ¨æ€ä¸–ç•Œæ•°æ®');
            
            // æ›´æ–°åŠ¨æ€ä¸–ç•ŒTabæ˜¾ç¤º
            displayDynamicWorldHistory();

            // é‡ç½®è§’è‰²åˆ›å»ºçŠ¶æ€
            characterCreation.difficulty = 'normal';
            characterCreation.maxPoints = 100;
            characterCreation.remainingPoints = 100;
            characterCreation.baseAttributes = {
                physique: 10,
                fortune: 10,
                comprehension: 10,
                spirit: 10,
                potential: 10,
                charisma: 10
            };
            characterCreation.selectedTalents = [];
            
            // ğŸ†• æç¤ºç”¨æˆ·æ•°æ®å·²æ¸…ç©º
            console.log('[æ–°æ¸¸æˆ] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('[æ–°æ¸¸æˆ] âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼ŒåŒ…æ‹¬ï¼š');
            console.log('[æ–°æ¸¸æˆ]   - æ¸¸æˆå˜é‡');
            console.log('[æ–°æ¸¸æˆ]   - å¯¹è¯å†å²');
            console.log('[æ–°æ¸¸æˆ]   - å‘é‡åº“ï¼ˆåŒ…æ‹¬IndexedDBï¼‰');
            console.log('[æ–°æ¸¸æˆ]   - çŸ©é˜µæ•°æ®');
            console.log('[æ–°æ¸¸æˆ]   - äººç‰©å›¾è°±');
            console.log('[æ–°æ¸¸æˆ] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            characterCreation.selectedGender = 'male';
            characterCreation.selectedOrigin = 'commoner';
            characterCreation.usedPoints = 0;

            // æ˜¾ç¤ºè§’è‰²åˆ›å»ºç•Œé¢
            displayCharacterCreationInHistory();
        }

        // ========== è§’è‰²åˆ›å»ºç³»ç»Ÿå‡½æ•° ==========
        // âœ… å·²å®Œæ•´è¿ç§»åˆ° character-creation.js
        // åŒ…æ‹¬æ‰€æœ‰è§’è‰²åˆ›å»ºç›¸å…³å‡½æ•°ï¼š
        // - initializeOrigins, selectOrigin
        // - initializeTalents, toggleTalent
        // - selectDifficulty, selectGender
        // - adjustAttribute, updateAttributesDisplay, updatePointsDisplay
        // - confirmCharacterCreation, displayCharacterCreationInHistory
        // - getAttributeName

        // ========== æ¸¸æˆä¸»é€»è¾‘ ==========
        // å·²è¿ç§»åˆ° game-initialization.js

        // æ„å»ºå‘é€ç»™AIçš„æ¶ˆæ¯
        async function buildAIMessages(userMessage, originalUserInput = null) {
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¿®ä»™æ¸¸æˆè§„åˆ™åœ¨æœ€é¡¶éƒ¨ï¼Œç›´æ¥ä½¿ç”¨ defaultSystemPrompt ä½œä¸ºç³»ç»Ÿæç¤ºè¯
            let systemPrompt;
            
            // ä¼˜å…ˆä½¿ç”¨ defaultSystemPromptï¼ˆä¿®ä»™æ¸¸æˆæ ¸å¿ƒè§„åˆ™ï¼‰
            if (typeof defaultSystemPrompt !== 'undefined') {
                systemPrompt = defaultSystemPrompt;
                console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ§¾ ä½¿ç”¨ defaultSystemPromptï¼ˆä¿®ä»™æ ¸å¿ƒè§„åˆ™ï¼‰ä½œä¸ºæœ€é¡¶éƒ¨ç³»ç»Ÿæç¤ºè¯');
            } else if (typeof getSystemPrompt === 'function') {
                systemPrompt = getSystemPrompt();
                console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ® ä½¿ç”¨ getSystemPrompt() ä½œä¸ºç³»ç»Ÿæç¤ºè¯');
            } else {
                systemPrompt = document.getElementById('systemPrompt').value || 'ä½ æ˜¯ä¸€ä¸ªä¿®ä»™ä¸–ç•Œçš„æ¸¸æˆä¸»æŒäººã€‚';
                console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ“ ä½¿ç”¨ textarea å†…å®¹ä½œä¸ºç³»ç»Ÿæç¤ºè¯');
            }
            
            console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ“ æœ€ç»ˆç³»ç»Ÿæç¤ºè¯é•¿åº¦:', systemPrompt.length);
            console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ“‹ å‰100å­—ç¬¦:', systemPrompt.substring(0, 100));
            const historyDepthInput = document.getElementById('historyDepth');
            const historyDepth = historyDepthInput ? parseInt(historyDepthInput.value) : 10;
            const minWordCountInput = document.getElementById('minWordCount');
            const minWordCount = minWordCountInput ? parseInt(minWordCountInput.value) : 0;
            
            // è·å–å™äº‹è§†è§’è®¾ç½®
            const narrativePerspectiveInput = document.getElementById('narrativePerspective');
            const narrativePerspective = narrativePerspectiveInput ? narrativePerspectiveInput.value : 'first';
            
            console.log('[å™äº‹è§†è§’] å½“å‰è®¾ç½®çš„è§†è§’:', narrativePerspective);
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨å‘é‡æ£€ç´¢
            const enableVectorRetrieval = document.getElementById('enableVectorRetrieval')?.checked || false;
            
            let messages = [];

            // æ·»åŠ ç³»ç»Ÿæç¤º
            let finalSystemPrompt = systemPrompt;
            
            // å™äº‹è§†è§’åœ¨éå‘é‡æ£€ç´¢æ¨¡å¼ä¸‹ä½œä¸ºç‹¬ç«‹æ¶ˆæ¯ï¼ˆæœ€ä¼˜å…ˆçº§ï¼‰
            if (!enableVectorRetrieval) {
                const perspectivePrompts = {
                    'first': 'ã€æå…¶é‡è¦ã€‘å™äº‹è§†è§’å¼ºåˆ¶è¦æ±‚ï¼šæ•…äº‹æå†™éœ€è¦ä»¥ä¸»è§’ç¬¬ä¸€äººç§°è§†è§’ä¸ºä¸»ï¼Œå…è®¸è‡ªç„¶å™è¿°ä¸å¯¹è¯',
            'second': 'ã€æå…¶é‡è¦ã€‘å™äº‹è§†è§’å¼ºåˆ¶è¦æ±‚ï¼šæ•…äº‹æå†™éœ€è¦ä»¥ä¸»è§’ç¬¬äºŒäººç§°è§†è§’ä¸ºä¸»ï¼Œå…è®¸è‡ªç„¶å™è¿°ä¸å¯¹è¯',
            'third': 'ã€æå…¶é‡è¦ã€‘å™äº‹è§†è§’å¼ºåˆ¶è¦æ±‚ï¼šæ•…äº‹æå†™éœ€è¦ä»¥ä¸»è§’ç¬¬ä¸‰äººç§°è§†è§’ä¸ºä¸»ï¼Œå…è®¸è‡ªç„¶å™è¿°ä¸å¯¹è¯'
                };
                
                // å™äº‹è§†è§’ä½œä¸ºç¬¬ä¸€ä¸ªç³»ç»Ÿæ¶ˆæ¯
                messages.unshift({
                    role: 'system',
                    content: perspectivePrompts[narrativePerspective]
                });
                
                console.log('[å™äº‹è§†è§’] æ·»åŠ çš„æç¤ºè¯:', perspectivePrompts[narrativePerspective]);
            }
            
            // è®¾ç½®å…¨å±€å™äº‹è§†è§’å˜é‡ï¼Œä¾›å‘é‡æ£€ç´¢æ¨¡å¼ä½¿ç”¨
            window.currentNarrativePerspective = narrativePerspective;
            
            if (minWordCount > 0) {
                finalSystemPrompt += `\n\nã€é‡è¦ã€‘å­—æ•°è¦æ±‚ï¼šä½ çš„å›å¤ä¸­"story"å­—æ®µå¿…é¡»è‡³å°‘åŒ…å«${minWordCount}ä¸ªä¸­æ–‡å­—ç¬¦ã€‚è¯·ç¡®ä¿å‰§æƒ…æå†™è¯¦ç»†ã€ç”ŸåŠ¨ã€å……å®ï¼Œè¾¾åˆ°å­—æ•°è¦æ±‚ã€‚`;
            }
            
            // å†æ¬¡å¼ºåŒ–å™äº‹è§†è§’è¦æ±‚ï¼ˆåœ¨ç³»ç»Ÿæç¤ºè¯æœ«å°¾ï¼‰
            const reinforcementText = {
                'first': '\n\nã€æœ€ç»ˆæé†’ã€‘ä¸¥æ ¼éµå®ˆå™äº‹è§†è§’ï¼šå¿…é¡»ä½¿ç”¨ç¬¬ä¸€äººç§°"æˆ‘"ï¼Œç»å¯¹ç¦æ­¢ä½¿ç”¨"ä½ "æˆ–"ä»–/å¥¹"æè¿°ä¸»è§’ï¼å¥½çš„ï¼Œæˆ‘å·²å®Œæ•´è¾“å‡ºï¼Œè°¢è°¢æ‚¨çš„ä½¿ç”¨ï¼',
                'second': '\n\nã€æœ€ç»ˆæé†’ã€‘ä¸¥æ ¼éµå®ˆå™äº‹è§†è§’ï¼šå¿…é¡»ä½¿ç”¨ç¬¬äºŒäººç§°"ä½ "ï¼Œç»å¯¹ç¦æ­¢ä½¿ç”¨"æˆ‘"æˆ–"ä»–/å¥¹"æè¿°ä¸»è§’ï¼å¥½çš„ï¼Œæˆ‘å·²å®Œæ•´è¾“å‡ºï¼Œè°¢è°¢æ‚¨çš„ä½¿ç”¨ï¼',
                'third': '\n\nã€æœ€ç»ˆæé†’ã€‘ä¸¥æ ¼éµå®ˆå™äº‹è§†è§’ï¼šå¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°"ä»–/å¥¹"ï¼Œç»å¯¹ç¦æ­¢ä½¿ç”¨"æˆ‘"æˆ–"ä½ "æè¿°ä¸»è§’ï¼å¥½çš„ï¼Œæˆ‘å·²å®Œæ•´è¾“å‡ºï¼Œè°¢è°¢æ‚¨çš„ä½¿ç”¨ï¼'
            };
            finalSystemPrompt += reinforcementText[narrativePerspective];
            
            // ã€æ–°å¢ã€‘å¦‚æœå¯ç”¨å‘é‡æ£€ç´¢ï¼Œä½¿ç”¨ä¼˜åŒ–åçš„ä¸Šä¸‹æ–‡æ„å»º
            if (enableVectorRetrieval && window.contextVectorManager) {
                console.log('[å‘é‡æ£€ç´¢æ¨¡å¼] ä½¿ç”¨æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º');
                // æ„å»ºåŒ…å«å®é™…å±æ€§çš„å˜é‡çŠ¶æ€
                const variablesForAI = {
                    ...gameState.variables,
                    attributes: calculateActualAttributes() // ä½¿ç”¨å®é™…å±æ€§ï¼ˆåŒ…å«è£…å¤‡åŠ æˆï¼‰
                };
                // ğŸ”§ å…³é”®ä¿®å¤ï¼šä¼ å…¥åŸå§‹ç”¨æˆ·è¾“å…¥ç”¨äºå‘é‡æ£€ç´¢
                const inputForRetrieval = originalUserInput || userMessage;
                messages = await window.contextVectorManager.buildOptimizedMessages(
                    finalSystemPrompt,
                    variablesForAI,
                    userMessage,
                    historyDepth,
                    gameState.conversationHistory,
                    inputForRetrieval  // ğŸ‘ˆ æ–°å¢ï¼šç”¨äºå‘é‡æ£€ç´¢çš„åŸå§‹è¾“å…¥
                );
                return messages;
            }
            
            // ã€åŸæœ‰é€»è¾‘ã€‘ä¸ä½¿ç”¨å‘é‡æ£€ç´¢çš„æƒ…å†µ
            messages.push({
                role: 'system',
                content: finalSystemPrompt
            });

            // æ·»åŠ å½“å‰å˜é‡çŠ¶æ€ï¼ˆä½¿ç”¨å®é™…å±æ€§ï¼ŒåŒ…å«è£…å¤‡åŠ æˆï¼‰
            const variablesForAI = {
                ...gameState.variables,
                attributes: calculateActualAttributes() // ä½¿ç”¨å®é™…å±æ€§ï¼ˆåŒ…å«è£…å¤‡åŠ æˆï¼‰
            };
            messages.push({
                role: 'system',
                content: 'å½“å‰è§’è‰²å˜é‡çŠ¶æ€ï¼š\n```json\n' + JSON.stringify(variablesForAI, null, 2) + '\n```'
            });

            // æ ¹æ®å†å²å±‚æ•°æ§åˆ¶æ·»åŠ å¯¹è¯å†å²
            if (historyDepth > 0) {
                // å‘é€æœ€è¿‘Nå±‚çš„å¯¹è¯ï¼ˆåªå‘é€å‰§æƒ…å†…å®¹ï¼Œä¸å‘é€é€‰é¡¹ï¼‰
                const recentHistory = gameState.conversationHistory.slice(-historyDepth * 2); // ä¹˜2å› ä¸ºåŒ…å«ç”¨æˆ·å’ŒAIçš„æ¶ˆæ¯
                messages = messages.concat(recentHistory);
            }
            // å¦‚æœhistoryDepthä¸º0ï¼Œåˆ™ä¸æ·»åŠ ä»»ä½•å¯¹è¯å†å²

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            messages.push({
                role: 'user',
                content: userMessage
            });

            return messages;
        }







        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            if (gameState.isProcessing) return;

            if (!apiConfig.endpoint || !apiConfig.key) {
                alert('è¯·å…ˆé…ç½®APIè¿æ¥');
                return;
            }

            gameState.isProcessing = true;

            // ğŸ”§ å°† initPrompt æå‡åˆ°å¤–éƒ¨ä½œç”¨åŸŸï¼Œä¾› catch ä½¿ç”¨
            let initPrompt = 'å¼€å§‹æ¸¸æˆï¼Œç”Ÿæˆå‰§æƒ…åŠé€‰é¡¹ã€‚';

            try {
                // æ„å»ºè§’è‰²åˆå§‹åŒ–æç¤º
                if (gameState.characterInfo) {
                    const info = gameState.characterInfo;
                    initPrompt = `å¼€å§‹æ¸¸æˆã€‚è§’è‰²ä¿¡æ¯ï¼šå§“å${info.name}ï¼Œå¹´é¾„${info.age}å²ï¼Œæ€§åˆ«${info.gender}ï¼Œæ€§æ ¼${info.personality}ã€‚å‡ºèº«ï¼š${info.origin}ã€‚éš¾åº¦ï¼š${info.difficulty}ã€‚`;
                    if (info.talents && info.talents.length > 0) {
                        initPrompt += `å¤©èµ‹ï¼š${info.talents.join('ã€')}ã€‚`;
                    }
                    if (info.customSettings) {
                        initPrompt += `ç‰¹æ®Šè®¾å®šï¼š${info.customSettings}ã€‚`;
                    }
                    initPrompt += `è¯·æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªå¼•äººå…¥èƒœçš„å¼€å±€å‰§æƒ…å’Œé€‰é¡¹ã€‚`;
                    
                    // ã€å…³é”®è¦æ±‚ã€‘å¿…é¡»ç”Ÿæˆçš„åˆå§‹å˜é‡å’Œæ•°æ®ç»“æ„
                    initPrompt += `\n\nã€æå…¶é‡è¦ã€‘å¿…é¡»åœ¨è¿”å›çš„JSONä¸­åŒ…å«ä»¥ä¸‹å®Œæ•´å­—æ®µç»“æ„ï¼š`;
                    initPrompt += `\n1. equipmentå­—æ®µï¼šæ ¹æ®è§’è‰²å‡ºèº«å’Œèº«ä»½è‡ªåŠ¨ç”Ÿæˆåˆé€‚çš„åˆå§‹è£…å¤‡`;
                    initPrompt += `   - è£…å¤‡å“è´¨å’Œå±æ€§è¦ä¸èº«ä»½åŒ¹é…ï¼šæ•£ä¿®è£…å¤‡æœ´ç´ ï¼Œä¸–å®¶è£…å¤‡ç²¾è‰¯ï¼Œå®—é—¨è£…å¤‡æœ‰ç‰¹è‰²æ ‡è¯†`;
                    initPrompt += `\n2. variableså­—æ®µï¼šå¿…é¡»è®¾ç½®currentDateTimeã€factionå’ŒminWordCountå­—æ®µ`;
                    initPrompt += `   - currentDateTimeï¼šä¸–ç•Œæ—¥æœŸæ—¶é—´ï¼ˆæ ¼å¼ï¼šå¤©å…ƒå†XXXXå¹´XæœˆXæ—¥ æ—¶è¾°ï¼‰`;
                    initPrompt += `   - factionï¼šã€æå…¶é‡è¦ã€‘è§’è‰²æ‰€å±åŠ¿åŠ›ï¼Œæ ¹æ®å‡ºèº«è‡ªåŠ¨åˆ†é…`;
                    initPrompt += `   - åŠ¿åŠ›ä¿¡æ¯å½±å“åç»­å‰§æƒ…å‘å±•å’ŒNPCå…³ç³»`;
                    initPrompt += `   - minWordCountï¼š${document.getElementById('minWordCount').value}`;
                    initPrompt += `   - æ‰€æœ‰åç»­å‰§æƒ…å›å¤éƒ½å¿…é¡»è¾¾åˆ°æˆ–è¶…è¿‡æ­¤å­—æ•°è¦æ±‚`;
                    initPrompt += `\n3. statså­—æ®µï¼šè§’è‰²åŸºç¡€å±æ€§`;
                    initPrompt += `   - åŒ…å«ï¼šä¿®ä¸ºå¢ƒç•Œã€ç”Ÿå‘½å€¼ã€çµåŠ›å€¼ç­‰åŸºç¡€æ•°æ®`;
                    initPrompt += `   - æ ¹æ®å‡ºèº«å’Œå¤©èµ‹åˆç†åˆ†é…åˆå§‹å±æ€§`;                    
                }

                // å°†åˆå§‹åŒ–æç¤ºæ·»åŠ åˆ°å†å²è®°å½•ä¸­ï¼Œä»¥ä¾¿é‡æ–°ç”ŸæˆåŠŸèƒ½èƒ½æ­£å¸¸å·¥ä½œ
                gameState.conversationHistory.push({
                    role: 'user',
                    content: initPrompt
                });

                const response = await callAI(initPrompt);

                // æ¸…ç©ºæ¸¸æˆå†å²åŒºåŸŸï¼ˆç§»é™¤åŠ è½½æç¤ºï¼‰
                document.getElementById('gameHistory').innerHTML = '';

                // æ˜¾ç¤ºåˆå§‹åŒ–æ¶ˆæ¯
                displayUserMessage(initPrompt);

                handleAIResponse(response);
                gameState.isGameStarted = true;

                // ä¿å­˜æ¸¸æˆå†å²ï¼ˆæ ‡è®°æ¸¸æˆå·²å¼€å§‹ï¼‰
                await saveGameHistory();

                // è§¦å‘åŠ¨æ€ä¸–ç•Œç”Ÿæˆï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                generateDynamicWorld().catch(err => console.error('[åŠ¨æ€ä¸–ç•Œ] ç”Ÿæˆå¼‚å¸¸:', err));

            } catch (error) {
                // âŒ ä¸è¦æ¸…ç©ºå†å²ï¼åªç§»é™¤åŠ è½½æç¤º
                const loadingMsg = document.querySelector('#gameHistory .message.ai-message');
                if (loadingMsg && loadingMsg.textContent.includes('AIç”Ÿæˆå¼€å±€å‰§æƒ…ä¸­')) {
                    loadingMsg.remove();
                }

                // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆå¦‚æœè¿˜æ²¡æ˜¾ç¤ºï¼‰
                if (document.getElementById('gameHistory').children.length === 0) {
                    displayUserMessage(initPrompt);
                }

                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å’Œé‡è¯•æŒ‰é’®
                displayErrorMessageWithRetry('æ¸¸æˆå¯åŠ¨å¤±è´¥ï¼š' + error.message + '\n\nå¯èƒ½åŸå› ï¼šç½‘ç»œè¶…æ—¶ã€APIå¯†é’¥é”™è¯¯ã€æ¨¡å‹ä¸å¯ç”¨', async () => {
                    // ç§»é™¤é”™è¯¯æ¶ˆæ¯
                    dismissError();
                    
                    // ğŸ”§ ä»å†å²è®°å½•ä¸­ç§»é™¤å¤±è´¥çš„è¯·æ±‚ï¼ˆé¿å…é‡å¤ï¼‰
                    const lastMsg = gameState.conversationHistory[gameState.conversationHistory.length - 1];
                    if (lastMsg && lastMsg.role === 'user' && lastMsg.content === initPrompt) {
                        gameState.conversationHistory.pop();
                        gameState.variableSnapshots.pop(); // åŒæ—¶ç§»é™¤å¿«ç…§
                    }
                    
                    // é‡æ–°å¼€å§‹æ¸¸æˆ
                    await startGame();
                });
            }

            gameState.isProcessing = false;
        }

        /**
         * ğŸ†• æå–å¹¶æ·»åŠ historyåˆ°çŸ©é˜µ
         * @param {string} variableUpdate - variableUpdateå­—ç¬¦ä¸²
         * @param {number} turnIndex - è½®æ¬¡ç´¢å¼•
         */
        async function extractAndAddHistoryToMatrix(variableUpdate, turnIndex) {
            if (!window.contextVectorManager || !window.matrixManager) {
                return;
            }
            
            try {
                // ä»variableUpdateä¸­æå–history
                const historyItems = [];
                
                // åŒ¹é… >>history: æ–‡æœ¬ æ ¼å¼
                const singleHistoryRegex = />>history:\s*(.+)/g;
                let match;
                while ((match = singleHistoryRegex.exec(variableUpdate)) !== null) {
                    historyItems.push(match[1].trim());
                }
                
                // åŒ¹é… history:\n  - æ–‡æœ¬ æ ¼å¼
                const multiHistoryRegex = /history:\s*\n\s*-\s*(.+)/g;
                while ((match = multiHistoryRegex.exec(variableUpdate)) !== null) {
                    historyItems.push(match[1].trim());
                }
                
                if (historyItems.length === 0) {
                    console.log('[HistoryçŸ©é˜µ] æœ¬è½®æœªæ‰¾åˆ°historyå­—æ®µ');
                    return;
                }
                
                console.log(`[HistoryçŸ©é˜µ] ğŸ“¥ æå–åˆ° ${historyItems.length} æ¡history`);
                
                // æ·»åŠ åˆ°çŸ©é˜µ
                for (const historyText of historyItems) {
                    await window.contextVectorManager.addHistoryEntry(
                        historyText,
                        turnIndex,
                        gameState.variables
                    );
                }
                
                console.log(`[HistoryçŸ©é˜µ] âœ… å·²æ·»åŠ  ${historyItems.length} æ¡historyåˆ°çŸ©é˜µ`);
            } catch (error) {
                console.error('[HistoryçŸ©é˜µ] âŒ æ·»åŠ å¤±è´¥:', error);
            }
        }

        // å¤„ç†AIå“åº”
        function handleAIResponse(response) {
            // è°ƒè¯•æ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºåŸå§‹å“åº”ï¼Œä¸åšä»»ä½•è§£ææˆ–æ¸²æŸ“å¤„ç†
            const debugCheckbox = document.getElementById('debugMode');
            if (debugCheckbox && debugCheckbox.checked) {
                appendDebug('AI', response);
                // è°ƒè¯•æ¨¡å¼ä¸‹ä»…å±•ç¤ºï¼Œä¸å…¥åº“ä¸å˜é‡æ›´æ–°
                return;
            }

            // âœ… ä½¿ç”¨å¢å¼ºç‰ˆJSONå¤„ç†å·¥å…·ï¼ˆä¿è¯ä¸ä¼šå¤±è´¥ï¼‰
            let data;
            try {
                data = processAIResponse(response);
            } catch (error) {
                console.error('âŒ processAIResponseå¼‚å¸¸:', error);
                // é™çº§æ–¹æ¡ˆï¼šæ„é€ æœ€å°å¯ç”¨æ•°æ®
                data = {
                    reasoning: { situation: 'è§£æå¼‚å¸¸', playerChoice: '', logicChain: [], outcome: '' },
                    variableChanges: { analysis: 'Parse error', changes: {} },
                    story: 'ç³»ç»Ÿé”™è¯¯ï¼šAIå“åº”è§£æå¤±è´¥\n\n' + response.substring(0, 500),
                    options: ['é‡æ–°ç”Ÿæˆ', 'å°è¯•ç»§ç»­', 'æŸ¥çœ‹æ—¥å¿—', 'è¿”å›èœå•', 'ä¿å­˜é€€å‡º']
                };
            }

            // æ›´æ–°å˜é‡ï¼ˆæ”¯æŒä¸‰ç§æ ¼å¼ï¼‰
            console.log('[game.html] å¼€å§‹å¤„ç†å˜é‡æ›´æ–°ï¼Œdataå¯¹è±¡:', data);
            console.log('[game.html] data.variableUpdate å­˜åœ¨:', !!data.variableUpdate);
            console.log('[game.html] data.variableChanges å­˜åœ¨:', !!data.variableChanges);
            console.log('[game.html] data.variables å­˜åœ¨:', !!data.variables);
            
            if (data.variableUpdate) {
                try {
                    // v3.1 ç®€åŒ–æ ¼å¼ï¼ˆæ¨èï¼‰
                    console.log('[v3.1] ğŸ¯ ä½¿ç”¨ v3.1 ç®€åŒ–æ ¼å¼æ›´æ–°å˜é‡');
                    console.log('[v3.1] variableUpdate å†…å®¹:', data.variableUpdate);
                    
                    // åˆå§‹åŒ– v3.1 è§£æå™¨
                    if (!window.v31Parser) {
                        console.log('[v3.1] åˆå§‹åŒ–è§£æå™¨...');
                        window.v31Parser = new VariableInstructionParserV31(gameState, {
                            debug: true,
                            enableRollback: false
                        });
                        console.log('[v3.1] è§£æå™¨åˆå§‹åŒ–å®Œæˆ');
                    }
                    
                    // è§£æå¹¶æ‰§è¡Œå˜é‡æ›´æ–°
                    const result = window.v31Parser.execute(data.variableUpdate);
                    console.log('[v3.1] âœ… æ›´æ–°ç»“æœ:', result);
                    
                    // ğŸ†• è‡ªåŠ¨æå–äººç‰©åˆ°å›¾è°±
                    if (window.characterGraphIntegration && 
                        window.characterGraphIntegration.isEnabled && 
                        gameState.variables && 
                        gameState.variables.relationships && 
                        Array.isArray(gameState.variables.relationships)) {
                        console.log(`[äººç‰©å›¾è°±] ğŸ“¥ è‡ªåŠ¨æå– ${gameState.variables.relationships.length} ä¸ªäººç‰©åˆ°å›¾è°±...`);
                        window.characterGraphIntegration.extractCharactersFromResponse(gameState.variables.relationships)
                            .catch(err => console.error('[äººç‰©å›¾è°±] æå–å¤±è´¥:', err));
                    }
                    
                    updateStatusPanel();
                    showAttributeChanges();
                } catch (error) {
                    console.error('âŒ v3.1 å˜é‡æ›´æ–°å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    console.error('variableUpdateå†…å®¹:', data.variableUpdate);
                }
            } else if (data.variableChanges) {
                try {
                    // æ—§æ–¹æ¡ˆï¼šå¢é‡æ›´æ–°
                    applyVariableChanges(data.variableChanges);
                    
                    // ğŸ†• è‡ªåŠ¨æå–äººç‰©åˆ°å›¾è°±
                    if (window.characterGraphIntegration && 
                        window.characterGraphIntegration.isEnabled && 
                        gameState.variables && 
                        gameState.variables.relationships && 
                        Array.isArray(gameState.variables.relationships)) {
                        console.log(`[äººç‰©å›¾è°±] ğŸ“¥ è‡ªåŠ¨æå– ${gameState.variables.relationships.length} ä¸ªäººç‰©åˆ°å›¾è°±...`);
                        window.characterGraphIntegration.extractCharactersFromResponse(gameState.variables.relationships)
                            .catch(err => console.error('[äººç‰©å›¾è°±] æå–å¤±è´¥:', err));
                    }
                    
                    updateStatusPanel();
                    showAttributeChanges();
                } catch (error) {
                    console.error('âŒ å˜é‡æ›´æ–°å¤±è´¥:', error);
                }
            } else if (data.variables) {
                try {
                    // æ—§æ–¹æ¡ˆï¼šå®Œæ•´å˜é‡è¡¨å•ï¼ˆå‘åå…¼å®¹ï¼‰
                    updateVariables(data.variables);
                    
                    // ğŸ†• è‡ªåŠ¨æå–äººç‰©åˆ°å›¾è°±
                    if (window.characterGraphIntegration && 
                        window.characterGraphIntegration.isEnabled && 
                        gameState.variables && 
                        gameState.variables.relationships && 
                        Array.isArray(gameState.variables.relationships)) {
                        console.log(`[äººç‰©å›¾è°±] ğŸ“¥ è‡ªåŠ¨æå– ${gameState.variables.relationships.length} ä¸ªäººç‰©åˆ°å›¾è°±...`);
                        window.characterGraphIntegration.extractCharactersFromResponse(gameState.variables.relationships)
                            .catch(err => console.error('[äººç‰©å›¾è°±] æå–å¤±è´¥:', err));
                    }
                    
                    updateStatusPanel();
                    showAttributeChanges();
                } catch (error) {
                    console.error('âŒ å˜é‡æ›´æ–°å¤±è´¥ï¼ˆæ—§æ–¹æ¡ˆï¼‰:', error);
                }
            }

            // æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆä¿å­˜å‰§æƒ… + åŸå§‹å“åº”/JSONï¼‰
            if (data.story) {
                gameState.conversationHistory.push({
                    role: 'assistant',
                    content: data.story,
                    rawResponse: response,
                    parsed: data
                });

                // ä¿å­˜å½“å‰å˜é‡å¿«ç…§
                gameState.variableSnapshots.push(JSON.parse(JSON.stringify(gameState.variables)));
                
                // ã€æ–°å¢ã€‘å¦‚æœå¯ç”¨å‘é‡æ£€ç´¢ï¼Œæ·»åŠ åˆ°å‘é‡åº“
                const enableVectorRetrieval = document.getElementById('enableVectorRetrieval')?.checked || false;
                if (enableVectorRetrieval && window.contextVectorManager && gameState.conversationHistory.length >= 2) {
                    const turnIndex = Math.floor(gameState.conversationHistory.length / 2);
                    const userMessage = gameState.conversationHistory[gameState.conversationHistory.length - 2].content;
                    const aiResponse = data.story;
                    
                    // å¼‚æ­¥æ·»åŠ åˆ°å‘é‡åº“ï¼ˆä¸é˜»å¡æ¸¸æˆæµç¨‹ï¼‰
                    window.contextVectorManager.addConversation(
                        userMessage,
                        aiResponse,
                        turnIndex,
                        gameState.variables
                    ).then(async () => {
                        // ğŸ†• æå–å¹¶æ·»åŠ historyåˆ°çŸ©é˜µ
                        if (data.variableUpdate) {
                            await extractAndAddHistoryToMatrix(data.variableUpdate, turnIndex);
                        }
                        
                        // ä¿å­˜å‘é‡åº“åˆ°IndexedDB
                        return window.contextVectorManager.saveToIndexedDB();
                    }).catch(err => {
                        console.error('âŒ å‘é‡åº“æ·»åŠ å¤±è´¥:', err);
                        console.error('é”™è¯¯è¯¦æƒ…:', err.stack);
                        
                        // è‡ªåŠ¨å›é€€åˆ°å…³é”®è¯æ–¹æ³•
                        const currentMethod = window.contextVectorManager.embeddingMethod;
                        if (currentMethod !== 'keyword') {
                            console.warn(`[å‘é‡åº“] ${currentMethod}æ–¹æ³•å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å…³é”®è¯æ–¹æ³•`);
                            window.contextVectorManager.setEmbeddingMethod('keyword');
                            document.getElementById('vectorMethod').value = 'keyword';
                            
                            // æç¤ºç”¨æˆ·
                            setTimeout(() => {
                                alert(`âš ï¸ å‘é‡åŒ–å¤±è´¥\n\n${currentMethod}æ–¹æ³•å‡ºç°é”™è¯¯ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°"å…³é”®è¯åŒ¹é…"æ–¹æ³•\n\né”™è¯¯ï¼š${err.message}\n\næ¸¸æˆå°†æ­£å¸¸ç»§ç»­ï¼Œä¸å½±å“ä½¿ç”¨ã€‚`);
                            }, 1000);
                        }
                    });
                }
            }

            // æˆ˜æ–—åœºæ™¯æ£€æµ‹å·²ç¦ç”¨
            // æ¸…é™¤å¾…å¤„ç†çš„æˆ˜æ–—ä¿¡æ¯
            window.pendingCombatInfo = null;
            
            // æ­£å¸¸æ˜¾ç¤ºæ¶ˆæ¯
            displayAIMessage(data.story, data.options, data.reasoning);
            
            // ä¿å­˜æ¸¸æˆå†å²
            saveGameHistory().catch(err => console.error('ä¿å­˜å†å²å¤±è´¥:', err));

            if (gameState && gameState.localOps) {
                gameState.localOps = { items: [], attrs: [], equip: [] };
            }
        }

        // è°ƒè¯•æ¨¡å¼ï¼šåˆ‡æ¢æ˜¾ç¤ºåŒºåŸŸ
        // è°ƒè¯•æ¨¡å¼ç›¸å…³å‡½æ•°å·²è¿ç§»åˆ° game-initialization.js

        // æ¢å¤å¯¹è¯å†å²æ˜¾ç¤º
        // restoreConversationHistory å·²è¿ç§»åˆ° game-initialization.js

        /**
         * åº”ç”¨å¢é‡å˜é‡æ›´æ–°ï¼ˆæ–°æ–¹æ¡ˆï¼‰
         * @param {Object} variableChanges - AIè¿”å›çš„variableChangeså¯¹è±¡
         * @returns {Object} æ›´æ–°åçš„å˜é‡çŠ¶æ€
         */
        function applyVariableChanges(variableChanges) {
            if (!variableChanges) {
                console.warn('[å˜é‡æ›´æ–°] æ²¡æœ‰å˜é‡å˜åŒ–æ•°æ®');
                return gameState.variables;
            }

            const { analysis, changes = {}, arrayChanges, newFields = [], removedFields = [] } = variableChanges;

            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('[å˜é‡æ›´æ–°] å¼€å§‹åº”ç”¨å¢é‡æ›´æ–°');
            if (analysis) {
                console.log('[å˜é‡æ›´æ–°] åˆ†æ:', analysis);
            }
            if (Object.keys(changes).length > 0) {
                console.log('[å˜é‡æ›´æ–°] å˜åŒ–å­—æ®µ:', Object.keys(changes));
            }
            if (arrayChanges) {
                console.log('[å˜é‡æ›´æ–°] æ•°ç»„å¢é‡æ›´æ–°:', Object.keys(arrayChanges));
            }
            if (newFields.length > 0) {
                console.log('[å˜é‡æ›´æ–°] æ–°å¢å­—æ®µ:', newFields);
            }
            if (removedFields.length > 0) {
                console.log('[å˜é‡æ›´æ–°] åˆ é™¤å­—æ®µ:', removedFields);
            }

            // ä¿å­˜ä¹‹å‰çš„å˜é‡çŠ¶æ€ç”¨äºè®¡ç®—å˜åŒ–
            gameState.previousVariables = JSON.parse(JSON.stringify(gameState.variables));

            // 1. å¤„ç†æ™®é€šå­—æ®µå˜åŒ–
            for (const [key, value] of Object.entries(changes)) {
                applyFieldChange(key, value);
            }

            // 2. å¤„ç†æ•°ç»„å­—æ®µå¢é‡æ›´æ–°ï¼ˆæ–°åŠŸèƒ½ï¼‰
            if (arrayChanges) {
                applyArrayChanges(arrayChanges);
            }

            // 3. åˆ é™¤æ ‡è®°ä¸ºç§»é™¤çš„å­—æ®µ
            removedFields.forEach(field => {
                if (gameState.variables.hasOwnProperty(field)) {
                    delete gameState.variables[field];
                    console.log(`[å˜é‡æ›´æ–°] âŒ åˆ é™¤å­—æ®µ: ${field}`);
                }
            });

            console.log('[å˜é‡æ›´æ–°] âœ… å¢é‡æ›´æ–°å®Œæˆ');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            return gameState.variables;
        }

        /**
         * åº”ç”¨æ•°ç»„å­—æ®µçš„å¢é‡æ›´æ–°ï¼ˆadd/remove/updateæ¨¡å¼ï¼‰
         * @param {Object} arrayChanges - æ•°ç»„å¢é‡æ›´æ–°å¯¹è±¡
         */
        function applyArrayChanges(arrayChanges) {
            for (const [arrayName, operations] of Object.entries(arrayChanges)) {
                if (!gameState.variables[arrayName]) {
                    gameState.variables[arrayName] = [];
                }

                const array = gameState.variables[arrayName];
                const emoji = {
                    'items': 'ğŸ’',
                    'relationships': 'ğŸ‘¥',
                    'techniques': 'ğŸ“–',
                    'spells': 'âœ¨'
                }[arrayName] || 'ğŸ“';

                console.log(`[æ•°ç»„æ›´æ–°] ${emoji} å¤„ç† ${arrayName}:`);

                // 1. å¤„ç†åˆ é™¤æ“ä½œ
                if (operations.remove && operations.remove.length > 0) {
                    operations.remove.forEach(item => {
                        removeFromArray(array, item, arrayName);
                    });
                }

                // 2. å¤„ç†æ–°å¢æ“ä½œ
                if (operations.add && operations.add.length > 0) {
                    operations.add.forEach(item => {
                        addToArray(array, item, arrayName);
                    });
                }

                // 3. å¤„ç†æ›´æ–°æ“ä½œ
                if (operations.update && operations.update.length > 0) {
                    operations.update.forEach(item => {
                        updateInArray(array, item, arrayName);
                    });
                }
            }
        }

        /**
         * ä»æ•°ç»„ä¸­åˆ é™¤å…ƒç´ æˆ–å‡å°‘æ•°é‡
         * @param {Array} array - ç›®æ ‡æ•°ç»„
         * @param {Object} item - è¦åˆ é™¤çš„å…ƒç´ 
         * @param {string} arrayName - æ•°ç»„åç§°
         */
        function removeFromArray(array, item, arrayName) {
            const index = array.findIndex(el => el.name === item.name);

            if (index === -1) {
                console.warn(`  âš ï¸ å°è¯•åˆ é™¤ä¸å­˜åœ¨çš„${arrayName}: ${item.name}`);
                return;
            }

            // å¦‚æœæ˜¯itemsä¸”æŒ‡å®šäº†countï¼Œåˆ™å‡å°‘æ•°é‡
            if (arrayName === 'items' && item.count !== undefined) {
                const oldCount = array[index].count;
                array[index].count -= item.count;
                console.log(`  â– ${item.name}: æ•°é‡ -${item.count} (${oldCount} â†’ ${array[index].count})`);

                // å¦‚æœæ•°é‡<=0ï¼Œåˆ™å®Œå…¨åˆ é™¤
                if (array[index].count <= 0) {
                    array.splice(index, 1);
                    console.log(`  âŒ ${item.name}: æ•°é‡å½’é›¶ï¼Œå·²ä»ç‰©å“åˆ—è¡¨åˆ é™¤`);
                }
            } else {
                // å®Œå…¨åˆ é™¤
                array.splice(index, 1);
                console.log(`  âŒ åˆ é™¤ ${item.name}`);
            }
        }

        /**
         * å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ æˆ–å¢åŠ æ•°é‡
         * @param {Array} array - ç›®æ ‡æ•°ç»„
         * @param {Object} item - è¦æ·»åŠ çš„å…ƒç´ 
         * @param {string} arrayName - æ•°ç»„åç§°
         */
        function addToArray(array, item, arrayName) {
            const existingIndex = array.findIndex(el => el.name === item.name);

            // å¦‚æœæ˜¯itemsä¸”å·²å­˜åœ¨ï¼Œåˆ™å¢åŠ æ•°é‡
            if (arrayName === 'items' && existingIndex !== -1) {
                const oldCount = array[existingIndex].count;
                array[existingIndex].count += item.count;
                console.log(`  â• ${item.name}: æ•°é‡ +${item.count} (${oldCount} â†’ ${array[existingIndex].count})`);

                // æ›´æ–°å…¶ä»–å­—æ®µï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
                Object.assign(array[existingIndex], item);
            } else if (existingIndex !== -1) {
                // å…¶ä»–æ•°ç»„ç±»å‹ï¼Œå¦‚æœå·²å­˜åœ¨åˆ™æ›¿æ¢
                array[existingIndex] = item;
                console.log(`  ğŸ”„ æ›¿æ¢ ${item.name}`);
            } else {
                // ä¸å­˜åœ¨åˆ™æ–°å¢
                array.push(item);
                const extra = arrayName === 'items' ? ` (æ•°é‡: ${item.count})` : '';
                console.log(`  âœ… æ–°å¢ ${item.name}${extra}`);
            }
        }

        /**
         * æ›´æ–°æ•°ç»„ä¸­å·²å­˜åœ¨çš„å…ƒç´ 
         * @param {Array} array - ç›®æ ‡æ•°ç»„
         * @param {Object} item - è¦æ›´æ–°çš„å…ƒç´ ï¼ˆåŒ…å«nameå’Œè¦æ›´æ–°çš„å­—æ®µï¼‰
         * @param {string} arrayName - æ•°ç»„åç§°
         */
        function updateInArray(array, item, arrayName) {
            const existingIndex = array.findIndex(el => el.name === item.name);

            if (existingIndex === -1) {
                console.warn(`  âš ï¸ å°è¯•æ›´æ–°ä¸å­˜åœ¨çš„${arrayName}: ${item.name}`);
                return;
            }

            // è®°å½•æ—§å€¼
            const oldValues = {};
            const updatedFields = Object.keys(item).filter(k => k !== 'name');
            updatedFields.forEach(field => {
                oldValues[field] = array[existingIndex][field];
            });

            // ç‰¹æ®Šå¤„ç†ï¼šrelationshipsæ•°ç»„çš„historyå­—æ®µéœ€è¦è¿½åŠ è€Œä¸æ˜¯è¦†ç›–
            if (arrayName === 'relationships' && item.history) {
                const existingHistory = array[existingIndex].history || [];
                const newHistory = item.history || [];
                
                // å»é‡åˆå¹¶ï¼šåªæ·»åŠ ä¸é‡å¤çš„å†å²è®°å½•
                const mergedHistory = [...existingHistory];
                let addedCount = 0;
                
                newHistory.forEach(newItem => {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå†…å®¹ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼åæ¯”è¾ƒï¼‰
                    const trimmedNew = newItem.trim();
                    const isDuplicate = mergedHistory.some(existing => existing.trim() === trimmedNew);
                    
                    if (!isDuplicate && trimmedNew) {
                        mergedHistory.push(newItem);
                        addedCount++;
                    }
                });
                
                // æ›´æ–°historyå­—æ®µä¸ºåˆå¹¶åçš„æ•°ç»„
                item.history = mergedHistory;
                
                if (addedCount > 0) {
                    console.log(`    - history: è¿½åŠ äº† ${addedCount} æ¡æ–°è®°å½•ï¼ˆæ€»è®¡ï¼š${mergedHistory.length}æ¡ï¼‰`);
                }
            }

            // åˆå¹¶æ›´æ–°å­—æ®µ
            Object.assign(array[existingIndex], item);

            // è¾“å‡ºè¯¦ç»†æ—¥å¿—
            console.log(`  ğŸ”§ æ›´æ–° ${item.name}:`);
            updatedFields.forEach(field => {
                if (field === 'history' && arrayName === 'relationships') {
                    // historyå­—æ®µå·²ç»åœ¨ä¸Šé¢ç‰¹æ®Šå¤„ç†è¿‡äº†ï¼Œè·³è¿‡è¯¦ç»†æ—¥å¿—
                    return;
                }
                console.log(`    - ${field}: ${JSON.stringify(oldValues[field])} â†’ ${JSON.stringify(item[field])}`);
            });
        }

        /**
         * åº”ç”¨å•ä¸ªå­—æ®µçš„å˜åŒ–
         * @param {string} key - å­—æ®µå
         * @param {any} value - æ–°å€¼
         */
        function applyFieldChange(key, value) {
            // ========== ç‰¹æ®Šå¤„ç†1ï¼šhistoryå­—æ®µä½¿ç”¨è¿½åŠ æ¨¡å¼ ==========
            if (key === 'history') {
                if (!gameState.variables.history) {
                    gameState.variables.history = [];
                }
                if (Array.isArray(value)) {
                    let addedCount = 0;
                    value.forEach(newRecord => {
                        const trimmed = newRecord.trim();
                        const isDuplicate = gameState.variables.history.some(
                            existing => existing.trim() === trimmed
                        );
                        if (!isDuplicate && trimmed) {
                            gameState.variables.history.push(newRecord);
                            addedCount++;
                            console.log(`[å˜é‡æ›´æ–°] ğŸ“œ æ–°å¢å†å²: ${newRecord.substring(0, 50)}...`);
                        }
                    });
                    console.log(`[å˜é‡æ›´æ–°] history: è¿½åŠ äº† ${addedCount} æ¡æ–°è®°å½•`);
                }
                return;
            }

            // ========== ç‰¹æ®Šå¤„ç†2ï¼šå¯¹è±¡å­—æ®µä½¿ç”¨éƒ¨åˆ†æ›´æ–°æ¨¡å¼ ==========
            if (key === 'attributes' || key === 'equipment') {
                if (!gameState.variables[key]) {
                    gameState.variables[key] = {};
                }
                const changedKeys = Object.keys(value);
                Object.assign(gameState.variables[key], value);
                console.log(`[å˜é‡æ›´æ–°] ğŸ”§ éƒ¨åˆ†æ›´æ–° ${key}: [${changedKeys.join(', ')}]`);

                // è¯¦ç»†è®°å½•æ¯ä¸ªå­å­—æ®µçš„å˜åŒ–
                changedKeys.forEach(subKey => {
                    const oldValue = gameState.previousVariables?.[key]?.[subKey];
                    const newValue = value[subKey];
                    if (oldValue !== undefined) {
                        console.log(`  - ${subKey}: ${JSON.stringify(oldValue)} -> ${JSON.stringify(newValue)}`);
                    } else {
                        console.log(`  - ${subKey}: (æ–°å¢) ${JSON.stringify(newValue)}`);
                    }
                });
                return;
            }

            // ========== ç‰¹æ®Šå¤„ç†3ï¼šæ•°ç»„å­—æ®µä½¿ç”¨å®Œæ•´æ›¿æ¢æ¨¡å¼ï¼ˆå¸¦å®‰å…¨æ£€æŸ¥ï¼‰==========
            if (key === 'items' || key === 'relationships' || key === 'techniques' || key === 'spells') {
                const oldCount = gameState.variables[key] ? gameState.variables[key].length : 0;
                const newCount = Array.isArray(value) ? value.length : 0;

                // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢æ•°æ®ä¸¢å¤±
                if (oldCount > 5 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ ${key}æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                    console.warn(`âš ï¸ å»ºè®®æ£€æŸ¥AIè¿”å›çš„${key}æ•°ç»„æ˜¯å¦å®Œæ•´`);
                }

                gameState.variables[key] = value;

                const emoji = {
                    'items': 'ğŸ’',
                    'relationships': 'ğŸ‘¥',
                    'techniques': 'ğŸ“–',
                    'spells': 'âœ¨'
                }[key] || 'ğŸ“';

                console.log(`[å˜é‡æ›´æ–°] ${emoji} å®Œæ•´æ›¿æ¢ ${key}: ${oldCount} -> ${newCount}`);

                // å¦‚æœæ˜¯itemsï¼Œè¯¦ç»†è®°å½•æ–°å¢å’Œåˆ é™¤çš„ç‰©å“
                if (key === 'items' && gameState.previousVariables?.items) {
                    const oldItems = new Set(gameState.previousVariables.items.map(i => i.name));
                    const newItems = new Set(value.map(i => i.name));

                    const added = [...newItems].filter(name => !oldItems.has(name));
                    const removed = [...oldItems].filter(name => !newItems.has(name));

                    if (added.length > 0) {
                        console.log(`  âœ… æ–°å¢ç‰©å“: ${added.join(', ')}`);
                    }
                    if (removed.length > 0) {
                        console.log(`  âŒ ç§»é™¤ç‰©å“: ${removed.join(', ')}`);
                    }
                }

                // å¦‚æœæ˜¯relationshipsï¼Œè¯¦ç»†è®°å½•æ–°å¢å’Œåˆ é™¤çš„å…³ç³»
                if (key === 'relationships' && gameState.previousVariables?.relationships) {
                    const oldRels = new Set(gameState.previousVariables.relationships.map(r => r.name));
                    const newRels = new Set(value.map(r => r.name));

                    const added = [...newRels].filter(name => !oldRels.has(name));
                    const removed = [...oldRels].filter(name => !newRels.has(name));

                    if (added.length > 0) {
                        console.log(`  âœ… æ–°å¢å…³ç³»: ${added.join(', ')}`);
                    }
                    if (removed.length > 0) {
                        console.log(`  âŒ ç§»é™¤å…³ç³»: ${removed.join(', ')}`);
                    }
                }

                return;
            }

            // ========== é»˜è®¤å¤„ç†ï¼šç›´æ¥æ›¿æ¢ ==========
            const oldValue = gameState.variables[key];
            gameState.variables[key] = value;

            // æ ¹æ®å­—æ®µç±»å‹é€‰æ‹©åˆé€‚çš„emoji
            const emoji = {
                'hp': 'â¤ï¸',
                'mp': 'ğŸ’™',
                'spiritStones': 'ğŸ’°',
                'age': 'ğŸ“…',
                'realm': 'âš¡',
                'location': 'ğŸ“',
                'karmaFortune': 'ğŸ€',
                'karmaPunishment': 'âš ï¸',
                'cultivationProgress': 'ğŸ“ˆ',
                'faction': 'ğŸ›ï¸'
            }[key] || 'ğŸ”„';

            if (oldValue !== undefined && oldValue !== value) {
                console.log(`[å˜é‡æ›´æ–°] ${emoji} ${key}: ${JSON.stringify(oldValue)} -> ${JSON.stringify(value)}`);
            } else {
                console.log(`[å˜é‡æ›´æ–°] ${emoji} ${key}: (æ–°å¢) ${JSON.stringify(value)}`);
            }
        }

        // æ›´æ–°å˜é‡ï¼ˆæ—§æ–¹æ¡ˆï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹ï¼‰
        function updateVariables(newVars) {
            // ä¿å­˜ä¹‹å‰çš„å˜é‡çŠ¶æ€ç”¨äºè®¡ç®—å˜åŒ–
            gameState.previousVariables = JSON.parse(JSON.stringify(gameState.variables));

            // åˆå¹¶å˜é‡
            if (newVars.currentDateTime !== undefined) gameState.variables.currentDateTime = newVars.currentDateTime;
            if (newVars.name !== undefined) gameState.variables.name = newVars.name;
            if (newVars.age !== undefined) gameState.variables.age = newVars.age;
            if (newVars.gender !== undefined) gameState.variables.gender = newVars.gender;
            if (newVars.realm !== undefined) gameState.variables.realm = newVars.realm;
            if (newVars.identity !== undefined) gameState.variables.identity = newVars.identity;
            if (newVars.spiritStones !== undefined) gameState.variables.spiritStones = newVars.spiritStones;
            if (newVars.location !== undefined) gameState.variables.location = newVars.location;
            if (newVars.karmaFortune !== undefined) gameState.variables.karmaFortune = newVars.karmaFortune;
            if (newVars.karmaPunishment !== undefined) gameState.variables.karmaPunishment = newVars.karmaPunishment;
            if (newVars.cultivationProgress !== undefined) gameState.variables.cultivationProgress = newVars.cultivationProgress;
            if (newVars.cultivationProgressMax !== undefined) gameState.variables.cultivationProgressMax = newVars.cultivationProgressMax;
            if (newVars.hp !== undefined) gameState.variables.hp = newVars.hp;
            if (newVars.hpMax !== undefined) gameState.variables.hpMax = newVars.hpMax;
            if (newVars.mp !== undefined) gameState.variables.mp = newVars.mp;
            if (newVars.mpMax !== undefined) gameState.variables.mpMax = newVars.mpMax;
            if (newVars.talents !== undefined) gameState.variables.talents = newVars.talents;

            // æ›´æ–°ç‚¼ä¸¹ç‚¼å™¨ç­‰çº§
            if (newVars.alchemyLevel !== undefined) gameState.variables.alchemyLevel = newVars.alchemyLevel;
            if (newVars.craftingLevel !== undefined) gameState.variables.craftingLevel = newVars.craftingLevel;

            // æ›´æ–°åŠ¿åŠ›ä¿¡æ¯
            if (newVars.faction !== undefined) gameState.variables.faction = newVars.faction;

            // æ›´æ–°å±æ€§
            if (newVars.attributes) {
                Object.assign(gameState.variables.attributes, newVars.attributes);
            }

            // æ›´æ–°è£…å¤‡
            if (newVars.equipment) {
                Object.assign(gameState.variables.equipment, newVars.equipment);
            }

            // æ›´æ–°é“å…·ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
            if (newVars.items) {
                const oldCount = gameState.variables.items ? gameState.variables.items.length : 0;
                const newCount = newVars.items.length;
                if (oldCount > 5 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ é“å…·æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                }

                if (!Array.isArray(gameState.variables.items)) {
                    gameState.variables.items = [];
                }

                const nameIndex = new Map(gameState.variables.items.map(i => [i.name, i]));
                const equippedNames = new Set(Object.values(gameState.variables.equipment || {})
                    .filter(e => e && e.name)
                    .map(e => e.name));
                for (const incoming of newVars.items) {
                    if (!incoming || !incoming.name) continue;
                    const existing = nameIndex.get(incoming.name);
                    const isEquipped = equippedNames.has(incoming.name);
                    if (existing) {
                        if (incoming.type !== undefined) existing.type = incoming.type;
                        if (incoming.effects !== undefined) existing.effects = incoming.effects;
                        if (incoming.count !== undefined) {
                            if (incoming._op === 'set') {
                                existing.count = incoming.count;
                            } else if (incoming._op === 'decrease') {
                                existing.count = Math.max(0, (existing.count || 0) - incoming.count);
                            } else if (incoming._op === 'increase') {
                                existing.count = (existing.count || 0) + (incoming.count || 1);
                            } else {
                                // é»˜è®¤ä¸ºå¿«ç…§ï¼šä¸å¯¹å·²è£…å¤‡ç‰©å“å›ä»“ï¼Œä¸”ä¸å‡å°‘æœ¬åœ°æ¶ˆè´¹
                                if (isEquipped) {
                                    existing.count = Math.max((existing.count || 0), 0);
                                } else {
                                    existing.count = Math.max((existing.count || 0), incoming.count || 0);
                                }
                            }
                        }
                    } else {
                        // æ²¡æœ‰æœ¬åœ°è®°å½•ï¼šè‹¥è¯¥ç‰©å“å½“å‰å·²è£…å¤‡ä¸”AIæœªæä¾›_opï¼Œåˆ™è§†ä¸ºè£…å¤‡æ¥æºï¼Œé¿å…å›ä»“é‡å¤
                        if (isEquipped && !incoming._op) {
                            continue;
                        }
                        gameState.variables.items.push({
                            name: incoming.name,
                            count: incoming._op === 'set' ? (incoming.count ?? 1) : (incoming.count ?? 1),
                            type: incoming.type,
                            effects: incoming.effects
                        });
                    }
                }
            }

            // æ›´æ–°åŠŸæ³•ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
            if (newVars.techniques) {
                const oldCount = gameState.variables.techniques ? gameState.variables.techniques.length : 0;
                const newCount = newVars.techniques.length;
                if (oldCount > 3 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ åŠŸæ³•æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                }
                gameState.variables.techniques = newVars.techniques;
            }

            // æ›´æ–°æ³•æœ¯ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
            if (newVars.spells) {
                const oldCount = gameState.variables.spells ? gameState.variables.spells.length : 0;
                const newCount = newVars.spells.length;
                if (oldCount > 3 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ æ³•æœ¯æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                }
                gameState.variables.spells = newVars.spells;
            }

            // æ›´æ–°äººé™…å…³ç³»ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
            if (newVars.relationships) {
                const oldCount = gameState.variables.relationships ? gameState.variables.relationships.length : 0;
                const newCount = newVars.relationships.length;
                if (oldCount > 3 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ äººé™…å…³ç³»æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                }
                gameState.variables.relationships = newVars.relationships;
            }

            // æ›´æ–°å†å²ï¼ˆè¿½åŠ æ¨¡å¼ - åªæ·»åŠ æ–°è®°å½•ï¼Œä¸åˆ é™¤æ—§è®°å½•ï¼‰
            if (newVars.history && Array.isArray(newVars.history)) {
                // ç¡®ä¿historyæ•°ç»„å­˜åœ¨
                if (!gameState.variables.history) {
                    gameState.variables.history = [];
                }
                
                // è¿½åŠ æ–°å†å²è®°å½•ï¼ˆå»é‡ï¼šé¿å…æ·»åŠ å®Œå…¨ç›¸åŒçš„è®°å½•ï¼‰
                newVars.history.forEach(newRecord => {
                    const trimmedNew = newRecord.trim();
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå†…å®¹ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼åæ¯”è¾ƒï¼‰
                    const isDuplicate = gameState.variables.history.some(existing => 
                        existing.trim() === trimmedNew
                    );
                    
                    if (!isDuplicate && trimmedNew) {
                        gameState.variables.history.push(newRecord);
                        console.log('[å†å²è®°å½•] æ–°å¢:', newRecord.substring(0, 50) + '...');
                    }
                });
            }

            // æ›´æ–°UI
            updateStatusPanel();

            // æ˜¾ç¤ºå±æ€§å˜åŒ–
            showAttributeChanges();
        }

        // æ›´æ–°çŠ¶æ€é¢æ¿
        function updateStatusPanel() {
            const vars = gameState.variables;

            // ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„æ¸²æŸ“å‡½æ•°
            if (window.XiuxianGameConfig && window.XiuxianGameConfig.renderStatus) {
                window.XiuxianGameConfig.renderStatus(vars);
                return;
            }

            // ä»¥ä¸‹æ˜¯å¤‡ç”¨æ¸²æŸ“ä»£ç ï¼ˆå¦‚æœé…ç½®æ–‡ä»¶æœªåŠ è½½ï¼‰

            // æ—¶é—´
            document.getElementById('currentDateTime').textContent = vars.currentDateTime || '-';

            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('charName').textContent = vars.name || 'æœªçŸ¥';
            document.getElementById('charAge').textContent = vars.age || '-';
            document.getElementById('charGender').textContent = vars.gender || '-';
            document.getElementById('charIdentity').textContent = vars.identity || '-';
            document.getElementById('charRealm').textContent = vars.realm || '-';
            document.getElementById('charLocation').textContent = vars.location || '-';
            document.getElementById('charTalents').textContent = vars.talents && vars.talents.length > 0 ? vars.talents.join('ã€') : '-';

            // è´§å¸
            document.getElementById('spiritStones').textContent = vars.spiritStones || 0;

            // ä½“åŠ›æ³•åŠ›
            const hp = vars.hp || 0;
            const hpMax = vars.hpMax || 100;
            const mp = vars.mp || 0;
            const mpMax = vars.mpMax || 100;
            document.getElementById('hp').textContent = `${hp}/${hpMax}`;
            document.getElementById('mp').textContent = `${mp}/${mpMax}`;

            // ç‰¹æ®Šå±æ€§
            document.getElementById('karmaFortune').textContent = vars.karmaFortune || 0;
            document.getElementById('karmaPunishment').textContent = vars.karmaPunishment || 0;
            const cultivationProgress = vars.cultivationProgress || 0;
            const cultivationProgressMax = vars.cultivationProgressMax || 100;
            document.getElementById('cultivationProgress').textContent = `${cultivationProgress}/${cultivationProgressMax}`;

            // ç‚¼ä¸¹ç‚¼å™¨ç­‰çº§
            const alchemyLevel = vars.alchemyLevel || "æœªå…¥é—¨";
            const craftingLevel = vars.craftingLevel || "æœªå…¥é—¨";
            
            // ç‚¼ä¸¹ç­‰çº§
            document.getElementById('alchemyLevel').textContent = alchemyLevel;
            
            // ç‚¼å™¨ç­‰çº§
            document.getElementById('craftingLevel').textContent = craftingLevel;

            // åŠ¿åŠ›ä¿¡æ¯
            const factionInfo = document.getElementById('factionInfo');
            if (vars.faction && vars.faction.name) {
                const faction = vars.faction;
                const membersText = faction.members && faction.members.length > 0
                    ? faction.members.join('ã€')
                    : 'æ— ';

                factionInfo.innerHTML = `
                    <div class="relationship-detail-row">
                        <span class="relationship-detail-label">åŠ¿åŠ›åï¼š</span>
                        <span class="relationship-detail-value">${faction.name}</span>
                    </div>
                    ${faction.leader ? `<div class="relationship-detail-row">
                        <span class="relationship-detail-label">é¢†è¢–ï¼š</span>
                        <span class="relationship-detail-value">${faction.leader}</span>
                    </div>` : ''}
                    ${faction.location ? `<div class="relationship-detail-row">
                        <span class="relationship-detail-label">æ‰€åœ¨åœ°ï¼š</span>
                        <span class="relationship-detail-value">${faction.location}</span>
                    </div>` : ''}
                    ${faction.members && faction.members.length > 0 ? `<div class="relationship-detail-row">
                        <span class="relationship-detail-label">ä¸»è¦æˆå‘˜ï¼š</span>
                        <span class="relationship-detail-value">${membersText}</span>
                    </div>` : ''}
                    ${faction.description ? `<div class="relationship-detail-row" style="flex-direction: column; align-items: flex-start;">
                        <span class="relationship-detail-label">ä»‹ç»ï¼š</span>
                        <span class="relationship-detail-value" style="margin-top: 5px; line-height: 1.6;">${faction.description}</span>
                    </div>` : ''}
                `;
            } else {
                factionInfo.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— åŠ¿åŠ›</div>';
            }

            // æ›´æ–°é›·è¾¾å›¾ï¼ˆé›·è¾¾å›¾å†…éƒ¨ä¼šè®¡ç®—å®é™…å±æ€§ï¼‰
            drawRadarChart();

            // è£…å¤‡æ 
            updateEquipmentDisplay();

            // åŠŸæ³•åˆ—è¡¨
            const techniquesList = document.getElementById('techniquesList');
            if (vars.techniques && vars.techniques.length > 0) {
                techniquesList.innerHTML = vars.techniques.map((tech, index) => {
                    return `<div class="item-entry" style="flex-direction: column; align-items: flex-start;">
                        <div style="width: 100%;">
                            <div style="font-weight: bold; color: #667eea;">${tech.name}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">${tech.description || ''}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 3px;">
                                å¨åŠ›: ${tech.power || 0} | æ¶ˆè€—æ³•åŠ›: ${tech.mpCost || 0}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                techniquesList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— åŠŸæ³•</div>';
            }

            // æ³•æœ¯åˆ—è¡¨
            const spellsList = document.getElementById('spellsList');
            if (vars.spells && vars.spells.length > 0) {
                spellsList.innerHTML = vars.spells.map((spell, index) => {
                    return `<div class="item-entry" style="flex-direction: column; align-items: flex-start;">
                        <div style="width: 100%;">
                            <div style="font-weight: bold; color: #764ba2;">${spell.name}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">${spell.description || ''}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 3px;">
                                å¨åŠ›: ${spell.power || 0} | æ¶ˆè€—æ³•åŠ›: ${spell.mpCost || 0}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                spellsList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— æ³•æœ¯</div>';
            }

            // é“å…·
            const itemsList = document.getElementById('itemsList');
            if (vars.items && vars.items.length > 0) {
                itemsList.innerHTML = vars.items.map((item, index) => {
                    const isEquipment = item.type && item.type.startsWith('è£…å¤‡-');
                    const isPill = item.type && (item.type.includes('ä¸¹è¯') || item.type.includes('ä¸¹'));
                    
                    const equipBtn = isEquipment ? `<button class="equip-btn" onclick="equipItem('${item.name}')">è£…å¤‡</button>` : '';
                    const usePillBtn = isPill ? `<button class="equip-btn" onclick="usePill(${index})" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">æœç”¨</button>` : '';
                    
                    const effectsText = item.effects ? Object.entries(item.effects).map(([attr, value]) => {
                        if (attr === 'cultivationProgress') {
                            return `ä¿®ç‚¼è¿›åº¦+${value}`;
                        } else if (attr === 'hp') {
                            return `ä½“åŠ›${value > 0 ? '+' : ''}${value}`;
                        } else if (attr === 'mp') {
                            return `æ³•åŠ›${value > 0 ? '+' : ''}${value}`;
                        } else if (attr === 'hpMax') {
                            return `ä½“åŠ›ä¸Šé™${value > 0 ? '+' : ''}${value}`;
                        } else if (attr === 'mpMax') {
                            return `æ³•åŠ›ä¸Šé™${value > 0 ? '+' : ''}${value}`;
                        }
                        return `${getAttributeName(attr)}${value > 0 ? '+' : ''}${value}`;
                    }).join(' ') : '';

                    return `<div class="item-entry">
                        <div>
                            <div>${item.name} x${item.count}</div>
                            <div style="font-size: 11px; color: #666;">${item.type || ''} ${effectsText}</div>
                        </div>
                        <div class="item-actions">
                            ${equipBtn}
                            ${usePillBtn}
                        </div>
                    </div>`;
                }).join('');
            } else {
                itemsList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— é“å…·</div>';
            }

            // äººé™…å…³ç³»
            const relationshipsList = document.getElementById('relationshipsList');
            if (vars.relationships && vars.relationships.length > 0) {
                relationshipsList.innerHTML = vars.relationships.map((rel, index) => {
                    // æ ¹æ®å¥½æ„Ÿåº¦è®¾ç½®é¢œè‰²ç±»
                    let favorClass = '';
                    if (rel.favor >= 60) {
                        favorClass = 'high';
                    } else if (rel.favor <= -30) {
                        favorClass = 'low';
                    }

                    // æ„å»ºå†å²äº’åŠ¨è®°å½•
                    let historyHtml = '';
                    if (rel.history && rel.history.length > 0) {
                        historyHtml = `
                            <div class="relationship-history">
                                <div class="relationship-history-title">ğŸ“œ å†å²äº’åŠ¨</div>
                                ${rel.history.map(h => `<div class="relationship-history-item">â€¢ ${h}</div>`).join('')}
                            </div>
                        `;
                    }

                    return `
                        <div class="relationship-card" onclick="toggleRelationshipDetails(${index})">
                            <div class="relationship-header">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <button class="equip-btn" onclick="event.stopPropagation(); deleteRelationship(${index})" 
                                        style="background: linear-gradient(135deg, #c85a54 0%, #a84842 100%); padding: 3px 8px;">
                                        ğŸ—‘ï¸
                                    </button>
                                    <span class="relationship-name">${rel.name} (${rel.relation})</span>
                                </div>
                                <span class="relationship-favor ${favorClass}">å¥½æ„Ÿ: ${rel.favor}</span>
                            </div>
                            <div class="relationship-details" id="relationship-details-${index}">
                                ${rel.age ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">å¹´é¾„ï¼š</span>
                                    <span class="relationship-detail-value">${rel.age}å²</span>
                                </div>` : ''}
                                ${rel.realm ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">å¢ƒç•Œï¼š</span>
                                    <span class="relationship-detail-value">${rel.realm}</span>
                                </div>` : ''}
                                ${rel.personality ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">æ€§æ ¼ï¼š</span>
                                    <span class="relationship-detail-value">${rel.personality}</span>
                                </div>` : ''}
                                ${rel.opinion ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">çœ‹æ³•ï¼š</span>
                                    <span class="relationship-detail-value">${rel.opinion}</span>
                                </div>` : ''}
                                ${rel.appearance ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">å¤–è²Œï¼š</span>
                                    <span class="relationship-detail-value">${rel.appearance}</span>
                                </div>` : ''}
                                ${rel.sexualPreference ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">æ€§ç™–ï¼š</span>
                                    <span class="relationship-detail-value">${rel.sexualPreference}</span>
                                </div>` : ''}
                                ${rel.isVirgin !== undefined ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">æ˜¯å¦ä¸ºå¤„ï¼š</span>
                                    <span class="relationship-detail-value">${rel.isVirgin ? 'æ˜¯' : 'å¦'}</span>
                                </div>` : ''}
                                ${rel.firstSex ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">é¦–æ¬¡æ€§çˆ±ï¼š</span>
                                    <span class="relationship-detail-value">${rel.firstSex}</span>
                                </div>` : ''}
                                ${rel.lastSex ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">æœ€è¿‘æ€§çˆ±ï¼š</span>
                                    <span class="relationship-detail-value">${rel.lastSex}</span>
                                </div>` : ''}
                                ${historyHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                relationshipsList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— å…³ç³»</div>';
            }

            // å†å²
            const historyList = document.getElementById('historyList');
            if (vars.history && vars.history.length > 0) {
                historyList.innerHTML = vars.history.map((event, index) =>
                    `<div style="margin-bottom: 5px;">â€¢ ${event}</div>`
                ).join('');
            } else {
                historyList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— å†å²</div>';
            }
        }


        // è®¡ç®—å®é™…å±æ€§ï¼ˆåŸºç¡€ + è£…å¤‡åŠ æˆï¼‰
        // è®¡ç®—å½“å‰å®é™…å±æ€§ï¼ˆåŒ…å«è£…å¤‡åŠ æˆï¼‰- å·²è¿ç§»åˆ° game-core-systems.js

        // ç»˜åˆ¶å…­ç»´å±æ€§é›·è¾¾å›¾
        function drawRadarChart() {
            const canvas = document.getElementById('radarChart');
            if (!canvas) return;

            // è®¾ç½® Canvas å“åº”å¼å°ºå¯¸
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            
            // åŠ¨æ€è®¡ç®—å°ºå¯¸ï¼Œè®¾ç½®æœ€å°å€¼200pxï¼Œæœ€å¤§å€¼300px
            let size = Math.max(Math.min(containerWidth - 20, 300), 200);
            
            // æ ¹æ®å°ºå¯¸åŠ¨æ€è°ƒæ•´æ ‡ç­¾ç•™ç™½ç©ºé—´
            let labelPadding = 40; // é»˜è®¤ç•™ç™½
            let fontSize = 12; // é»˜è®¤å­—ä½“å¤§å°
            let valueFontSize = 10; // æ•°å€¼å­—ä½“å¤§å°
            
            if (size < 220) {
                labelPadding = 30;
                fontSize = 10;
                valueFontSize = 9;
            } else if (size < 260) {
                labelPadding = 35;
                fontSize = 11;
                valueFontSize = 9;
            }
            
            // è®¾ç½® Canvas å®é™…åƒç´ å°ºå¯¸ï¼ˆé«˜åˆ†è¾¨ç‡æ”¯æŒï¼‰
            const dpr = window.devicePixelRatio || 1;
            canvas.width = size * dpr;
            canvas.height = size * dpr;
            
            // è®¾ç½® CSS æ˜¾ç¤ºå°ºå¯¸
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            // è·å–å®é™…å±æ€§å€¼
            const actualAttributes = calculateActualAttributes();
            
            // å…­ç»´å±æ€§é…ç½®
            const attributes = [
                { key: 'physique', label: 'æ ¹éª¨', value: actualAttributes.physique || 0 },
                { key: 'fortune', label: 'æ°”è¿', value: actualAttributes.fortune || 0 },
                { key: 'comprehension', label: 'æ‚Ÿæ€§', value: actualAttributes.comprehension || 0 },
                { key: 'spirit', label: 'ç¥è¯†', value: actualAttributes.spirit || 0 },
                { key: 'potential', label: 'æ½œåŠ›', value: actualAttributes.potential || 0 },
                { key: 'charisma', label: 'é­…åŠ›', value: actualAttributes.charisma || 0 }
            ];

            // è®¡ç®—æœ€å¤§å€¼ï¼ˆç”¨äºç¼©æ”¾ï¼‰
            const maxValue = Math.max(...attributes.map(a => a.value), 100);
            const levels = 5; // 5ä¸ªå±‚çº§
            const center = size / 2;
            const radius = size / 2 - labelPadding; // åŠ¨æ€è°ƒæ•´æ ‡ç­¾ç©ºé—´

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, size, size);

            // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
            ctx.strokeStyle = 'rgba(139, 69, 19, 0.2)';
            ctx.fillStyle = 'rgba(139, 69, 19, 0.05)';
            
            for (let i = levels; i > 0; i--) {
                ctx.beginPath();
                const r = (radius / levels) * i;
                
                for (let j = 0; j < 6; j++) {
                    const angle = (Math.PI * 2 / 6) * j - Math.PI / 2;
                    const x = center + r * Math.cos(angle);
                    const y = center + r * Math.sin(angle);
                    
                    if (j === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }

            // ç»˜åˆ¶åˆ†éš”çº¿
            ctx.strokeStyle = 'rgba(139, 69, 19, 0.3)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI * 2 / 6) * i - Math.PI / 2;
                const x = center + radius * Math.cos(angle);
                const y = center + radius * Math.sin(angle);
                
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            // ç»˜åˆ¶å±æ€§æ•°æ®åŒºåŸŸ
            ctx.fillStyle = 'rgba(139, 69, 19, 0.3)';
            ctx.strokeStyle = 'rgba(139, 69, 19, 0.8)';
            ctx.lineWidth = 2;
            ctx.beginPath();

            attributes.forEach((attr, index) => {
                const angle = (Math.PI * 2 / 6) * index - Math.PI / 2;
                const valueRadius = (attr.value / maxValue) * radius;
                const x = center + valueRadius * Math.cos(angle);
                const y = center + valueRadius * Math.sin(angle);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ç»˜åˆ¶æ•°æ®ç‚¹
            ctx.fillStyle = 'rgba(139, 69, 19, 0.9)';
            attributes.forEach((attr, index) => {
                const angle = (Math.PI * 2 / 6) * index - Math.PI / 2;
                const valueRadius = (attr.value / maxValue) * radius;
                const x = center + valueRadius * Math.cos(angle);
                const y = center + valueRadius * Math.sin(angle);
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });

            // ç»˜åˆ¶å±æ€§æ ‡ç­¾å’Œæ•°å€¼
            ctx.fillStyle = '#8b4513';
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            attributes.forEach((attr, index) => {
                const angle = (Math.PI * 2 / 6) * index - Math.PI / 2;
                const labelRadius = radius + (labelPadding * 0.75); // æ ‡ç­¾è·ç¦»ç¨å¾®è°ƒæ•´
                let x = center + labelRadius * Math.cos(angle);
                let y = center + labelRadius * Math.sin(angle);
                
                // è°ƒæ•´æ–‡æœ¬å¯¹é½æ–¹å¼
                if (Math.abs(angle) < 0.1) {
                    ctx.textAlign = 'center';
                } else if (Math.cos(angle) > 0) {
                    ctx.textAlign = 'left';
                } else {
                    ctx.textAlign = 'right';
                }
                
                // ç»˜åˆ¶æ ‡ç­¾
                ctx.fillText(attr.label, x, y - (fontSize * 0.6));
                
                // ç»˜åˆ¶æ•°å€¼
                ctx.font = `${valueFontSize}px Arial`;
                ctx.fillStyle = '#666';
                ctx.fillText(attr.value.toString(), x, y + (valueFontSize * 0.5));
                
                // æ¢å¤å­—ä½“
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.fillStyle = '#8b4513';
            });
        }

        // æ›´æ–°è£…å¤‡æ˜¾ç¤º
        function updateEquipmentDisplay() {
            const equipment = gameState.variables.equipment;

            document.getElementById('equipHead').textContent = equipment.head ? equipment.head.name : 'ç©º';
            document.getElementById('equipClothes').textContent = equipment.clothes ? equipment.clothes.name : 'ç©º';
            document.getElementById('equipFeet').textContent = equipment.feet ? equipment.feet.name : 'ç©º';
            document.getElementById('equipTreasure1').textContent = equipment.treasure1 ? equipment.treasure1.name : 'ç©º';
            document.getElementById('equipTreasure2').textContent = equipment.treasure2 ? equipment.treasure2.name : 'ç©º';
            document.getElementById('equipTreasure3').textContent = equipment.treasure3 ? equipment.treasure3.name : 'ç©º';
        }

        // è£…å¤‡é“å…·
        function equipItem(itemName) {
            const item = gameState.variables.items.find(i => i.name === itemName);
            if (!item || !item.type || !item.type.startsWith('è£…å¤‡-')) {
                alert('è¯¥ç‰©å“ä¸èƒ½è£…å¤‡');
                return;
            }

            let equipSlot = null;
            switch (item.type) {
                case 'è£…å¤‡-å¤´éƒ¨':
                    equipSlot = 'head';
                    break;
                case 'è£…å¤‡-è¡£æœ':
                    equipSlot = 'clothes';
                    break;
                case 'è£…å¤‡-è„šéƒ¨':
                    equipSlot = 'feet';
                    break;
                case 'è£…å¤‡-æ³•å®':
                    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºçš„æ³•å®ä½
                    if (!gameState.variables.equipment.treasure1) {
                        equipSlot = 'treasure1';
                    } else if (!gameState.variables.equipment.treasure2) {
                        equipSlot = 'treasure2';
                    } else if (!gameState.variables.equipment.treasure3) {
                        equipSlot = 'treasure3';
                    } else {
                        alert('æ³•å®ä½å·²æ»¡ï¼Œè¯·å…ˆå¸ä¸‹ä¸€ä¸ªæ³•å®');
                        return;
                    }
                    break;
                default:
                    alert('æœªçŸ¥çš„è£…å¤‡ç±»å‹');
                    return;
            }

            // å¸ä¸‹åŸæœ‰è£…å¤‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (gameState.variables.equipment[equipSlot]) {
                const oldItem = gameState.variables.equipment[equipSlot];
                // å°†æ—§è£…å¤‡æ”¾å›èƒŒåŒ…
                const existingItem = gameState.variables.items.find(i => i.name === oldItem.name);
                if (existingItem) {
                    existingItem.count++;
                } else {
                    gameState.variables.items.push({
                        name: oldItem.name,
                        count: 1,
                        type: oldItem.type || 'è£…å¤‡-æœªçŸ¥',
                        effects: oldItem.effects
                    });
                }
            }

            // è£…å¤‡æ–°ç‰©å“
            gameState.variables.equipment[equipSlot] = {
                name: item.name,
                type: item.type,
                effects: item.effects || {}
            };

            // ä»èƒŒåŒ…ä¸­ç§»é™¤ä¸€ä¸ª
            item.count--;
            if (item.count <= 0) {
                const index = gameState.variables.items.indexOf(item);
                gameState.variables.items.splice(index, 1);
            }

            // ğŸ†• è®°å½•è£…å¤‡æ“ä½œåˆ°ç¼“å­˜ï¼ˆåªè®°å½•æœ€åè£…å¤‡çš„ï¼‰
            gameState.pendingActions.equipment = item.name;

            // æ›´æ–°UI
            updateStatusPanel();

            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));
        }

        // å¸ä¸‹è£…å¤‡
        function unequipItem(slot) {
            const equipment = gameState.variables.equipment[slot];
            if (!equipment) {
                return; // æ²¡æœ‰è£…å¤‡ï¼Œä¸åšä»»ä½•æ“ä½œ
            }

            // å°†è£…å¤‡æ”¾å›èƒŒåŒ…
            const existingItem = gameState.variables.items.find(i => i.name === equipment.name);
            if (existingItem) {
                existingItem.count++;
            } else {
                gameState.variables.items.push({
                    name: equipment.name,
                    count: 1,
                    type: equipment.type || 'è£…å¤‡-æœªçŸ¥',
                    effects: equipment.effects
                });
            }

            // æ¸…ç©ºè£…å¤‡æ 
            gameState.variables.equipment[slot] = null;

            // æ›´æ–°UI
            updateStatusPanel();

            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));
        }

        // æœç”¨ä¸¹è¯
        function usePill(itemIndex) {
            const item = gameState.variables.items[itemIndex];
            if (!item || !item.type || !(item.type.includes('ä¸¹è¯') || item.type.includes('ä¸¹'))) {
                alert('è¯¥ç‰©å“ä¸æ˜¯ä¸¹è¯');
                return;
            }

            if (item.count <= 0) {
                alert('ä¸¹è¯æ•°é‡ä¸è¶³');
                return;
            }

            // åº”ç”¨ä¸¹è¯æ•ˆæœ
            if (item.effects) {
                let effectMessages = [];

                Object.entries(item.effects).forEach(([attr, value]) => {
                    if (attr === 'cultivationProgress') {
                        // å¢åŠ ä¿®ç‚¼è¿›åº¦
                        gameState.variables.cultivationProgress = (gameState.variables.cultivationProgress || 0) + value;
                        effectMessages.push(`ä¿®ç‚¼è¿›åº¦+${value}`);

                        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°çªç ´æ¡ä»¶
                        if (gameState.variables.cultivationProgress >= gameState.variables.cultivationProgressMax) {
                            effectMessages.push('å·²è¾¾åˆ°çªç ´æ¡ä»¶ï¼è¯·åœ¨å‰§æƒ…ä¸­é€‰æ‹©çªç ´é€‰é¡¹');
                        }
                    } else if (attr === 'hp') {
                        // æ¢å¤ä½“åŠ›
                        gameState.variables.hp = Math.min(
                            (gameState.variables.hp || 0) + value,
                            gameState.variables.hpMax || 100
                        );
                        effectMessages.push(`ä½“åŠ›+${value}`);
                    } else if (attr === 'mp') {
                        // æ¢å¤æ³•åŠ›
                        gameState.variables.mp = Math.min(
                            (gameState.variables.mp || 0) + value,
                            gameState.variables.mpMax || 100
                        );
                        effectMessages.push(`æ³•åŠ›+${value}`);
                    } else if (attr === 'hpMax') {
                        // å¢åŠ ä½“åŠ›ä¸Šé™
                        gameState.variables.hpMax = (gameState.variables.hpMax || 100) + value;
                        effectMessages.push(`ä½“åŠ›ä¸Šé™+${value}`);
                    } else if (attr === 'mpMax') {
                        // å¢åŠ æ³•åŠ›ä¸Šé™
                        gameState.variables.mpMax = (gameState.variables.mpMax || 100) + value;
                        effectMessages.push(`æ³•åŠ›ä¸Šé™+${value}`);
                    } else if (gameState.variables.attributes && attr in gameState.variables.attributes) {
                        // å¢åŠ å±æ€§
                        gameState.variables.attributes[attr] = (gameState.variables.attributes[attr] || 0) + value;
                        effectMessages.push(`${getAttributeName(attr)}+${value}`);
                    }
                });

                // å‡å°‘ä¸¹è¯æ•°é‡
                item.count--;
                if (item.count <= 0) {
                    gameState.variables.items.splice(itemIndex, 1);
                }

                // ğŸ†• è®°å½•æœç”¨ä¸¹è¯åˆ°ç¼“å­˜ï¼ˆç´¯åŠ æ•°é‡ï¼‰
                if (!gameState.pendingActions.pills[item.name]) {
                    gameState.pendingActions.pills[item.name] = 0;
                }
                gameState.pendingActions.pills[item.name]++;

                // æ›´æ–°UI
                updateStatusPanel();

                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));

                // æ˜¾ç¤ºæ•ˆæœæç¤º
                alert(`æœç”¨${item.name}æˆåŠŸï¼\n${effectMessages.join('\n')}`);
            } else {
                alert('è¯¥ä¸¹è¯æ²¡æœ‰æ•ˆæœ');
            }
        }

        // åˆ é™¤äººé™…å…³ç³»
        function deleteRelationship(relIndex) {
            const relationship = gameState.variables.relationships[relIndex];
            if (!relationship) {
                alert('è¯¥äººé™…å…³ç³»ä¸å­˜åœ¨');
                return;
            }

            // ç¡®è®¤åˆ é™¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¸"${relationship.name}"çš„å…³ç³»å—ï¼Ÿ\n\nå…³ç³»ï¼š${relationship.relation}\nå¥½æ„Ÿåº¦ï¼š${relationship.favor}`)) {
                return;
            }

            // ä»æ•°ç»„ä¸­åˆ é™¤
            gameState.variables.relationships.splice(relIndex, 1);

            // æ›´æ–°UI
            updateStatusPanel();

            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));

            // æ˜¾ç¤ºæç¤º
            alert(`å·²åˆ é™¤ä¸"${relationship.name}"çš„å…³ç³»ï¼`);
        }

        // ==================== ç™¾è‰ºæ¨¡å—ç›¸å…³å‡½æ•° ====================

        // ç™¾è‰ºé€‰æ‹©çš„ææ–™çŠ¶æ€
        const baiyiState = {
            selectedMaterials: {} // { materialName: count }
        };

        // æ›´æ–°ç™¾è‰ºææ–™åˆ—è¡¨
        function updateBaiyiMaterialsList() {
            const materialsList = document.getElementById('materialsList');
            const items = gameState.variables.items || [];

            // æ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„é“å…·ï¼ˆä¸ä»…ä»…æ˜¯ææ–™ï¼‰
            const allItems = items;

            if (allItems.length === 0) {
                materialsList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— é“å…·</div>';
                return;
            }

            // æŒ‰ç±»å‹åˆ†ç»„é“å…·
            const itemsByType = {};
            allItems.forEach(item => {
                const type = item.type || 'æ‚ç‰©';
                if (!itemsByType[type]) {
                    itemsByType[type] = [];
                }
                itemsByType[type].push(item);
            });

            // æ„å»ºHTMLæ˜¾ç¤º
            let html = '';
            Object.keys(itemsByType).sort().forEach(type => {
                html += `<div class="material-category" style="margin-bottom: 15px;">
                    <h4 style="color: #667eea; margin-bottom: 8px; font-size: 14px; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px;">ğŸ“¦ ${type}</h4>`;
                
                itemsByType[type].forEach(item => {
                    const selectedCount = baiyiState.selectedMaterials[item.name] || 0;
                    const availableCount = item.count - selectedCount;

                    html += `
                        <div class="material-item" style="margin-left: 10px;">
                            <div class="material-info">
                                <div class="material-name">${item.name}</div>
                                <div class="material-count">æ‹¥æœ‰: ${item.count} | å¯ç”¨: ${availableCount}</div>
                            </div>
                            <div class="material-controls">
                                <button class="material-btn" onclick="decreaseMaterial('${item.name}')" ${selectedCount === 0 ? 'disabled' : ''}>âˆ’</button>
                                <div class="material-selected-count">${selectedCount}</div>
                                <button class="material-btn" onclick="increaseMaterial('${item.name}')" ${availableCount === 0 ? 'disabled' : ''}>+</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });

            materialsList.innerHTML = html;

            // æ›´æ–°å·²é€‰ææ–™åˆ—è¡¨
            updateSelectedMaterialsList();
        }

        // å¢åŠ ææ–™é€‰æ‹©æ•°é‡
        function increaseMaterial(materialName) {
            const material = gameState.variables.items.find(item => item.name === materialName);
            if (!material) return;

            const selectedCount = baiyiState.selectedMaterials[materialName] || 0;
            if (selectedCount < material.count) {
                baiyiState.selectedMaterials[materialName] = selectedCount + 1;
                updateBaiyiMaterialsList();
            }
        }

        // å‡å°‘ææ–™é€‰æ‹©æ•°é‡
        function decreaseMaterial(materialName) {
            const selectedCount = baiyiState.selectedMaterials[materialName] || 0;
            if (selectedCount > 0) {
                baiyiState.selectedMaterials[materialName] = selectedCount - 1;
                if (baiyiState.selectedMaterials[materialName] === 0) {
                    delete baiyiState.selectedMaterials[materialName];
                }
                updateBaiyiMaterialsList();
            }
        }

        // æ›´æ–°å·²é€‰ææ–™åˆ—è¡¨
        function updateSelectedMaterialsList() {
            const selectedMaterialsList = document.getElementById('selectedMaterialsList');
            const selectedNames = Object.keys(baiyiState.selectedMaterials);

            if (selectedNames.length === 0) {
                selectedMaterialsList.innerHTML = '<div style="text-align: center; color: #999;">æœªé€‰æ‹©ä»»ä½•ææ–™</div>';
                return;
            }

            selectedMaterialsList.innerHTML = selectedNames.map(name => {
                const count = baiyiState.selectedMaterials[name];
                return `
                    <div class="selected-material-item">
                        <span class="selected-material-name">${name}</span>
                        <span class="selected-material-count">Ã— ${count}</span>
                    </div>
                `;
            }).join('');
        }

        // æ¸…ç©ºé€‰æ‹©çš„ææ–™
        function clearSelectedMaterials() {
            baiyiState.selectedMaterials = {};
            updateBaiyiMaterialsList();
        }

        // æ‰§è¡Œç‚¼åˆ¶æ“ä½œï¼ˆç‚¼ä¸¹æˆ–ç‚¼å™¨ï¼‰
        async function performCrafting(craftingType) {
            const selectedNames = Object.keys(baiyiState.selectedMaterials);

            if (selectedNames.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ææ–™ï¼');
                return;
            }

            // æ„å»ºææ–™æè¿°
            const materialsDesc = selectedNames.map(name => {
                const count = baiyiState.selectedMaterials[name];
                return `${count}ä¸ª${name}`;
            }).join('å’Œ');

            // æ„å»ºç‚¼åˆ¶æ¶ˆæ¯
            const craftingMessage = `å¼€å§‹${craftingType}ï¼Œä½¿ç”¨ææ–™ï¼š${materialsDesc}`;

            // æ‰£é™¤ææ–™æ•°é‡
            selectedNames.forEach(name => {
                const count = baiyiState.selectedMaterials[name];
                const material = gameState.variables.items.find(item => item.name === name);
                if (material) {
                    material.count -= count;
                    if (material.count <= 0) {
                        const index = gameState.variables.items.indexOf(material);
                        gameState.variables.items.splice(index, 1);
                    }
                }
            });

            // æ¸…ç©ºé€‰æ‹©çš„ææ–™
            baiyiState.selectedMaterials = {};

            // æ›´æ–°UI
            updateStatusPanel();

            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            await saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));

            // å‘é€ç‚¼åˆ¶æ¶ˆæ¯ç»™AI
            if (!gameState.isProcessing) {
                // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
                displayUserMessage(craftingMessage);

                // æ·»åŠ åˆ°å†å²è®°å½•
                gameState.conversationHistory.push({
                    role: 'user',
                    content: craftingMessage
                });

                // ä¿å­˜å½“å‰å˜é‡å¿«ç…§ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰
                gameState.variableSnapshots.push(JSON.parse(JSON.stringify(gameState.variables)));

                gameState.isProcessing = true;

                try {
                    // æ„å»ºå¢å¼ºæç¤º
                    const enhancedInput = buildEnhancedPrompt(craftingMessage);

                    // è°ƒç”¨AI
                    const response = await callAI(enhancedInput, false, craftingMessage);

                    // å¤„ç†AIå“åº”
                    handleAIResponse(response);

                    // è§¦å‘åŠ¨æ€ä¸–ç•Œç”Ÿæˆï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                    generateDynamicWorld().catch(err => console.error('[åŠ¨æ€ä¸–ç•Œ] ç”Ÿæˆå¼‚å¸¸:', err));

                } catch (error) {
                    console.error('[ç‚¼åˆ¶] AIè°ƒç”¨å¤±è´¥:', error);
                    displayErrorMessage('ç‚¼åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
                    gameState.isProcessing = false;
                }
            }
        }

        // è·å–å±æ€§ä¸­æ–‡å
        function getAttributeName(attr) {
            const names = {
                physique: 'æ ¹éª¨',
                fortune: 'æ°”è¿',
                comprehension: 'æ‚Ÿæ€§',
                spirit: 'ç¥è¯†',
                potential: 'æ½œåŠ›',
                charisma: 'é­…åŠ›',
                karmaFortune: 'æœºç¼˜å€¼',
                karmaPunishment: 'å¤©è°´å€¼'
            };
            return names[attr] || attr;
        }

        // è§£æé€‰é¡¹ä¸­çš„å±æ€§è¦æ±‚
        // æ ¼å¼ï¼šé€‰é¡¹æ–‡æœ¬ï¼ˆå±æ€§>æ•°å€¼ï¼‰æˆ– é€‰é¡¹æ–‡æœ¬ï¼ˆå±æ€§å>æ•°å€¼ï¼‰
        // ä»¥ä¸‹å‡½æ•°å·²è¿ç§»åˆ° game-core-systems.js:
        // - parseAttributeRequirement
        // - checkAttributeRequirement
        // - showAttributeChanges
        // - calculateActualAttributesFor
        // - showChange
        // - calculateActualAttributes

        // æ£€æŸ¥å±æ€§æ˜¯å¦æ»¡è¶³è¦æ±‚ - å·²è¿ç§»åˆ° game-core-systems.js

        // æ˜¾ç¤ºå±æ€§å˜åŒ– - å·²è¿ç§»åˆ° game-core-systems.js

        // è®¡ç®—æŒ‡å®šçŠ¶æ€çš„å®é™…å±æ€§ - å·²è¿ç§»åˆ° game-core-systems.js

        // æ˜¾ç¤ºå•ä¸ªå±æ€§å˜åŒ– - å·²è¿ç§»åˆ° game-core-systems.js

        // ==================== æ¶ˆæ¯ç®¡ç†ç³»ç»Ÿ ====================
        // toggleDeleteMode, confirmDelete, cancelDelete å·²è¿ç§»åˆ° game-core-systems.js
        
        // å¤„ç†æ¶ˆæ¯å‹¾é€‰ï¼ˆè‡ªåŠ¨é€‰ä¸­ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼‰- ä¿ç•™åœ¨game.htmlä¸­
        function handleMessageCheck(messageDiv) {
            const checkbox = messageDiv.querySelector('.message-checkbox');
            const allMessages = Array.from(document.querySelectorAll('.message'));
            const currentIndex = allMessages.indexOf(messageDiv);

            if (checkbox.checked) {
                // å‹¾é€‰å½“å‰æ¶ˆæ¯ï¼Œè‡ªåŠ¨å‹¾é€‰ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
                for (let i = currentIndex; i < allMessages.length; i++) {
                    const msg = allMessages[i];
                    const cb = msg.querySelector('.message-checkbox');
                    if (cb) {
                        cb.checked = true;
                        msg.classList.add('selected-for-delete');
                    }
                }
            } else {
                // å–æ¶ˆå‹¾é€‰å½“å‰æ¶ˆæ¯ï¼Œè‡ªåŠ¨å–æ¶ˆä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯
                for (let i = 0; i <= currentIndex; i++) {
                    const msg = allMessages[i];
                    const cb = msg.querySelector('.message-checkbox');
                    if (cb) {
                        cb.checked = false;
                        msg.classList.remove('selected-for-delete');
                    }
                }
            }
        }

        // ğŸ¯ ç»Ÿä¸€æ„å»ºå¢å¼ºæç¤ºçš„å‡½æ•°
        function buildEnhancedPrompt(userMessage, options = {}) {
            // è·å–é…ç½®
            const saved = localStorage.getItem('gameConfig');
            const config = saved ? JSON.parse(saved) : {};

            // ğŸ†• æ˜ç¡®æ ‡è¯†è¿™æ˜¯ç”¨æˆ·çš„è¦æ±‚
            let enhancedPrompt = `ã€åç»­æƒ…èŠ‚ã€‘${userMessage}`;

            // 1. æ ¹æ®æœºç¼˜å€¼å’Œå¤©è°´å€¼æ·»åŠ æç¤º
            if (gameState.variables.karmaFortune >= 80) {
                enhancedPrompt += '\n\n[æœºç¼˜é«˜â†’å¥½å‰§æƒ…]';
            } else if (gameState.variables.karmaPunishment >= 80) {
                enhancedPrompt += '\n\n[å¤©è°´é«˜â†’åå‰§æƒ…]';
            }

            // 2. è·å–æœ€å°å­—æ•°è¦æ±‚
            const minWordCount = config.minWordCount || 0;

            // 3. å¦‚æœæ˜¯é€‰é¡¹æ¨¡å¼ï¼Œæ·»åŠ å±æ€§åˆ¤å®šç»“æœ
            if (options.attributeCheck) {
                const { requirement, checkResult } = options.attributeCheck;
                if (requirement.hasRequirement) {
                    if (checkResult.met) {
                        enhancedPrompt += `\n\n[åˆ¤å®šé€šè¿‡ï¼š${checkResult.attributeName}${checkResult.currentValue}${requirement.operator}${checkResult.requiredValue}â†’æˆåŠŸå‰§æƒ…]`;
                    } else {
                        enhancedPrompt += `\n\n[åˆ¤å®šå¤±è´¥ï¼š${checkResult.attributeName}${checkResult.currentValue}ä¸è¶³${checkResult.requiredValue}â†’å¤±è´¥å‰§æƒ…]`;
                    }
                }
            }

            // 4. å¼ºåˆ¶è¦æ±‚æ›´æ–°å˜é‡å’Œç”Ÿæˆé€‰é¡¹
            enhancedPrompt += '\n\n[å¿…é¡»è¿”å›4é€‰é¡¹(å«å±æ€§åˆ¤å®š)ï¼Œé¡ºåºï¼š1.å¯¹è¯ 2.ç¦»å¼€ 3.è¡ŒåŠ¨ 4.R18]';

            // 5. æ·»åŠ æœ€å°å­—æ•°è¦æ±‚
            if (minWordCount > 0) {
                enhancedPrompt += `\n\n[storyâ‰¥${minWordCount}å­—]`;
            }

            // 6. æ€§çˆ±åœºæ™¯æå†™è¦æ±‚
            enhancedPrompt += '\n\n[R18åœºæ™¯è¯¦å†™è¿‡ç¨‹ï¼Œè¯­è¨€åŠ¨ä½œè¡¨æƒ…å¤šæ–¹é¢æå†™ï¼Œä¸å‡†ä¸»åŠ¨ç»“æŸæ€§çˆ±åœºæ™¯ï¼Œéœ€è¦ç©å®¶ä¸»åŠ¨ç»“æŸ]';

            // 8. äººé™…å…³ç³»æé†’ï¼ˆv3.1æ ¼å¼ï¼‰
            enhancedPrompt += '\n\n[NPCäº’åŠ¨åœ¨variableUpdateä¸­æ›´æ–°ï¼šrelationships.NPCåå­—={favor:æ•°å€¼,opinion:"è¯„ä»·",history:["äº‹ä»¶"]}ã€‚R18å¿…æ›´æ–°ï¼šisVirgin/firstSex/lastSex/sexualPreference/appearance]';

            // 9. å˜é‡æ›´æ–°è¯´æ˜ï¼ˆv3.1æ ¼å¼ï¼‰
            enhancedPrompt += '\n\n[ä½¿ç”¨variableUpdateå­—æ®µï¼Œæ ¼å¼ï¼š{"å±æ€§è·¯å¾„":å€¼}ã€‚ä¾‹ï¼š{"hp":100,"items.çµçŸ³":50,"relationships.æŸ³å¦‚çƒŸ.favor":80}]';

            // 10. å†å²è®°å½•è¦æ±‚
            enhancedPrompt += '\n\n[historyè¿”å›1æ¡â‰¥40å­—ã€‚]';

            // 12. ç‚¼ä¸¹ç‚¼å™¨ç­‰çº§æç¤º
            const alchemyLevel = gameState.variables.alchemyLevel || "æœªå…¥é—¨";
            const craftingLevel = gameState.variables.craftingLevel || "æœªå…¥é—¨";
            
            // ç‚¼ä¸¹ç­‰çº§æç¤º
            if (alchemyLevel !== "æœªå…¥é—¨") {
                enhancedPrompt += `\n\n[å½“å‰ç‚¼ä¸¹ç­‰çº§ï¼š${alchemyLevel}ï¼Œæ ¹æ®ç­‰çº§åˆ¤æ–­æˆåŠŸç‡å’Œä¸¹è¯å“è´¨]`;
            }
            
            // ç‚¼å™¨ç­‰çº§æç¤º
            if (craftingLevel !== "æœªå…¥é—¨") {
                enhancedPrompt += `\n\n[å½“å‰ç‚¼å™¨ç­‰çº§ï¼š${craftingLevel}ï¼Œæ ¹æ®ç­‰çº§åˆ¤æ–­æˆåŠŸç‡å’Œæ³•å®å“è´¨]`;
            }

            // 13. æ·»åŠ æœ¬åœ°æ“ä½œæ‘˜è¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const hasLocalOps = gameState.localOps && (
                (gameState.localOps.items && gameState.localOps.items.length > 0) ||
                (gameState.localOps.attrs && gameState.localOps.attrs.length > 0) ||
                (gameState.localOps.equip && gameState.localOps.equip.length > 0)
            );
            
            if (hasLocalOps) {
                const localOpsSummary = {
                    items: gameState.localOps.items || [],
                    attrs: gameState.localOps.attrs || [],
                    equip: gameState.localOps.equip || []
                };
                enhancedPrompt += '\n\n[æœ¬åœ°æ“ä½œè®°å½•]' + JSON.stringify(localOpsSummary);
            }

            return enhancedPrompt;
        }

        // å‘é€ç”¨æˆ·è‡ªå®šä¹‰è¾“å…¥
        async function sendUserInput() {
            const inputBox = document.getElementById('userInput');
            let userText = inputBox.value.trim();

            if (!userText) {
                alert('è¯·è¾“å…¥å†…å®¹ï¼');
                return;
            }

            if (gameState.isProcessing) return;

            if (!gameState.isGameStarted) {
                alert('è¯·å…ˆåˆ›å»ºè§’è‰²å¹¶å¼€å§‹æ¸¸æˆï¼');
                return;
            }

            // ğŸ†• è‡ªåŠ¨é™„åŠ æ“ä½œç¼“å­˜
            const actionsSummary = getPendingActionsSummary();
            if (actionsSummary) {
                userText = actionsSummary + userText;
            }

            // ğŸ†• åœ¨æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´çš„ç”¨æˆ·è¾“å…¥
            console.log('ğŸ“¤ [ç”¨æˆ·è¾“å…¥]', userText);

            // æ¸…ç©ºè¾“å…¥æ¡†
            inputBox.value = '';

            gameState.isProcessing = true;

            // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
            displayUserMessage(userText);

            // æ·»åŠ åˆ°å†å²è®°å½•
            gameState.conversationHistory.push({
                role: 'user',
                content: userText
            });

            // ä¿å­˜å½“å‰å˜é‡å¿«ç…§ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰
            gameState.variableSnapshots.push(JSON.parse(JSON.stringify(gameState.variables)));

            // ğŸ†• æ¸…ç©ºæ“ä½œç¼“å­˜
            clearPendingActions();

            // ä¿å­˜æ¸¸æˆå†å²
            saveGameHistory().catch(err => console.error('ä¿å­˜å†å²å¤±è´¥:', err));

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const historyDiv = document.getElementById('gameHistory');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai-message';
            loadingDiv.innerHTML = '<div class="message-content"><span class="loading"></span> AIæ€è€ƒä¸­...</div>';
            loadingDiv.id = 'loading-message';
            historyDiv.appendChild(loadingDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            try {
                // ğŸ¯ ä½¿ç”¨ç»Ÿä¸€å‡½æ•°æ„å»ºå¢å¼ºæç¤º
                const enhancedInput = buildEnhancedPrompt(userText);

                // ğŸ†• åœ¨æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´çš„å¢å¼ºæç¤º
                console.log('ğŸ¤– [å‘é€ç»™AIçš„å®Œæ•´Prompt]', enhancedInput);

                // ğŸ”§ ä¼ å…¥åŸå§‹ç”¨æˆ·è¾“å…¥ï¼ˆç”¨äºå‘é‡æ£€ç´¢ï¼‰
                const response = await callAI(enhancedInput, false, userText);

                // ç§»é™¤åŠ è½½æç¤º
                const loading = document.getElementById('loading-message');
                if (loading) loading.remove();

                handleAIResponse(response);

                // è§¦å‘åŠ¨æ€ä¸–ç•Œç”Ÿæˆï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                generateDynamicWorld().catch(err => console.error('[åŠ¨æ€ä¸–ç•Œ] ç”Ÿæˆå¼‚å¸¸:', err));

            } catch (error) {
                // ç§»é™¤åŠ è½½æç¤º
                const loading = document.getElementById('loading-message');
                if (loading) loading.remove();

                // âŒ ä¸è¦ç§»é™¤ç”¨æˆ·æ¶ˆæ¯ï¼æ˜¾ç¤ºé”™è¯¯å’Œé‡è¯•æŒ‰é’®
                displayErrorMessageWithRetry('AIå“åº”å¤±è´¥ï¼š' + error.message, async () => {
                    // ç§»é™¤é”™è¯¯æ¶ˆæ¯
                    const errorDiv = document.getElementById('error-message-with-retry');
                    if (errorDiv) errorDiv.remove();
                    
                    // é‡æ–°ç”Ÿæˆæœ€åçš„å“åº”
                    await regenerateLastResponse();
                });
            }

            gameState.isProcessing = false;
        }

        // è§£æAIæä¾›çš„æˆ˜æ–—ä¿¡æ¯
        function parseCombatInfo(story) {
            console.log('ğŸ” è§£ææˆ˜æ–—ä¿¡æ¯ä»æ•…äº‹ä¸­...');
            
            // æŸ¥æ‰¾æˆ˜æ–—ä¿¡æ¯å— - æ”¯æŒä¸¤ç§æ ‡è®°
            const combatStartMarkers = ['===æˆ˜æ–—å¼€å§‹===', '===æˆ˜æ–—ä¿¡æ¯==='];
            const combatEndMarkers = ['===æˆ˜æ–—å¼€å§‹===', '===æˆ˜æ–—ä¿¡æ¯==='];
            
            let startIndex = -1;
            let endIndex = -1;
            let usedMarker = '';
            
            // å°è¯•å„ç§æ ‡è®°ç»„åˆ
            for (let i = 0; i < combatStartMarkers.length; i++) {
                startIndex = story.indexOf(combatStartMarkers[i]);
                if (startIndex !== -1) {
                    // æŸ¥æ‰¾å¯¹åº”çš„ç»“æŸæ ‡è®°
                    endIndex = story.indexOf(combatEndMarkers[i], startIndex + combatStartMarkers[i].length);
                    if (endIndex !== -1) {
                        usedMarker = combatStartMarkers[i];
                        break;
                    }
                }
            }
            
            if (startIndex === -1) {
                console.log('âŒ æœªæ‰¾åˆ°æˆ˜æ–—å¼€å§‹æ ‡è®°');
                return null;
            }
            
            if (endIndex === -1) {
                console.log('âŒ æœªæ‰¾åˆ°æˆ˜æ–—ç»“æŸæ ‡è®°');
                return null;
            }
            
            // æå–æˆ˜æ–—ä¿¡æ¯å—
            const combatBlock = story.substring(startIndex, endIndex + usedMarker.length);
            console.log('ğŸ“‹ æ‰¾åˆ°æˆ˜æ–—ä¿¡æ¯å—ï¼ˆä½¿ç”¨æ ‡è®°:', usedMarker + 'ï¼‰:', combatBlock);
            
            // æ£€æŸ¥æè¿°æ–‡æœ¬ä¸­çš„å¢ƒç•Œä¿¡æ¯ï¼Œç”¨äºä¿®æ­£ä¸ä¸€è‡´
            let describedRealm = null;
            let describedRealmLevel = null;
            
            // æŸ¥æ‰¾æˆ˜æ–—ä¿¡æ¯å—ä¹‹å‰çš„æè¿°æ–‡æœ¬ä¸­çš„å¢ƒç•Œä¿¡æ¯
            const beforeCombat = story.substring(0, startIndex);
            const realmInDescription = beforeCombat.match(/ï¼ˆ(.+?æœŸ)ï¼‰|ï¼ˆ(.+?)ï¼‰/);
            if (realmInDescription) {
                const realmText = realmInDescription[1] || realmInDescription[2];
                // å¸¸è§å¢ƒç•Œæ˜ å°„
                const realmMap = {
                    'å‡¡äºº': 0,
                    'ç»ƒæ°”æœŸ': 1,
                    'ç­‘åŸºæœŸ': 2,
                    'é‡‘ä¸¹æœŸ': 3,
                    'å…ƒå©´æœŸ': 4,
                    'åŒ–ç¥æœŸ': 5,
                    'ç»ƒæ°”': 1,
                    'ç­‘åŸº': 2,
                    'é‡‘ä¸¹': 3,
                    'å…ƒå©´': 4,
                    'åŒ–ç¥': 5
                };
                
                for (const [realmName, level] of Object.entries(realmMap)) {
                    if (realmText.includes(realmName)) {
                        describedRealm = realmName;
                        describedRealmLevel = level;
                        console.log('ğŸ” åœ¨æè¿°ä¸­å‘ç°å¢ƒç•Œ:', describedRealm, 'ç­‰çº§:', describedRealmLevel);
                        break;
                    }
                }
            }
            
            // è§£æå„ä¸ªå­—æ®µ
            const lines = combatBlock.split('\n').filter(line => line.trim());
            const combatInfo = {
                name: '',
                realm: '',
                realmLevel: 0,
                attributes: {},
                techniques: [],
                spells: []
            };
            
            lines.forEach(line => {
                line = line.trim();
                
                // è§£æç›®æ ‡åç§°
                if (line.startsWith('ç›®æ ‡ï¼š')) {
                    combatInfo.name = line.replace('ç›®æ ‡ï¼š', '').trim();
                    console.log('ğŸ¯ æå–ç›®æ ‡åç§°:', combatInfo.name);
                }
                
                // è§£æå¢ƒç•Œ
                if (line.startsWith('å¢ƒç•Œï¼š')) {
                    const realmMatch = line.match(/å¢ƒç•Œï¼š(.+?)ï¼ˆ(\d+)ï¼‰/);
                    if (realmMatch) {
                        let realm = realmMatch[1].trim();
                        let realmLevel = parseInt(realmMatch[2]);
                        
                        // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®æ­£å¢ƒç•Œï¼ˆå¦‚æœæè¿°ä¸­æœ‰ä¸åŒçš„å¢ƒç•Œä¿¡æ¯ï¼‰
                        if (describedRealm && describedRealmLevel !== null && 
                            (realm !== describedRealm || realmLevel !== describedRealmLevel)) {
                            console.log('âš ï¸ æ£€æµ‹åˆ°å¢ƒç•Œä¸ä¸€è‡´:');
                            console.log('  æˆ˜æ–—ä¿¡æ¯å—ä¸­:', realm, 'ç­‰çº§:', realmLevel);
                            console.log('  æè¿°æ–‡æœ¬ä¸­:', describedRealm, 'ç­‰çº§:', describedRealmLevel);
                            console.log('ğŸ”§ ä½¿ç”¨æè¿°æ–‡æœ¬ä¸­çš„å¢ƒç•Œè¿›è¡Œä¿®æ­£');
                            
                            realm = describedRealm;
                            realmLevel = describedRealmLevel;
                        }
                        
                        combatInfo.realm = realm;
                        combatInfo.realmLevel = realmLevel;
                        console.log('âš”ï¸ æœ€ç»ˆç¡®å®šå¢ƒç•Œ:', combatInfo.realm, 'ç­‰çº§:', combatInfo.realmLevel);
                    }
                }
                
                // è§£æå…­ç»´å±æ€§
                if (line.startsWith('å…­ç»´ï¼š')) {
                    const statsStr = line.replace('å…­ç»´ï¼š', '').trim();
                    const stats = statsStr.split(',').map(s => parseInt(s.trim()));
                    if (stats.length === 6) {
                        combatInfo.attributes = {
                            physique: stats[0],    // æ ¹éª¨
                            comprehension: stats[1], // æ‚Ÿæ€§
                            spirituality: stats[2],  // çµæ€§
                            luck: stats[3],         // æ°”è¿
                            charm: stats[4],        // é­…åŠ›
                            willpower: stats[5]     // æ„å¿—
                        };
                        console.log('ğŸ’ª æå–å…­ç»´å±æ€§:', combatInfo.attributes);
                    }
                }
                
                // è§£æåŠŸæ³•ï¼ˆæ”¯æŒæ•ˆæœæ ‡ç­¾å’Œæè¿°ï¼‰
                if (line.startsWith('åŠŸæ³•ï¼š')) {
                    const techniquesStr = line.replace('åŠŸæ³•ï¼š', '').trim();
                    if (techniquesStr !== 'æ— ') {
                        // åŒ¹é…å¸¦æ•ˆæœæ ‡ç­¾å’Œæè¿°çš„æ ¼å¼ï¼šåç§°ï¼ˆå¨åŠ›X/æ¶ˆè€—Yï¼‰[æ•ˆæœ] - æè¿°
                        const techniqueMatches = techniquesStr.match(/([^ï¼Œ]+)ï¼ˆå¨åŠ›(\d+)\/æ¶ˆè€—(\d+)ï¼‰(?:\[([^\]]+)\])?(?:\s*-\s*([^ï¼Œ]+))?/g);
                        if (techniqueMatches) {
                            combatInfo.techniques = techniqueMatches.map(match => {
                                const techMatch = match.match(/([^ï¼ˆ]+)ï¼ˆå¨åŠ›(\d+)\/æ¶ˆè€—(\d+)ï¼‰(?:\[([^\]]+)\])?(?:\s*-\s*(.+))?/);
                                const effect = techMatch[4] || 'æ”»å‡»'; // é»˜è®¤ä¸ºæ”»å‡»æ•ˆæœ
                                const description = techMatch[5] || 'åŸºç¡€åŠŸæ³•'; // é»˜è®¤æè¿°
                                return {
                                    name: techMatch[1].trim(),
                                    power: parseInt(techMatch[2]),
                                    mpCost: parseInt(techMatch[3]),
                                    effect: effect,
                                    description: description.trim(),
                                    cooldown: 0,
                                    currentCooldown: 0
                                };
                            });
                            console.log('ğŸ¥Š æå–åŠŸæ³•ï¼ˆå«æ•ˆæœå’Œæè¿°ï¼‰:', combatInfo.techniques);
                        }
                    } else {
                        combatInfo.techniques = [];
                        console.log('ğŸ¥Š æ— åŠŸæ³•');
                    }
                }
                
                // è§£ææ³•æœ¯ï¼ˆæ”¯æŒæ•ˆæœæ ‡ç­¾å’Œæè¿°ï¼‰
                if (line.startsWith('æ³•æœ¯ï¼š')) {
                    const spellsStr = line.replace('æ³•æœ¯ï¼š', '').trim();
                    if (spellsStr !== 'æ— ') {
                        // åŒ¹é…å¸¦æ•ˆæœæ ‡ç­¾å’Œæè¿°çš„æ ¼å¼ï¼šåç§°ï¼ˆå¨åŠ›X/æ¶ˆè€—Yï¼‰[æ•ˆæœ] - æè¿°
                        const spellMatches = spellsStr.match(/([^ï¼Œ]+)ï¼ˆå¨åŠ›(\d+)\/æ¶ˆè€—(\d+)ï¼‰(?:\[([^\]]+)\])?(?:\s*-\s*([^ï¼Œ]+))?/g);
                        if (spellMatches) {
                            combatInfo.spells = spellMatches.map(match => {
                                const spellMatch = match.match(/([^ï¼ˆ]+)ï¼ˆå¨åŠ›(\d+)\/æ¶ˆè€—(\d+)ï¼‰(?:\[([^\]]+)\])?(?:\s*-\s*(.+))?/);
                                const effect = spellMatch[4] || 'æ”»å‡»'; // é»˜è®¤ä¸ºæ”»å‡»æ•ˆæœ
                                const description = spellMatch[5] || 'åŸºç¡€æ³•æœ¯'; // é»˜è®¤æè¿°
                                return {
                                    name: spellMatch[1].trim(),
                                    power: parseInt(spellMatch[2]),
                                    mpCost: parseInt(spellMatch[3]),
                                    effect: effect,
                                    description: description.trim(),
                                    cooldown: 0,
                                    currentCooldown: 0
                                };
                            });
                            console.log('âœ¨ æå–æ³•æœ¯ï¼ˆå«æ•ˆæœå’Œæè¿°ï¼‰:', combatInfo.spells);
                        }
                    } else {
                        combatInfo.spells = [];
                        console.log('âœ¨ æ— æ³•æœ¯');
                    }
                }
            });
            
            // éªŒè¯å¿…è¦å­—æ®µ
            if (!combatInfo.name || !combatInfo.realm) {
                console.log('âŒ æˆ˜æ–—ä¿¡æ¯ä¸å®Œæ•´:', combatInfo);
                return null;
            }
            
            console.log('âœ… æˆåŠŸè§£ææˆ˜æ–—ä¿¡æ¯:', combatInfo);
            return combatInfo;
        }

        // ç”Ÿæˆæ•Œäººæ•°æ®
        function generateEnemyData(targetName) {
            console.log('ğŸ² ä¸ºç›®æ ‡ç”Ÿæˆæ•Œäººæ•°æ®:', targetName);
            
            // æ ¹æ®ç›®æ ‡åç§°ç¡®å®šæ•Œäººç±»å‹å’Œå¼ºåº¦
            let enemyLevel = 1; // é»˜è®¤ç»ƒæ°”æœŸ
            let baseStats = { physique: 15, comprehension: 20, spirituality: 12, luck: 31, charm: 25, willpower: 18 };
            
            // æ ¹æ®ç›®æ ‡åç§°è°ƒæ•´éš¾åº¦
            if (targetName.includes('æŠ¤å«') || targetName.includes('å®¶ä¸')) {
                enemyLevel = 1;
                baseStats = { physique: 12, comprehension: 15, spirituality: 10, luck: 20, charm: 15, willpower: 16 };
            } else if (targetName.includes('å¼Ÿå­') || targetName.includes('ä¿®å£«')) {
                enemyLevel = 2;
                baseStats = { physique: 18, comprehension: 22, spirituality: 20, luck: 25, charm: 20, willpower: 24 };
            } else if (targetName.includes('é•¿è€') || targetName.includes('é«˜æ‰‹')) {
                enemyLevel = 3;
                baseStats = { physique: 25, comprehension: 28, spirituality: 26, luck: 30, charm: 22, willpower: 32 };
            } else if (targetName.includes('æŒé—¨') || targetName.includes('é­”å¤´')) {
                enemyLevel = 4;
                baseStats = { physique: 35, comprehension: 38, spirituality: 36, luck: 40, charm: 30, willpower: 42 };
            }
            
            // æ·»åŠ éšæœºå˜åŒ–
            const randomVariation = () => Math.floor(Math.random() * 10) - 5; // -5 åˆ° +5
            const finalStats = {
                physique: Math.max(10, baseStats.physique + randomVariation()),
                comprehension: Math.max(10, baseStats.comprehension + randomVariation()),
                spirituality: Math.max(10, baseStats.spirituality + randomVariation()),
                luck: Math.max(10, baseStats.luck + randomVariation()),
                charm: Math.max(10, baseStats.charm + randomVariation()),
                willpower: Math.max(10, baseStats.willpower + randomVariation())
            };
            
            // æ ¹æ®å¢ƒç•Œç­‰çº§ç¡®å®šåç§°
            const realmNames = ['å‡¡äºº', 'ç»ƒæ°”æœŸ', 'ç­‘åŸºæœŸ', 'é‡‘ä¸¹æœŸ', 'å…ƒå©´æœŸ', 'åŒ–ç¥æœŸ'];
            const realmName = realmNames[Math.min(enemyLevel, realmNames.length - 1)];
            
            // ç”ŸæˆæŠ€èƒ½
            const techniques = generateEnemyTechniques(enemyLevel);
            const spells = generateEnemySpells(enemyLevel);
            
            // è®¡ç®—HPå’ŒMP
            const hpMax = 80 + (finalStats.physique * 5) + (enemyLevel * 20);
            const mpMax = 60 + (finalStats.spirituality * 4) + (enemyLevel * 15);
            
            const enemyData = {
                name: targetName,
                realm: realmName,
                realmLevel: enemyLevel,
                attributes: finalStats,
                techniques: techniques,
                spells: spells,
                hp: hpMax,
                hpMax: hpMax,
                mp: mpMax,
                mpMax: mpMax
            };
            
            console.log('âœ… æ•Œäººæ•°æ®ç”Ÿæˆå®Œæˆ:', enemyData);
            return enemyData;
        }
        
        // ç”Ÿæˆæ•ŒäººåŠŸæ³•
        function generateEnemyTechniques(level) {
            const techniquePools = [
                // ç»ƒæ°”æœŸ
                [
                    { name: "åŸºç¡€æ‹³æ³•", power: 25, mpCost: 10, cooldown: 0, currentCooldown: 0 },
                    { name: "ç²—æµ…å‰‘è¯€", power: 35, mpCost: 20, cooldown: 0, currentCooldown: 0 },
                    { name: "è›®ç‰›åŠŸæ³•", power: 40, mpCost: 25, cooldown: 0, currentCooldown: 0 }
                ],
                // ç­‘åŸºæœŸ
                [
                    { name: "æµäº‘å‰‘æ³•", power: 45, mpCost: 30, cooldown: 0, currentCooldown: 0 },
                    { name: "çƒˆç«æŒ", power: 50, mpCost: 35, cooldown: 0, currentCooldown: 0 },
                    { name: "å¯’å†°æŒ‡", power: 55, mpCost: 40, cooldown: 0, currentCooldown: 0 }
                ],
                // é‡‘ä¸¹æœŸ
                [
                    { name: "ä¹è½¬ç„åŠŸ", power: 60, mpCost: 45, cooldown: 0, currentCooldown: 0 },
                    { name: "ç´«éœç¥åŠŸ", power: 65, mpCost: 50, cooldown: 0, currentCooldown: 0 },
                    { name: "å¤ªä¹™å‰‘è¯€", power: 70, mpCost: 55, cooldown: 0, currentCooldown: 0 }
                ],
                // å…ƒå©´æœŸ
                [
                    { name: "å¤§ç½—é‡‘ä»™è¯€", power: 75, mpCost: 60, cooldown: 0, currentCooldown: 0 },
                    { name: "æ··å…ƒæ— æåŠŸ", power: 80, mpCost: 65, cooldown: 0, currentCooldown: 0 },
                    { name: "è¯›ä»™å‰‘æ³•", power: 85, mpCost: 70, cooldown: 0, currentCooldown: 0 }
                ]
            ];
            
            const pool = techniquePools[Math.min(level - 1, techniquePools.length - 1)];
            const count = Math.min(2 + Math.floor(level / 2), pool.length);
            return pool.slice(0, count);
        }
        
        // ç”Ÿæˆæ•Œäººæ³•æœ¯
        function generateEnemySpells(level) {
            const spellPools = [
                // ç»ƒæ°”æœŸ
                [
                    { name: "å°ç«çƒæœ¯", power: 20, mpCost: 15, cooldown: 0, currentCooldown: 0 },
                    { name: "æ°´ç®­æœ¯", power: 25, mpCost: 18, cooldown: 0, currentCooldown: 0 },
                    { name: "é£åˆƒæœ¯", power: 30, mpCost: 20, cooldown: 0, currentCooldown: 0 }
                ],
                // ç­‘åŸºæœŸ
                [
                    { name: "çƒˆç„°ç„šç©ºå’’", power: 35, mpCost: 25, cooldown: 0, currentCooldown: 0 },
                    { name: "å†°å°åƒé‡Œ", power: 40, mpCost: 28, cooldown: 0, currentCooldown: 0 },
                    { name: "é›·éœ†ä¸‡é’§", power: 45, mpCost: 30, cooldown: 0, currentCooldown: 0 }
                ],
                // é‡‘ä¸¹æœŸ
                [
                    { name: "ä¹å¤©ç¥é›·", power: 50, mpCost: 35, cooldown: 0, currentCooldown: 0 },
                    { name: "ç„šå¤©çƒˆç„°", power: 55, mpCost: 38, cooldown: 0, currentCooldown: 0 },
                    { name: "ç„å†°é¾™åŸ", power: 60, mpCost: 40, cooldown: 0, currentCooldown: 0 }
                ],
                // å…ƒå©´æœŸ
                [
                    { name: "è¯›ä»™å‰‘æ°”", power: 65, mpCost: 45, cooldown: 0, currentCooldown: 0 },
                    { name: "æ··æ²Œå¤©é›·", power: 70, mpCost: 48, cooldown: 0, currentCooldown: 0 },
                    { name: "ä¸‡æ³•å½’ä¸€", power: 75, mpCost: 50, cooldown: 0, currentCooldown: 0 }
                ]
            ];
            
            const pool = spellPools[Math.min(level - 1, spellPools.length - 1)];
            const count = Math.min(2 + Math.floor(level / 2), pool.length);
            return pool.slice(0, count);
        }

        // é€‰æ‹©é€‰é¡¹
        async function selectOption(option) {
            // ç¡®ä¿optionæ˜¯å­—ç¬¦ä¸²
            const optionText = typeof option === 'string' ? option : String(option);

            if (gameState.isProcessing) return;

            // ğŸ”§ æˆ˜æ–—é€‰é¡¹å·²ç¦ç”¨
            // if (optionText.includes('ã€æˆ˜æ–—ã€‘')) {
            //     console.log('âš”ï¸ æ£€æµ‹åˆ°æˆ˜æ–—é€‰é¡¹ï¼Œå¯åŠ¨æˆ˜æ–—ç³»ç»Ÿ:', optionText);
            //     ...
            // }

            // ğŸ”§ å¤„ç†JSONè§£æå¤±è´¥åçš„ç‰¹æ®Šé€‰é¡¹
            if (option === "é‡æ–°ç”Ÿæˆå›å¤") {
                await regenerateLastResponse();
                return;
            }
            
            if (option === "è·³è¿‡æ­¤å›åˆ") {
                // è·³è¿‡æ­¤å›åˆï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€å›åˆ
                gameState.isProcessing = false;
                
                // ç§»é™¤æœ€åçš„é”™è¯¯æ¶ˆæ¯
                const errorMessage = document.getElementById('error-message-with-retry');
                if (errorMessage) errorMessage.remove();
                
                // æ˜¾ç¤ºè·³è¿‡æ¶ˆæ¯
                displayAIMessage("ä½ é€‰æ‹©è·³è¿‡æ­¤å›åˆï¼Œæ•…äº‹ç»§ç»­...", ["ç»§ç»­æ¢ç´¢"], {
                    situation: 'ç©å®¶é€‰æ‹©è·³è¿‡è§£æå¤±è´¥çš„å›åˆ',
                    playerChoice: 'è·³è¿‡æ­¤å›åˆ',
                    logicChain: ['è·³è¿‡å½“å‰å›åˆ', 'ç»§ç»­æ•…äº‹è¿›ç¨‹'],
                    outcome: 'æ•…äº‹ç»§ç»­ï¼Œä½†å¯èƒ½ç¼ºå°‘ä¸€äº›ç»†èŠ‚'
                });
                return;
            }
            
            if (option === "æŸ¥çœ‹åŸå§‹å“åº”") {
                // åœ¨æ–°çª—å£ä¸­æ˜¾ç¤ºåŸå§‹å“åº”
                const historyDiv = document.getElementById('gameHistory');
                const lastAIMessage = historyDiv.querySelector('.ai-message:last-of-type');
                
                if (lastAIMessage && lastAIMessage.originalResponse) {
                    const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
                    newWindow.document.write(`
                        <html>
                        <head><title>åŸå§‹AIå“åº”</title></head>
                        <body style="font-family: monospace; padding: 20px; white-space: pre-wrap;">
                            <h2>åŸå§‹AIå“åº”å†…å®¹</h2>
                            <hr>
                            <pre>${lastAIMessage.originalResponse}</pre>
                            <hr>
                            <button onclick="window.close()">å…³é—­çª—å£</button>
                        </body>
                        </html>
                    `);
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°åŸå§‹å“åº”å†…å®¹');
                }
                return;
            }

            gameState.isProcessing = true;

            // ğŸ†• è‡ªåŠ¨é™„åŠ æ“ä½œç¼“å­˜
            const actionsSummary = getPendingActionsSummary();
            let finalOption = optionText;
            if (actionsSummary) {
                finalOption = actionsSummary + optionText;
            }

            // ğŸ†• åœ¨æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´çš„ç”¨æˆ·è¾“å…¥
            console.log('ğŸ“¤ [ç”¨æˆ·é€‰æ‹©]', finalOption);

            // æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©ï¼ˆæ˜¾ç¤ºé™„åŠ äº†æ“ä½œçš„å®Œæ•´æ–‡æœ¬ï¼‰
            displayUserMessage(finalOption);

            // æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆåªä¿å­˜é€‰é¡¹å†…å®¹ï¼‰
            gameState.conversationHistory.push({
                role: 'user',
                content: finalOption
            });

            // ä¿å­˜å½“å‰å˜é‡å¿«ç…§ï¼ˆç”¨æˆ·é€‰æ‹©ï¼‰
            gameState.variableSnapshots.push(JSON.parse(JSON.stringify(gameState.variables)));

            // ğŸ†• æ¸…ç©ºæ“ä½œç¼“å­˜
            clearPendingActions();

            // ä¿å­˜æ¸¸æˆå†å²åˆ° IndexedDB
            saveGameHistory().catch(err => console.error('ä¿å­˜å†å²å¤±è´¥:', err));

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const historyDiv = document.getElementById('gameHistory');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai-message';
            loadingDiv.innerHTML = '<div class="message-content"><span class="loading"></span> AIæ€è€ƒä¸­...</div>';
            loadingDiv.id = 'loading-message';
            historyDiv.appendChild(loadingDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            try {
                // è§£æå±æ€§è¦æ±‚å¹¶è¿›è¡Œåˆ¤å®šï¼ˆä½¿ç”¨åŸå§‹optionï¼Œä¸åŒ…å«æ“ä½œæ‘˜è¦ï¼‰
                const requirement = parseAttributeRequirement(optionText);
                const checkResult = checkAttributeRequirement(requirement);

                // ğŸ¯ ä½¿ç”¨ç»Ÿä¸€å‡½æ•°æ„å»ºå¢å¼ºæç¤ºï¼ˆä¼ å…¥å±æ€§åˆ¤å®šç»“æœï¼‰
                const enhancedOption = buildEnhancedPrompt(finalOption, {
                    attributeCheck: { requirement, checkResult }
                });

                // ğŸ†• åœ¨æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´çš„å¢å¼ºæç¤º
                console.log('ğŸ“¤ [åŸå§‹é€‰é¡¹]', optionText);
                console.log('ğŸ“¤ [å®Œæ•´é€‰é¡¹(å«æ“ä½œ)]', finalOption);
                console.log('ğŸ¤– [å‘é€ç»™AIçš„å®Œæ•´Prompt]', enhancedOption);

                // ğŸ”§ ä¼ å…¥åŸå§‹é€‰é¡¹æ–‡æœ¬ï¼ˆç”¨äºå‘é‡æ£€ç´¢ï¼‰
                const response = await callAI(enhancedOption, false, finalOption);

                // ç§»é™¤åŠ è½½æç¤º
                const loading = document.getElementById('loading-message');
                if (loading) loading.remove();

                handleAIResponse(response);

                // è§¦å‘åŠ¨æ€ä¸–ç•Œç”Ÿæˆï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                generateDynamicWorld().catch(err => console.error('[åŠ¨æ€ä¸–ç•Œ] ç”Ÿæˆå¼‚å¸¸:', err));

            } catch (error) {
                // ç§»é™¤åŠ è½½æç¤º
                const loading = document.getElementById('loading-message');
                if (loading) loading.remove();

                // âŒ ä¸è¦ç§»é™¤ç”¨æˆ·æ¶ˆæ¯ï¼æ˜¾ç¤ºé”™è¯¯å’Œé‡è¯•æŒ‰é’®
                displayErrorMessageWithRetry('AIå“åº”å¤±è´¥ï¼š' + error.message, async () => {
                    // ç§»é™¤é”™è¯¯æ¶ˆæ¯
                    const errorDiv = document.getElementById('error-message-with-retry');
                    if (errorDiv) errorDiv.remove();
                    
                    // é‡æ–°ç”Ÿæˆæœ€åçš„å“åº”
                    await regenerateLastResponse();
                });
            }

            gameState.isProcessing = false;
        }

        // Make selectOption globally accessible
        window.selectOption = selectOption;


        // ==================== æ ¼å¼åŒ–æ¸¸æˆ ====================
        // formatGame åœ¨ game-core-systems.js æœ‰ç®€åŒ–ç‰ˆæœ¬
        // ä½†è¿™é‡Œä¿ç•™å®Œæ•´ç‰ˆæœ¬ï¼ŒåŒ…å«æ¸¸æˆçŠ¶æ€é‡ç½®é€»è¾‘
        async function formatGame() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ ¼å¼åŒ–å°†æ¸…é™¤æ‰€æœ‰å­˜æ¡£å’Œè¿›åº¦ï¼ŒåŒ…æ‹¬DLCçŸ¥è¯†åŒ…ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nâœ… å°†ä¿ç•™ï¼š\n- APIé…ç½®\n- æ¸¸æˆè®¾ç½®\n- åŠ¨æ€ä¸–ç•Œè®¾ç½®\n\nç¡®å®šè¦æ ¼å¼åŒ–å—ï¼Ÿ')) {
                return;
            }

            console.log('[æ ¼å¼åŒ–] å¼€å§‹æ ¼å¼åŒ–ï¼Œå°†ä¿ç•™ API é…ç½®ã€æ¸¸æˆè®¾ç½®å’ŒåŠ¨æ€ä¸–ç•Œè®¾ç½®');
            
            // é‡ç½®çŠ¶æ€
            gameState.variables = {
                name: "",
                gender: "",
                realm: "",
                identity: "",
                karmaFortune: 0,
                karmaPunishment: 0,
                cultivationProgress: 0,
                cultivationProgressMax: 100,
                hp: 100,
                hpMax: 100,
                mp: 100,
                mpMax: 100,
                talents: [],
                attributes: {
                    physique: 0,
                    fortune: 0,
                    comprehension: 0,
                    spirit: 0,
                    potential: 0,
                    charisma: 0
                },
                equipment: {
                    head: null,
                    clothes: null,
                    feet: null,
                    treasure1: null,
                    treasure2: null,
                    treasure3: null
                },
                items: [],
                techniques: [],
                spells: [],
                relationships: [],
                location: "",
                history: []
            };
            gameState.previousVariables = null;
            gameState.conversationHistory = [];
            gameState.variableSnapshots = [];
            gameState.isGameStarted = false;
            gameState.isProcessing = false;
            gameState.characterInfo = null;

            // æ¸…é™¤ IndexedDB ä¸­çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬æ‰€æœ‰å­˜æ¡£ï¼‰
            try {
                await clearGameHistory();
            } catch (error) {
                console.error('æ¸…é™¤æ•°æ®å¤±è´¥:', error);
            }
            
            // ã€æ–°å¢ã€‘æ¸…ç©ºå‘é‡åº“
            if (window.contextVectorManager) {
                window.contextVectorManager.clear();
                window.contextVectorManager.saveToIndexedDB().catch(err => {
                    console.error('æ¸…ç©ºå‘é‡åº“å¤±è´¥:', err);
                });
                
                // æ¸…ç©ºé™æ€çŸ¥è¯†åº“
                window.contextVectorManager.clearStaticKB();
                window.contextVectorManager.saveStaticKBToIndexedDB().catch(err => {
                    console.error('æ¸…ç©ºé™æ€çŸ¥è¯†åº“å¤±è´¥:', err);
                });
            }

            // æ¸…ç©ºDLCæ•°æ®
            if (window.dlcManager) {
                try {
                    await window.dlcManager.clearAllDLCs();
                    console.log('[æ ¼å¼åŒ–] å·²æ¸…ç©ºæ‰€æœ‰DLCæ•°æ®');
                } catch (error) {
                    console.error('[æ ¼å¼åŒ–] æ¸…ç©ºDLCæ•°æ®å¤±è´¥:', error);
                }
            }

            // é‡ç½®åŠ¨æ€ä¸–ç•Œæ•°æ®ï¼ˆä¿ç•™ enabled å’Œ messageInterval è®¾ç½®ï¼‰
            gameState.dynamicWorld = {
                enabled: gameState.dynamicWorld?.enabled || false,
                history: [],
                floor: 0,
                isProcessing: false,
                messageInterval: gameState.dynamicWorld?.messageInterval || 1, // ä¿ç•™é—´éš”è®¾ç½®
                messageCounter: 0 // é‡ç½®è®¡æ•°å™¨
            };
            console.log('[æ ¼å¼åŒ–] å·²é‡ç½®åŠ¨æ€ä¸–ç•Œæ•°æ®ï¼ˆå·²ä¿ç•™ enabled å’Œ messageInterval è®¾ç½®ï¼‰');
            
            // æ›´æ–°åŠ¨æ€ä¸–ç•ŒTabæ˜¾ç¤º
            displayDynamicWorldHistory();

            // æ›´æ–°çŠ¶æ€é¢æ¿
            updateStatusPanel();

            // æ˜¾ç¤ºä¸»èœå•
            showMainMenu();
        }

        // åˆ‡æ¢ç§»åŠ¨ç«¯tab
        function switchMobileTab(tabName) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.game-panel').classList.remove('active');
            document.querySelector('.status-panel').classList.remove('active');

            // æ·»åŠ å¯¹åº”çš„activeç±»
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            if (tabName === 'game') {
                document.querySelector('.game-panel').classList.add('active');
            } else if (tabName === 'status') {
                document.querySelector('.status-panel').classList.add('active');
            }
        }

        // åˆ‡æ¢äººé™…å…³ç³»è¯¦æƒ…å±•å¼€/æŠ˜å 
        function toggleRelationshipDetails(index) {
            console.log('Toggle called for index:', index); // Debug log
            const detailsDiv = document.getElementById(`relationship-details-${index}`);
            console.log('Found details div:', detailsDiv); // Debug log
            
            if (!detailsDiv) {
                console.error('Details div not found for index:', index);
                return;
            }
            
            const cardDiv = detailsDiv.parentElement;
            console.log('Current classes - details:', detailsDiv.className, 'card:', cardDiv.className); // Debug log
            
            if (detailsDiv.classList.contains('show')) {
                // æŠ˜å 
                detailsDiv.classList.remove('show');
                cardDiv.classList.remove('expanded');
                console.log('Collapsed'); // Debug log
            } else {
                // å±•å¼€
                detailsDiv.classList.add('show');
                cardDiv.classList.add('expanded');
                console.log('Expanded'); // Debug log
            }
        }

       
    </script>


    <div id="combatModal" class="combat-modal"></div>
    
</body>

</html>