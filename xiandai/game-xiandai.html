<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç°ä»£éƒ½å¸‚</title>
    <link rel="stylesheet" href="../css/xiandai-style.css">
    
    <!-- æ¸¸æˆä¸“ç”¨æ•°æ®éš”ç¦»è„šæœ¬ - å¿…é¡»åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰åŠ è½½ -->
    <script>
        // ä¸ºä¸»æ¸¸æˆåˆ›å»ºç‹¬ç«‹çš„æ•°æ®å‘½åç©ºé—´
        (function() {
            const GAME_PREFIX = 'game_';
            const GAME_DB_NAME = 'game_xiandai_dlc_db';
            const GAME_VECTOR_DB_NAME = 'game_Vectorxiandai';
            
            // åŒ…è£…localStorageï¼Œè‡ªåŠ¨æ·»åŠ game_å‰ç¼€
            const originalLocalStorage = {
                getItem: localStorage.getItem.bind(localStorage),
                setItem: localStorage.setItem.bind(localStorage),
                removeItem: localStorage.removeItem.bind(localStorage),
                clear: localStorage.clear.bind(localStorage)
            };
            
            // é‡å†™localStorageæ–¹æ³•
            Storage.prototype.getItem = function(key) {
                return originalLocalStorage.getItem(GAME_PREFIX + key);
            };
            
            Storage.prototype.setItem = function(key, value) {
                return originalLocalStorage.setItem(GAME_PREFIX + key, value);
            };
            
            Storage.prototype.removeItem = function(key) {
                return originalLocalStorage.removeItem(GAME_PREFIX + key);
            };
            
            // clearæ–¹æ³•åªæ¸…é™¤game_å‰ç¼€çš„æ•°æ®
            Storage.prototype.clear = function() {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(GAME_PREFIX)) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => originalLocalStorage.removeItem(key));
            };
            
            // ä¿å­˜é…ç½®ä¾›DLCManagerä½¿ç”¨
            window.GAME_CONFIG = {
                DB_NAME: GAME_DB_NAME,
                VECTOR_DB_NAME: GAME_VECTOR_DB_NAME
            };
            
            console.log('[ä¸»æ¸¸æˆ] æ•°æ®éš”ç¦»å·²å¯ç”¨ - localStorageå‰ç¼€:', GAME_PREFIX);
            console.log('[ä¸»æ¸¸æˆ] DLCæ•°æ®åº“å:', GAME_DB_NAME);
        })();
    </script>
</head>

<body>
    <!-- ç§»åŠ¨ç«¯Tabåˆ‡æ¢ -->
    <div class="mobile-tabs">
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="game" onclick="switchMobileTab('game')">
                ğŸ® æ¸¸æˆ
            </button>
            <button class="tab-btn" data-tab="status" onclick="switchMobileTab('status')">
                ğŸ“Š çŠ¶æ€
            </button>
        </div>
    </div>
    <!-- é…ç½®å¼¹çª—é€šè¿‡JSç”Ÿæˆ -->
    <script src="../js/config-modal.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½é…ç½®å¼¹çª—
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadConfigModal();
                // åˆå§‹åŒ–äººç‰©å›¾è°±
                setTimeout(initCharacterGraphSystem, 1500);
            });
        } else {
            loadConfigModal();
            // åˆå§‹åŒ–äººç‰©å›¾è°±
            setTimeout(initCharacterGraphSystem, 1500);
        }
        
        // åˆå§‹åŒ–äººç‰©å›¾è°±ç³»ç»Ÿ
        async function initCharacterGraphSystem() {
            try {
                console.log('[äººç‰©å›¾è°±] å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿ...');
                
                // ğŸ”§ ç­‰å¾…æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ
                let retryCount = 0;
                const maxRetries = 30; // 3ç§’ï¼Œæ¯100msæ£€æŸ¥ä¸€æ¬¡
                
                while ((!window.characterGraphManager || !window.characterGraphIntegration || !window.initializeCharacterGraphHooks) && retryCount < maxRetries) {
                    console.log(`[äººç‰©å›¾è°±] â³ ç­‰å¾…æ‰€æœ‰æ¨¡å—åŠ è½½... (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retryCount++;
                }
                
                // æ£€æŸ¥æ¨¡å—æ˜¯å¦éƒ½å¯ç”¨
                if (!window.characterGraphManager) {
                    console.error('[äººç‰©å›¾è°±] âŒ CharacterGraphManager æœªæ‰¾åˆ°');
                    return;
                }
                if (!window.characterGraphIntegration) {
                    console.error('[äººç‰©å›¾è°±] âŒ CharacterGraphIntegration æœªæ‰¾åˆ°');
                    return;
                }
                if (!window.initializeCharacterGraphHooks) {
                    console.error('[äººç‰©å›¾è°±] âŒ CharacterGraphHooks æœªæ‰¾åˆ°');
                    return;
                }
                
                // æŒ‰é¡ºåºåˆå§‹åŒ–
                console.log('[äººç‰©å›¾è°±] ğŸ”„ åˆå§‹åŒ–ç®¡ç†å™¨...');
                await window.characterGraphManager.init();
                console.log('âœ… äººç‰©å›¾è°±ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                
                console.log('[äººç‰©å›¾è°±] ğŸ”„ åˆå§‹åŒ–é›†æˆ...');
                await window.characterGraphIntegration.init();
                console.log('âœ… äººç‰©å›¾è°±é›†æˆåˆå§‹åŒ–å®Œæˆ');
                
                console.log('[äººç‰©å›¾è°±] ğŸ”„ åˆå§‹åŒ–é’©å­...');
                window.initializeCharacterGraphHooks();
                console.log('âœ… äººç‰©å›¾è°±é’©å­åˆå§‹åŒ–å®Œæˆ');
                
                console.log('[äººç‰©å›¾è°±] âœ… ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('[äººç‰©å›¾è°±] âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // å…¨å±€å‡½æ•°ï¼šåˆ‡æ¢ç§»åŠ¨ç«¯tab
        function switchMobileTab(tabName) {
            console.log('[ç§»åŠ¨ç«¯Tab] åˆ‡æ¢åˆ°:', tabName);
            
            try {
                // ç§»é™¤æ‰€æœ‰activeç±»
                const tabBtns = document.querySelectorAll('.tab-btn');
                console.log('[ç§»åŠ¨ç«¯Tab] æ‰¾åˆ°tabæŒ‰é’®æ•°é‡:', tabBtns.length);
                tabBtns.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const gamePanel = document.querySelector('.game-panel');
                const statusPanel = document.querySelector('.status-panel');
                console.log('[ç§»åŠ¨ç«¯Tab] æ‰¾åˆ°é¢æ¿:', {
                    gamePanel: !!gamePanel,
                    statusPanel: !!statusPanel
                });
                
                if (gamePanel) gamePanel.classList.remove('active');
                if (statusPanel) statusPanel.classList.remove('active');

                // æ·»åŠ å¯¹åº”çš„activeç±»
                const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
                console.log('[ç§»åŠ¨ç«¯Tab] ç›®æ ‡tab:', !!targetTab);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                if (tabName === 'game') {
                    if (gamePanel) {
                        gamePanel.classList.add('active');
                        console.log('[ç§»åŠ¨ç«¯Tab] å·²æ¿€æ´»æ¸¸æˆé¢æ¿');
                    }
                } else if (tabName === 'status') {
                    if (statusPanel) {
                        statusPanel.classList.add('active');
                        console.log('[ç§»åŠ¨ç«¯Tab] å·²æ¿€æ´»çŠ¶æ€é¢æ¿');
                    }
                }
            } catch (error) {
                console.error('[ç§»åŠ¨ç«¯Tab] åˆ‡æ¢å¤±è´¥:', error);
            }
        }
    </script>

    <div class="container">
        <!-- ä¸­é—´æ¸¸æˆé¢æ¿ -->
        <div class="panel game-panel active">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(0,243,255,0.1);">
                <h2 class="glitch-text" data-text="ç°ä»£éƒ½å¸‚">ç°ä»£éƒ½å¸‚</h2>
                <button class="config-toggle-btn" onclick="openConfigModal()"> è®¾ç½®</button>
            </div>
            <div id="gameHistory"></div>
            <div id="debugOutput" style="display:none; font-family: 'Consolas', 'Monaco', monospace; white-space: pre-wrap; background: rgba(0,0,0,0.6); color: #00f3ff; border-radius: 4px; padding: 12px; margin: 10px; max-height: 50vh; overflow: auto; border: 1px solid rgba(0,243,255,0.2);"></div>
            <div class="controls">
                <button class="btn btn-primary" id="startGame" onclick="startGame()" style="display: none;">å¼€å§‹æ¸¸æˆ</button>
                <div style="display: flex; gap: 10px;" class="mobile-input-container">
                    <button class="btn btn-delete-mode" id="deleteToggleBtn" onclick="toggleDeleteMode()">ğŸ—‘ï¸</button>
                    <input type="text" id="userInput" class="input-typing-effect" placeholder="è¾“å…¥ä½ çš„è¡ŒåŠ¨...">
                    <button class="btn btn-primary" id="sendBtn" onclick="sendUserInput()">å‘é€</button>
                </div>
                <div id="deleteControls" style="display: none; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmDelete()">âœ… ç¡®è®¤åˆ é™¤</button>
                    <button class="btn btn-secondary" onclick="cancelDelete()">âŒ å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§çŠ¶æ€é¢æ¿å®¹å™¨ï¼ˆç”±æ¸¸æˆé…ç½®æ–‡ä»¶åŠ¨æ€ç”Ÿæˆï¼‰ -->
        <div id="statusPanelContainer" class="panel status-panel">
            <!-- çŠ¶æ€é¢æ¿HTMLå°†ç”±é…ç½®æ–‡ä»¶ï¼ˆå¦‚ xiuxian-config.jsï¼‰åŠ¨æ€æ’å…¥ -->
            <!-- å¦‚æœé…ç½®æ–‡ä»¶æœªåŠ è½½ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå¤‡ç”¨å†…å®¹ -->
        </div>
    </div>

    <script>
        // ğŸ“± å¤–ç½®æ‰‹æœºæ˜¾ç¤º/éšè—æ§åˆ¶ï¼ˆé€šè¿‡è®¾ç½®ä¸­çš„å¼€å…³æ§åˆ¶æ‚¬æµ®æŒ‰é’®ï¼‰
        
        // æ˜¾ç¤ºæ‰‹æœºæ‚¬æµ®æŒ‰é’®
        window.showMobilePhone = function() {
            const btn = document.getElementById('mobileFloatBtn');
            if (btn) {
                btn.style.display = 'flex';
                console.log('[å¤–ç½®æ‰‹æœº] æ‚¬æµ®æŒ‰é’®å·²æ˜¾ç¤º');
            }
        };
        
        // éšè—æ‰‹æœºæ‚¬æµ®æŒ‰é’®
        window.hideMobilePhone = function() {
            const btn = document.getElementById('mobileFloatBtn');
            if (btn) {
                btn.style.display = 'none';
            }
            // åŒæ—¶å…³é—­å¼¹çª—ï¼ˆå¦‚æœå‡½æ•°å·²å®šä¹‰ï¼‰
            if (typeof closeMobilePopup === 'function') {
                closeMobilePopup(null, true);
            }
            console.log('[å¤–ç½®æ‰‹æœº] æ‚¬æµ®æŒ‰é’®å·²éšè—');
        };
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥è®¾ç½®
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const btn = document.getElementById('mobileFloatBtn');
                if (btn) {
                    // æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦æ˜¾ç¤º
                    if (window.mobilePhoneSettings && window.mobilePhoneSettings.enabled) {
                        btn.style.display = 'flex';
                        console.log('[å¤–ç½®æ‰‹æœº] å·²æ ¹æ®è®¾ç½®æ˜¾ç¤ºæ‚¬æµ®æŒ‰é’®');
                    } else {
                        btn.style.display = 'none';
                        console.log('[å¤–ç½®æ‰‹æœº] å·²æ ¹æ®è®¾ç½®éšè—æ‚¬æµ®æŒ‰é’®');
                    }
                }
            }, 800);
        });
        
        // ğŸ“± ç›‘å¬æ‰‹æœºiframeçš„AIè¯·æ±‚ï¼ˆpostMessageé€šä¿¡ï¼‰
        window.addEventListener('message', async function(event) {
            if (event.data && event.data.type === 'MOBILE_AI_REQUEST') {
                console.log('[å¤–ç½®æ‰‹æœº] æ”¶åˆ°AIè¯·æ±‚:', event.data.userMessage);
                
                const { userMessage, chatContext, chatId, chatType, chatHistory, loadingId, isBatchMessage } = event.data;
                const mobileFrame = document.getElementById('mobileFrame');
                
                try {
                    // æ£€æŸ¥æ‰‹æœºAPIæ˜¯å¦é…ç½®
                    if (!window.mobileApiConfig || !window.mobileApiConfig.enabled) {
                        throw new Error('æ‰‹æœºAPIæœªå¯ç”¨ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®');
                    }
                    
                    if (!window.mobileApiConfig.endpoint || !window.mobileApiConfig.key || !window.mobileApiConfig.model) {
                        throw new Error('æ‰‹æœºAPIé…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                    }
                    
                    // æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ„å»ºæ—¥å¿—
                    const showDetails = window.mobilePhoneSettings?.showBuildDetails !== false;
                    
                    if (showDetails) {
                        console.log('\n' + '='.repeat(60));
                        console.log('ğŸ“± å¤–ç½®æ‰‹æœº - å¼€å§‹æ„å»ºä¸Šä¸‹æ–‡');
                        console.log('='.repeat(60));
                        console.log('ğŸ¤– ä½¿ç”¨æ¨¡å‹:', window.mobileApiConfig.model);
                        console.log('ğŸ“¤ åˆå¹¶å‘é€æ¨¡å¼:', isBatchMessage ? 'æ˜¯' : 'å¦');
                        console.log('ğŸ’¬ èŠå¤©å¯¹è±¡:', chatContext);
                        console.log('ğŸ†” èŠå¤©ID:', chatId);
                        console.log('ğŸ“œ èŠå¤©å†å²æ¡æ•°:', chatHistory ? chatHistory.length : 0);
                    }
                    
                    // æ„å»ºæ¶ˆæ¯æ•°ç»„
                    let messages = [];
                    
                    // å¦‚æœæ˜¯åˆå¹¶å‘é€ï¼Œæ·»åŠ é€šè®¯APPä¸“ç”¨æç¤ºè¯
                    if (isBatchMessage) {
                        // åˆ¤æ–­æ˜¯å¦ä¸ºç¾¤èŠ
                        const isGroupChat = chatType === 'group' || chatId.includes('group');
                        
                        // è·å–é€šè®¯APPæç¤ºè¯ï¼ˆåŒºåˆ†ç§èŠå’Œç¾¤èŠï¼‰
                        const commPrompt = isGroupChat ? 
`ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆä¸­çš„è™šæ‹Ÿæ‰‹æœºé€šè®¯ç³»ç»Ÿã€‚ç”¨æˆ·åœ¨ç¾¤èŠä¸­å‘æ¶ˆæ¯ã€‚
å½“å‰ç¾¤èŠ: ${chatContext}

ã€æ¶ˆæ¯æ ¼å¼è§„èŒƒã€‘
ç”¨æˆ·å‘é€çš„æ¶ˆæ¯é‡‡ç”¨JSONæ ¼å¼ï¼ŒåŒ…å«messagesæ•°ç»„ã€‚

ã€å›å¤æ ¼å¼è¦æ±‚ã€‘
ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ï¼š
{
  "replies": [
    {
      "direction": "incoming",
      "chatType": "group",
      "target": { "name": "æˆ‘", "id": "self" },
      "sender": { "name": "ç¾¤æˆå‘˜çœŸå®å§“å", "id": "member_id" },
      "msgType": "text",
      "content": "å›å¤å†…å®¹"
    }
  ]
}

ã€é‡è¦è§„åˆ™-ç¾¤èŠã€‘
1. sender.nameå¿…é¡»æ˜¯å…·ä½“çš„ç¾¤æˆå‘˜å§“åï¼ˆå¦‚"å¼ ä¸‰"ã€"æå››"ï¼‰ï¼Œä¸èƒ½æ˜¯ç¾¤å"${chatContext}"
2. å¯ä»¥æœ‰å¤šä¸ªä¸åŒçš„ç¾¤æˆå‘˜å›å¤ï¼Œæ¯æ¡æ¶ˆæ¯çš„sender.nameéƒ½è¦æ˜¯å…·ä½“çš„äººå
3. æ ¹æ®æ¸¸æˆèƒŒæ™¯å’Œä¸Šä¸‹æ–‡ï¼Œåˆç†è®¾å®šç¾¤æˆå‘˜çš„èº«ä»½å’Œæ€§æ ¼
4. å›å¤å†…å®¹è¦ç¬¦åˆè¯¥ç¾¤æˆå‘˜çš„æ€§æ ¼ç‰¹ç‚¹
5. åªè¿”å›JSONï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šæˆ–é¢å¤–æ–‡å­—` :
`ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆä¸­çš„è™šæ‹Ÿæ‰‹æœºé€šè®¯ç³»ç»Ÿã€‚ç”¨æˆ·é€šè¿‡æ‰‹æœºAPPä¸æ¸¸æˆä¸­çš„NPCè¿›è¡Œç§èŠã€‚
å½“å‰èŠå¤©å¯¹è±¡: ${chatContext}

ã€æ¶ˆæ¯æ ¼å¼è§„èŒƒã€‘
ç”¨æˆ·å‘é€çš„æ¶ˆæ¯é‡‡ç”¨JSONæ ¼å¼ï¼ŒåŒ…å«messagesæ•°ç»„ã€‚

ã€å›å¤æ ¼å¼è¦æ±‚ã€‘
ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ï¼š
{
  "replies": [
    {
      "direction": "incoming",
      "chatType": "private",
      "target": { "name": "æˆ‘", "id": "self" },
      "sender": { "name": "${chatContext}", "id": "${chatId}" },
      "msgType": "text",
      "content": "å›å¤å†…å®¹"
    }
  ]
}

ã€é‡è¦è§„åˆ™-ç§èŠã€‘
1. senderä½¿ç”¨å½“å‰èŠå¤©å¯¹è±¡çš„ä¿¡æ¯
2. å¯ä»¥è¿”å›å¤šæ¡è¿ç»­æ¶ˆæ¯
3. å›å¤å†…å®¹è¦ç¬¦åˆè§’è‰²æ€§æ ¼å’Œæ¸¸æˆèƒŒæ™¯
4. åªè¿”å›JSONï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šæˆ–é¢å¤–æ–‡å­—
5. æ ¹æ®èŠå¤©å†å²ä¿æŒå¯¹è¯è¿è´¯æ€§`;
                        
                        messages.push({ role: 'system', content: commPrompt });
                        if (showDetails) {
                            console.log('\nğŸ“ ç³»ç»Ÿæç¤ºè¯å·²æ·»åŠ ');
                        }
                        
                        // æ·»åŠ å½“å‰èŠå¤©å¯¹è±¡çš„å†å²ä¸Šä¸‹æ–‡ï¼ˆåªå‘é€å½“å‰èŠå¤©çš„å†å²ï¼‰
                        if (chatHistory && chatHistory.length > 0) {
                            if (showDetails) {
                                console.log('\nğŸ“œ æ·»åŠ èŠå¤©å†å²ä¸Šä¸‹æ–‡:');
                            }
                            chatHistory.forEach((h, i) => {
                                messages.push({
                                    role: h.role,
                                    content: h.content
                                });
                                if (showDetails) {
                                    const preview = h.content.substring(0, 50) + (h.content.length > 50 ? '...' : '');
                                    console.log(`   [${i+1}] ${h.role}: ${preview}`);
                                }
                            });
                        }
                    }
                    
                    // æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆçŸ¥è¯†åº“ã€å‘é‡æ£€ç´¢ç­‰ï¼‰
                    if (showDetails) {
                        console.log('\nğŸ” æ„å»ºæ¸¸æˆä¸Šä¸‹æ–‡...');
                    }
                    const contextMessages = await buildMobileAIMessages(userMessage, chatContext);
                    
                    // åˆå¹¶ä¸Šä¸‹æ–‡æ¶ˆæ¯
                    if (isBatchMessage) {
                        // åªæ·»åŠ ç”¨æˆ·æ¶ˆæ¯å’Œä¸Šä¸‹æ–‡éƒ¨åˆ†
                        contextMessages.forEach(msg => {
                            if (msg.role !== 'system') {
                                messages.push(msg);
                            } else {
                                // å°†æ¸¸æˆä¸Šä¸‹æ–‡ä¿¡æ¯ä½œä¸ºè¡¥å……
                                const contextInfo = msg.content.replace(/^ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆä¸­çš„è™šæ‹Ÿæ‰‹æœºåŠ©æ‰‹ã€‚ä»¥ä¸‹æ˜¯ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š\n\n/, '').replace(/\n\nè¯·æ ¹æ®è¿™äº›ä¿¡æ¯å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚$/, '');
                                if (contextInfo.trim()) {
                                    messages.push({ role: 'user', content: 'ã€æ¸¸æˆèƒŒæ™¯å‚è€ƒã€‘\n' + contextInfo + '\n\nã€å½“å‰æ¶ˆæ¯ã€‘\n' + userMessage });
                                    if (showDetails) {
                                        console.log('\nğŸ“š æ¸¸æˆä¸Šä¸‹æ–‡ä¿¡æ¯:');
                                        console.log(contextInfo.substring(0, 200) + (contextInfo.length > 200 ? '...' : ''));
                                    }
                                } else {
                                    messages.push({ role: 'user', content: userMessage });
                                }
                            }
                        });
                    } else {
                        messages = contextMessages;
                    }
                    
                    if (showDetails) {
                        console.log('\n' + '='.repeat(60));
                        console.log('ğŸ“± ä¸Šä¸‹æ–‡æ„å»ºå®Œæˆ');
                        console.log('='.repeat(60));
                        console.log('ğŸ“Š æ€»æ¶ˆæ¯æ•°:', messages.length);
                        messages.forEach((msg, i) => {
                            const preview = msg.content.substring(0, 60) + (msg.content.length > 60 ? '...' : '');
                            console.log(`   [${i+1}] ${msg.role}: ${preview}`);
                        });
                        console.log('='.repeat(60) + '\n');
                    }
                    
                    // è°ƒç”¨æ‰‹æœºAPI
                    const aiReply = await callMobileAPI(messages);
                    console.log('[å¤–ç½®æ‰‹æœº] AIå›å¤æˆåŠŸ');
                    
                    // å‘é€å“åº”å›iframe
                    if (mobileFrame && mobileFrame.contentWindow) {
                        mobileFrame.contentWindow.postMessage({
                            type: 'MOBILE_AI_RESPONSE',
                            loadingId: loadingId,
                            success: true,
                            reply: aiReply
                        }, '*');
                    }
                    
                } catch (error) {
                    console.error('[å¤–ç½®æ‰‹æœº] AIè°ƒç”¨å¤±è´¥:', error);
                    
                    // å‘é€é”™è¯¯å“åº”å›iframe
                    if (mobileFrame && mobileFrame.contentWindow) {
                        mobileFrame.contentWindow.postMessage({
                            type: 'MOBILE_AI_RESPONSE',
                            loadingId: loadingId,
                            success: false,
                            error: error.message
                        }, '*');
                    }
                }
            }
            
            // ğŸ“° ç›‘å¬è®ºå›iframeçš„AIè¯·æ±‚
            if (event.data && event.data.type === 'MOBILE_FORUM_REQUEST') {
                console.log('[å¤–ç½®æ‰‹æœº-è®ºå›] æ”¶åˆ°è¯·æ±‚:', event.data.action);
                
                const { action, userMessage, loadingId } = event.data;
                const mobileFrame = document.getElementById('mobileFrame');
                
                try {
                    // æ£€æŸ¥æ‰‹æœºAPIæ˜¯å¦é…ç½®
                    if (!window.mobileApiConfig || !window.mobileApiConfig.enabled) {
                        throw new Error('æ‰‹æœºAPIæœªå¯ç”¨ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®');
                    }
                    
                    if (!window.mobileApiConfig.endpoint || !window.mobileApiConfig.key || !window.mobileApiConfig.model) {
                        throw new Error('æ‰‹æœºAPIé…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                    }
                    
                    const showDetails = window.mobilePhoneSettings?.showBuildDetails !== false;
                    
                    if (showDetails) {
                        console.log('\n' + '='.repeat(60));
                        console.log('ğŸ“° å¤–ç½®æ‰‹æœº-è®ºå› - å¼€å§‹æ„å»ºä¸Šä¸‹æ–‡');
                        console.log('='.repeat(60));
                        console.log('ğŸ¤– ä½¿ç”¨æ¨¡å‹:', window.mobileApiConfig.model);
                        console.log('ğŸ“ æ“ä½œç±»å‹:', action);
                    }
                    
                    // æ„å»ºæ¶ˆæ¯æ•°ç»„
                    let messages = [];
                    
                    // è·å–è®ºå›ç³»ç»Ÿæç¤ºè¯ - ç°ä»£éƒ½å¸‚ç‰ˆ
                    const forumPrompt = `ä½ æ˜¯ä¸€ä¸ªç°ä»£éƒ½å¸‚ç”Ÿæ´»è®ºå›ç³»ç»Ÿã€‚ç”¨æˆ·é€šè¿‡æ‰‹æœºAPPæµè§ˆå’Œå‚ä¸ç°ä»£ç”Ÿæ´»è®ºå›è®¨è®ºã€‚
- è¿™æ˜¯çº¯ç²¹çš„ç°ä»£éƒ½å¸‚ä¸–ç•Œï¼Œåªæœ‰ç°å®ç”Ÿæ´»å…ƒç´ 
- è¯é¢˜åº”è¯¥æ˜¯ï¼šå·¥ä½œã€ç”Ÿæ´»ã€ç¾é£Ÿã€å¨±ä¹ã€ç¤¾äº¤ã€æ–°é—»ç­‰ç°ä»£è¯é¢˜

ã€å¸–å­åˆ†ç±»æ ‡ç­¾ã€‘
- HOT: çƒ­é—¨è¯é¢˜
- GOSSIP: å…«å¦æ¶ˆæ¯
- GUIDE: æ”»ç•¥æŒ‡å—
- TRADE: äº¤æ˜“ä¿¡æ¯
- ASK: æ±‚åŠ©æé—®
- NEWS: æ–°é—»èµ„è®¯
- SHOW: æ™’å›¾ç‚«è€€

ã€å›å¤æ ¼å¼ - æµè§ˆå¸–å­åˆ—è¡¨ã€‘
å½“actionä¸ºbrowseæˆ–refreshæ—¶ï¼Œè¿”å›å¸–å­åˆ—è¡¨ï¼ˆæ¯ä¸ªå¸–å­å¿…é¡»åŒ…å«3-4æ¡è¯„è®ºï¼‰ï¼š
{
  "type": "postList",
  "posts": [
    {
      "id": "å¸–å­å”¯ä¸€IDï¼ˆå¦‚P8X92ï¼‰",
      "tag": "HOT|GOSSIP|GUIDE|TRADE|ASK|NEWS|SHOW",
      "title": "å¸–å­æ ‡é¢˜",
      "author": { "name": "ä½œè€…å", "id": "ä½œè€…ID", "realm": "è´´å§ç­‰çº§" },
      "content": "å¸–å­å®Œæ•´æ­£æ–‡å†…å®¹",
      "stats": { "replies": 999, "views": 10200 },
      "time": "å‘å¸ƒæ—¶é—´æè¿°ï¼ˆå¦‚1h agoï¼‰",
      "isHot": trueæˆ–false,
      "preview": "å†…å®¹é¢„è§ˆï¼ˆå‰50å­—ï¼‰",
      "comments": [
        {
          "id": "è¯„è®ºID",
          "author": { "name": "è¯„è®ºè€…", "id": "ID", "realm": "ç­‰çº§" },
          "content": "è¯„è®ºå†…å®¹",
          "time": "è¯„è®ºæ—¶é—´",
          "likes": 12,
          "floor": 1
        }
      ]
    }
  ]
}

ã€å›å¤æ ¼å¼ - æŸ¥çœ‹å¸–å­è¯¦æƒ…ã€‘
å½“actionä¸ºviewæ—¶ï¼Œè¿”å›å¸–å­è¯¦æƒ…å’Œè¯„è®ºï¼š
{
  "type": "postDetail",
  "post": {
    "id": "å¸–å­ID",
    "tag": "æ ‡ç­¾",
    "title": "å¸–å­æ ‡é¢˜",
    "author": { "name": "ä½œè€…å", "id": "ä½œè€…ID", "realm": "è´´å§ç­‰çº§", "avatar": "å¤´åƒç¬¦å·" },
    "content": "å¸–å­å®Œæ•´æ­£æ–‡å†…å®¹",
    "stats": { "replies": 123, "views": 5600, "likes": 88 },
    "time": "å‘å¸ƒæ—¶é—´",
    "images": []
  },
  "comments": [
    {
      "id": "è¯„è®ºID",
      "author": { "name": "è¯„è®ºè€…", "id": "ID", "realm": "è´´å§ç­‰çº§" },
      "content": "è¯„è®ºå†…å®¹",
      "time": "è¯„è®ºæ—¶é—´",
      "likes": 12,
      "floor": 1
    }
  ]
}

ã€å›å¤æ ¼å¼ - å‘å¸–ç»“æœã€‘
å½“actionä¸ºpostæ—¶ï¼Œè¿”å›ï¼š
{
  "type": "actionResult",
  "success": true,
  "message": "å‘å¸–æˆåŠŸ",
  "newPost": { ... }
}

ã€å›å¤æ ¼å¼ - è¯„è®ºç»“æœã€‘
å½“actionä¸ºcommentæ—¶ï¼Œå¿…é¡»è¿”å›å…¶ä»–ç½‘å‹å¯¹ç©å®¶è¯„è®ºçš„ååº”ï¼š
{
  "type": "actionResult",
  "success": true,
  "message": "è¯„è®ºæˆåŠŸ",
  "newComment": {
    "id": "è¯„è®ºID",
    "content": "ç©å®¶çš„è¯„è®ºå†…å®¹",
    "floor": æ¥¼å±‚å·
  },
  "reactions": [
    {
      "id": "C+6ä½æ•°å­—",
      "author": { "name": "ç½‘å‹å", "id": "ID", "realm": "è´´å§ç­‰çº§" },
      "content": "å¯¹ç©å®¶è¯„è®ºçš„å›å¤å†…å®¹",
      "time": "åˆšåˆš",
      "likes": 0,
      "floor": ä¸‹ä¸€æ¥¼å±‚å·,
      "replyTo": ç©å®¶è¯„è®ºçš„æ¥¼å±‚å·
    }
  ]
}
ã€é‡è¦ã€‘è¯„è®ºæ—¶å¿…é¡»ç”Ÿæˆ2-3æ¡reactionsï¼Œè¿™æ˜¯å…¶ä»–ç½‘å‹çœ‹åˆ°ç©å®¶è¯„è®ºåçš„çœŸå®ååº”ï¼Œå¯ä»¥æ˜¯èµåŒã€åé©³ã€è°ƒä¾ƒã€è¿½é—®ç­‰

ã€é‡è¦è§„åˆ™ã€‘
1. å¸–å­å†…å®¹è¦ç¬¦åˆç°ä»£éƒ½å¸‚ç”Ÿæ´»ï¼Œå……æ»¡ç°å®ç”Ÿæ´»å…ƒç´ ï¼ˆå·¥ä½œã€ç¾é£Ÿã€å¨±ä¹ã€è´­ç‰©ç­‰ï¼‰
2. è¯„è®ºè¦æœ‰è¶£ã€å¤šæ ·åŒ–ï¼Œä½“ç°ä¸åŒç½‘å‹çš„æ€§æ ¼
3. çƒ­é—¨å¸–å­(isHot)åº”è¯¥è¯é¢˜æ€§å¼º
4. å¸–å­IDæ ¼å¼ï¼šP+4ä½å­—æ¯æ•°å­—ï¼ˆå¦‚P8X92ï¼‰
5. è¯„è®ºIDæ ¼å¼ï¼šC+6ä½æ•°å­—
6. åªè¿”å›JSONï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šæˆ–é¢å¤–æ–‡å­—
7. æµè§ˆæ—¶è¿”å›5-8ä¸ªå¸–å­
8. ã€å¿…é¡»ã€‘æ¯ä¸ªå¸–å­å¿…é¡»ç”Ÿæˆ3-4æ¡å¯¹åº”çš„å›å¤è¯„è®ºï¼Œæ”¾åœ¨commentså­—æ®µä¸­ï¼Œä¸èƒ½å°‘äº3æ¡ï¼
9. ã€å¼ºåˆ¶ã€‘å½“action=commentæ—¶ï¼Œå¿…é¡»åœ¨è¿”å›çš„JSONä¸­åŒ…å«reactionsæ•°ç»„ï¼Œç”Ÿæˆ2-3æ¡å…¶ä»–ç½‘å‹å¯¹ç©å®¶è¯„è®ºçš„å›å¤ååº”ï¼è¿™æ˜¯å¿…å¡«å­—æ®µï¼Œä¸èƒ½çœç•¥ï¼`;
                    
                    messages.push({ role: 'system', content: forumPrompt });
                    
                    // æ„å»ºæ¸¸æˆä¸Šä¸‹æ–‡
                    if (showDetails) {
                        console.log('\nğŸ” æ„å»ºæ¸¸æˆä¸Šä¸‹æ–‡...');
                    }
                    const contextMessages = await buildMobileAIMessages(userMessage, 'è®ºå›');
                    
                    // æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
                    contextMessages.forEach(msg => {
                        if (msg.role !== 'system') {
                            messages.push(msg);
                        } else if (msg.content && !msg.content.includes('è™šæ‹Ÿæ‰‹æœºåŠ©æ‰‹')) {
                            // æå–æ¸¸æˆèƒŒæ™¯ä¿¡æ¯
                            const contextInfo = msg.content.replace(/^ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆä¸­çš„è™šæ‹Ÿæ‰‹æœºåŠ©æ‰‹ã€‚ä»¥ä¸‹æ˜¯ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š\n\n/, '').replace(/\n\nè¯·æ ¹æ®è¿™äº›ä¿¡æ¯å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚$/, '');
                            if (contextInfo.trim()) {
                                messages.push({ role: 'user', content: 'ã€æ¸¸æˆèƒŒæ™¯å‚è€ƒã€‘\n' + contextInfo + '\n\nã€ç”¨æˆ·è¯·æ±‚ã€‘\n' + userMessage });
                            } else {
                                messages.push({ role: 'user', content: userMessage });
                            }
                        }
                    });
                    
                    // ç¡®ä¿ç”¨æˆ·æ¶ˆæ¯è¢«æ·»åŠ 
                    if (!messages.some(m => m.role === 'user')) {
                        messages.push({ role: 'user', content: userMessage });
                    }
                    
                    if (showDetails) {
                        console.log('\n' + '='.repeat(60));
                        console.log('ğŸ“° è®ºå›ä¸Šä¸‹æ–‡æ„å»ºå®Œæˆ');
                        console.log('='.repeat(60));
                        console.log('ğŸ“Š æ€»æ¶ˆæ¯æ•°:', messages.length);
                        console.log('='.repeat(60) + '\n');
                    }
                    
                    // è°ƒç”¨API
                    const aiReply = await callMobileAPI(messages);
                    console.log('[å¤–ç½®æ‰‹æœº-è®ºå›] AIå›å¤æˆåŠŸ');
                    
                    // å‘é€å“åº”å›iframe
                    if (mobileFrame && mobileFrame.contentWindow) {
                        mobileFrame.contentWindow.postMessage({
                            type: 'MOBILE_FORUM_RESPONSE',
                            loadingId: loadingId,
                            success: true,
                            reply: aiReply
                        }, '*');
                    }
                    
                } catch (error) {
                    console.error('[å¤–ç½®æ‰‹æœº-è®ºå›] AIè°ƒç”¨å¤±è´¥:', error);
                    
                    if (mobileFrame && mobileFrame.contentWindow) {
                        mobileFrame.contentWindow.postMessage({
                            type: 'MOBILE_FORUM_RESPONSE',
                            loadingId: loadingId,
                            success: false,
                            error: error.message
                        }, '*');
                    }
                }
            }
            
            // ğŸ“± ç›‘å¬æ‰‹æœºæ•°æ®å˜æ›´ï¼ˆåˆ é™¤æ¶ˆæ¯ç­‰ï¼‰- åŒæ­¥ä¿å­˜åˆ°IndexedDB
            if (event.data && event.data.type === 'MOBILE_DATA_CHANGED') {
                console.log('[å¤–ç½®æ‰‹æœº] æ”¶åˆ°æ•°æ®å˜æ›´é€šçŸ¥:', event.data.action);
                
                if (event.data.action === 'save' && event.data.data) {
                    // æ›´æ–°localStorageï¼ˆä¸»æ¸¸æˆä¾§ï¼‰
                    try {
                        localStorage.setItem('mobileChatData', JSON.stringify(event.data.data));
                        console.log('[å¤–ç½®æ‰‹æœº] localStorageå·²åŒæ­¥');
                    } catch (e) {
                        console.warn('[å¤–ç½®æ‰‹æœº] localStorageåŒæ­¥å¤±è´¥:', e);
                    }
                    
                    // åŒæ­¥ä¿å­˜åˆ°IndexedDB
                    if (typeof saveGameHistory === 'function') {
                        saveGameHistory().then(() => {
                            console.log('[å¤–ç½®æ‰‹æœº] IndexedDBå·²åŒæ­¥ä¿å­˜');
                        }).catch(err => {
                            console.error('[å¤–ç½®æ‰‹æœº] IndexedDBåŒæ­¥å¤±è´¥:', err);
                        });
                    }
                }
            }
            
            // ğŸ“° ç›‘å¬è®ºå›æ•°æ®å˜æ›´ - åŒæ­¥ä¿å­˜åˆ°IndexedDB
            if (event.data && event.data.type === 'MOBILE_FORUM_DATA_CHANGED') {
                console.log('[å¤–ç½®æ‰‹æœº-è®ºå›] æ”¶åˆ°æ•°æ®å˜æ›´é€šçŸ¥:', event.data.action);
                
                if (event.data.action === 'save' && event.data.data) {
                    // æ›´æ–°localStorageï¼ˆä¸»æ¸¸æˆä¾§ï¼‰
                    try {
                        localStorage.setItem('mobileForumData', JSON.stringify(event.data.data));
                        console.log('[å¤–ç½®æ‰‹æœº-è®ºå›] localStorageå·²åŒæ­¥');
                    } catch (e) {
                        console.warn('[å¤–ç½®æ‰‹æœº-è®ºå›] localStorageåŒæ­¥å¤±è´¥:', e);
                    }
                    
                    // åŒæ­¥ä¿å­˜åˆ°IndexedDB
                    if (typeof saveGameHistory === 'function') {
                        saveGameHistory().then(() => {
                            console.log('[å¤–ç½®æ‰‹æœº-è®ºå›] IndexedDBå·²åŒæ­¥ä¿å­˜');
                        }).catch(err => {
                            console.error('[å¤–ç½®æ‰‹æœº-è®ºå›] IndexedDBåŒæ­¥å¤±è´¥:', err);
                        });
                    }
                }
            }
        });
    </script>

    <!-- Transformers.js - æµè§ˆå™¨ç«¯AIæ¨¡å‹åº“ï¼ˆå¯é€‰ï¼Œä»…åœ¨ä½¿ç”¨æµè§ˆå™¨æ¨¡å‹æ—¶éœ€è¦ï¼‰ -->
    <script type="module" id="transformersScript">
        // åŠ¨æ€åŠ è½½ï¼Œé¿å…å½±å“é¡µé¢åŠ è½½é€Ÿåº¦
        // è°ƒè¯•æ—¥å¿—å¼€å…³ï¼ˆé»˜è®¤å…³é—­ï¼‰ã€‚å¦‚éœ€æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼Œå¯åœ¨æ§åˆ¶å°æ‰§è¡Œï¼šwindow.DEBUG_TRANSFORMERS = true
        window.DEBUG_TRANSFORMERS = (typeof window.DEBUG_TRANSFORMERS !== 'undefined') ? window.DEBUG_TRANSFORMERS : false;
        // ğŸ†• æ·»åŠ å…¨å±€fetchæ‹¦æˆªå™¨ä»¥è¿½è¸ªæ¨¡å‹ä¸‹è½½è¿›åº¦
        window._setupProgressTracking = function() {
            if (window._progressTrackingSetup) return;
            window._progressTrackingSetup = true;
            
            const originalFetch = window.fetch;
            window.fetch = async function(...args) {
                const [url] = args;
                
                // åªæ‹¦æˆªæ¨¡å‹æ–‡ä»¶ä¸‹è½½ï¼ˆ.onnx, .jsonç­‰ï¼‰
                const isModelFile = typeof url === 'string' && 
                    (url.includes('onnx') || url.includes('Xenova') || url.includes('tokenizer'));
                
                if (!isModelFile || !window._modelLoadProgress) {
                    return originalFetch.apply(this, args);
                }
                
                console.log(`[æ¨¡å‹ä¸‹è½½] å¼€å§‹ä¸‹è½½: ${url.split('/').pop()}`);
                
                const response = await originalFetch.apply(this, args);
                
                if (!response.ok) {
                    console.error(`[æ¨¡å‹ä¸‹è½½] ä¸‹è½½å¤±è´¥: ${response.status} ${response.statusText}`);
                    return response;
                }
                
                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length') || 0;
                const fileName = url.split('/').pop();
                
                console.log(`[æ¨¡å‹ä¸‹è½½] ${fileName} - å¤§å°: ${(contentLength / 1024 / 1024).toFixed(2)} MB`);
                
                let receivedLength = 0;
                const chunks = [];
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    // æ›´æ–°å…¨å±€è¿›åº¦
                    if (window._modelLoadProgress) {
                        window._modelLoadProgress.files.set(fileName, {
                            loaded: receivedLength,
                            total: contentLength
                        });
                        
                        // è®¡ç®—æ€»è¿›åº¦
                        let totalLoaded = 0;
                        let totalSize = 0;
                        window._modelLoadProgress.files.forEach(file => {
                            totalLoaded += file.loaded;
                            totalSize += file.total;
                        });
                        
                        window._modelLoadProgress.loaded = totalLoaded;
                        window._modelLoadProgress.total = totalSize || 15000000; // é»˜è®¤15MB
                        
                        // æ›´æ–°UI
                        window._updateProgressUI && window._updateProgressUI();
                    }
                }
                
                console.log(`[æ¨¡å‹ä¸‹è½½] âœ… ${fileName} ä¸‹è½½å®Œæˆ`);
                
                // é‡æ–°ç»„è£…å“åº”
                const chunksAll = new Uint8Array(receivedLength);
                let position = 0;
                for (let chunk of chunks) {
                    chunksAll.set(chunk, position);
                    position += chunk.length;
                }
                
                return new Response(chunksAll, {
                    status: response.status,
                    statusText: response.statusText,
                    headers: response.headers
                });
            };
        };
        
        window.loadTransformersJS = async function() {
            if (window.transformersLoaded) return;
            
            // å¯åŠ¨è¿›åº¦è¿½è¸ª
            window._setupProgressTracking();
            
            console.log('[Transformers.js] å¼€å§‹åŠ è½½åº“æ–‡ä»¶...');
            
            try {
                const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0');
                
                // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ¸…é™¤é»˜è®¤çš„ /models/ è·¯å¾„å‰ç¼€
                env.localModelPath = './';  // è®¾ç½®ä¸ºå½“å‰ç›®å½•ï¼Œé¿å…è·¯å¾„é‡å¤
                env.allowRemoteModels = true;  // å…è®¸CDNå›é€€
                
                window.transformers = { pipeline, env };
                window.transformersLoaded = true;
                console.log('[Transformers.js] âœ… åº“åŠ è½½æˆåŠŸ');
                console.log('[Transformers.js] æœ¬åœ°æ¨¡å‹åŸºç¡€è·¯å¾„:', env.localModelPath);
            } catch (error) {
                console.error('[Transformers.js] âŒ åº“åŠ è½½å¤±è´¥:', error);
                throw error;
            }
        };

        function logItemOp(op) {
            if (!gameState.localOps) gameState.localOps = { items: [], attrs: [], equip: [] };
            gameState.localOps.items.push(Object.assign({}, op, { ts: Date.now() }));
        }

        function logAttrOp(op) {
            if (!gameState.localOps) gameState.localOps = { items: [], attrs: [], equip: [] };
            gameState.localOps.attrs.push(Object.assign({}, op, { ts: Date.now() }));
        }

        function logEquipOp(op) {
            if (!gameState.localOps) gameState.localOps = { items: [], attrs: [], equip: [] };
            gameState.localOps.equip.push(Object.assign({}, op, { ts: Date.now() }));
        }
    </script>

    <script src="../supply.js"></script>
    <script src="../matrix-manager.js"></script>
    <script src="../game-framework.js"></script>
    <script src="xiandai-config.js?v=20251118-2"></script>
    <script src="../combat-skills.js"></script>
    <script src="../combat-system-part1.js"></script>
    <script src="../combat-system-complete.js"></script>
    <script src="../js/game-core-systems.js"></script>
    <script src="../js/api-calling-functions.js"></script>
    <script src="../js/dynamic-world-functions.js"></script>
    <script src="../js/variable-instruction-parser-v3.1.js"></script>

    
    <!-- âœ… æ¿€è¿›é‡æ„æ–°å¢æ¨¡å— - å¾…åˆ›å»ºå®Œæ•´ç‰ˆæœ¬ -->
    <script src="../dlc-manager.js"></script>
    <script src="../js/knowledge-manager-full.js"></script>
    <script src="../js/dlc-ui-full.js"></script>
    <script src="../js/message-editor.js"></script>
    <script src="../js/message-floor-indicator.js"></script>
    <script src="../js/shared/data-isolation.js"></script>
    <script src="../js/shared/mobile-ui.js"></script>
    <script src="../js/shared/ai-response-handler.js"></script>
    <script src="../js/user-input-handler.js"></script>
    <script src="../js/ai-message-builder.js"></script>
    <script src="../js/viewer-components.js"></script>
    <script src="../js/history-matrix-modal-functions.js"></script>
    <script src="../js/json-repair-enhanced.js"></script>
    <script src="../js/game-initialization.js"></script>
    
    <!-- äººç‰©å›¾è°±ç³»ç»Ÿ -->
    <script src="../js/character-graph-manager.js"></script>
    <script>
        console.log('[è°ƒè¯•] character-graph-manager.js åŠ è½½å®Œæˆï¼Œwindow.characterGraphManager =', !!window.characterGraphManager);
    </script>
    <script src="../js/character-graph-integration.js"></script>
    <script>
        console.log('[è°ƒè¯•] character-graph-integration.js åŠ è½½å®Œæˆï¼Œwindow.characterGraphIntegration =', !!window.characterGraphIntegration);
    </script>
    <script src="../js/character-graph-ui.js"></script>
    <script src="../js/character-graph-hooks.js"></script>
    <script>
        console.log('[è°ƒè¯•] character-graph-hooks.js åŠ è½½å®Œæˆï¼Œwindow.initializeCharacterGraphHooks =', !!window.initializeCharacterGraphHooks);
    </script>
    
    <!-- ç°ä»£é£æ ¼å‡ºèº«å’Œå¤©èµ‹å®šä¹‰ - å¿…é¡»åœ¨ character-creation.js ä¹‹å‰åŠ è½½ -->
    <script>
        // ç°ä»£é£æ ¼å‡ºèº«åˆ—è¡¨
        window.origins = [
            { id: 'ordinary_citizen', name: 'æ™®é€šå¸‚æ°‘', description: 'å¹³å‡¡çš„åŸå¸‚å±…æ°‘ï¼Œä¸€åˆ‡ä»é›¶å¼€å§‹', pointsModifier: 0, attributeEffects: {} },
            { id: 'tech_elite', name: 'ITç²¾è‹±', description: 'äº’è”ç½‘å¤§å‚ç¨‹åºå‘˜ï¼Œé€»è¾‘æ€ç»´å¼º', pointsModifier: -20, attributeEffects: { comprehension: 15, spirit: 8, physique: -5, charisma: -3 } },
            { id: 'rich_second', name: 'å¯ŒäºŒä»£', description: 'å®¶å¢ƒä¼˜æ¸¥ï¼Œä»å°é”¦è¡£ç‰é£Ÿ', pointsModifier: -35, attributeEffects: { fortune: 20, charisma: 10, physique: -5, spirit: 3 } },
            { id: 'athlete', name: 'èŒä¸šè¿åŠ¨å‘˜', description: 'ä¸“ä¸šè¿åŠ¨å‘˜å‡ºèº«ï¼Œèº«ä½“ç´ è´¨å‡ºä¼—', pointsModifier: -15, attributeEffects: { physique: 18, spirit: 5, comprehension: -3 } },
            { id: 'college_student', name: 'å¤§å­¦ç”Ÿ', description: 'æ™®é€šé«˜æ ¡åœ¨è¯»å­¦ç”Ÿï¼Œå¹´è½»æœ‰æ½œåŠ›', pointsModifier: -10, attributeEffects: { comprehension: 10, potential: 8, fortune: 3 } },
            { id: 'top_student', name: 'åæ ¡å­¦éœ¸', description: 'é¡¶å°–å­¦åºœçš„é«˜æç”Ÿï¼Œå­¦ä¹ èƒ½åŠ›è¶…ç¾¤', pointsModifier: -30, attributeEffects: { comprehension: 18, potential: 10, spirit: 5, charisma: 3 } },
            { id: 'freelancer', name: 'è‡ªç”±èŒä¸šè€…', description: 'ç‹¬ç«‹å·¥ä½œï¼Œè‡ªç”±ä½†æ”¶å…¥ä¸ç¨³å®š', pointsModifier: -5, attributeEffects: { comprehension: 8, fortune: -3, spirit: 5, potential: 5 } },
            { id: 'migrant_worker', name: 'æ‰“å·¥äºº', description: 'æ™®é€šä¸Šç­æ—ï¼Œåƒè‹¦è€åŠ³', pointsModifier: 10, attributeEffects: { physique: 5, spirit: 8, fortune: -5, potential: 10 } },
            { id: 'business_family', name: 'å•†ä¸šä¸–å®¶', description: 'å®¶æ—ä¼ä¸šç»§æ‰¿äººï¼Œäººè„‰å¹¿æ³›', pointsModifier: -35, attributeEffects: { charisma: 15, fortune: 10, spirit: 5, comprehension: 5 } },
            { id: 'medical_family', name: 'åŒ»å­¦ä¸–å®¶', description: 'åŒ»å­¦ä¸–å®¶ä¼ äººï¼Œå¯¹äººä½“äº†å¦‚æŒ‡æŒ', pointsModifier: -25, attributeEffects: { comprehension: 12, spirit: 10, potential: 5, physique: 3 } },
            { id: 'celebrity', name: 'å¨±ä¹æ˜æ˜Ÿ', description: 'æ¼”è‰ºåœˆçŸ¥åäººç‰©ï¼Œé­…åŠ›å››å°„', pointsModifier: -40, attributeEffects: { charisma: 25, fortune: 8, physique: -3, comprehension: -5 } },
            { id: 'farmer', name: 'å†œæ‘é’å¹´', description: 'æ¥è‡ªå†œæ‘ï¼Œå‹¤åŠ³è´¨æœ´', pointsModifier: 8, attributeEffects: { physique: 10, spirit: 5, fortune: -5, charisma: -5 } },
            { id: 'debt_ridden', name: 'è´Ÿå€ºç´¯ç´¯', description: 'èƒŒè´Ÿå·¨é¢å€ºåŠ¡ï¼Œå‹åŠ›å±±å¤§', pointsModifier: 25, attributeEffects: { fortune: -15, spirit: 5, charisma: -8, potential: 5 } },
            { id: 'hacker', name: 'ç½‘ç»œé»‘å®¢', description: 'æŠ€æœ¯é«˜è¶…çš„é»‘å®¢ï¼Œæ¸¸èµ°äºç°è‰²åœ°å¸¦', pointsModifier: -20, attributeEffects: { comprehension: 18, spirit: 8, charisma: -5, fortune: -3 } },
            { id: 'scientist', name: 'ç§‘ç ”äººå‘˜', description: 'ä»äº‹ç§‘å­¦ç ”ç©¶å·¥ä½œï¼Œæ€ç»´ä¸¥è°¨', pointsModifier: -25, attributeEffects: { comprehension: 15, spirit: 10, potential: 5, charisma: -5 } },
            { id: 'soldier', name: 'é€€ä¼å†›äºº', description: 'ç»å†è¿‡ä¸¥æ ¼è®­ç»ƒï¼Œæ„å¿—åšå®š', pointsModifier: -15, attributeEffects: { physique: 15, spirit: 10, charisma: 3, comprehension: -3 } },
            { id: 'delivery_driver', name: 'å¤–å–éª‘æ‰‹', description: 'é£é‡Œæ¥é›¨é‡Œå»ï¼Œç†Ÿæ‚‰åŸå¸‚æ¯ä¸ªè§’è½', pointsModifier: 12, attributeEffects: { physique: 12, spirit: 5, fortune: -8, charisma: -5 } },
            { id: 'artist', name: 'è‰ºæœ¯å®¶', description: 'è¿½æ±‚è‰ºæœ¯çš„çµé­‚ï¼Œæ„ŸçŸ¥åŠ›è¶…ç¾¤', pointsModifier: -18, attributeEffects: { spirit: 15, comprehension: 8, charisma: 5, physique: -5 } },
            { id: 'streamer', name: 'ç½‘çº¢ä¸»æ’­', description: 'ç½‘ç»œçº¢äººï¼Œç²‰ä¸ä¼—å¤š', pointsModifier: -15, attributeEffects: { charisma: 15, fortune: 5, spirit: 3, physique: -3 } },
            { id: 'martial_artist', name: 'æ­¦æœ¯æ•™ç»ƒ', description: 'ä¼ ç»Ÿæ­¦æœ¯ä¼ æ‰¿è€…ï¼Œèº«æ‰‹ä¸å‡¡', pointsModifier: -12, attributeEffects: { physique: 15, spirit: 8, charisma: 5, comprehension: -3 } },
            { id: 'orphan', name: 'å­¤å„¿é™¢é•¿å¤§', description: 'ä»å°åœ¨å­¤å„¿é™¢é•¿å¤§ï¼Œç‹¬ç«‹åšå¼º', pointsModifier: 15, attributeEffects: { spirit: 10, potential: 8, fortune: -10, charisma: -5 } },
            { id: 'chronic_patient', name: 'æ…¢æ€§ç—…æ‚£è€…', description: 'èº«æ‚£æ…¢æ€§ç–¾ç—…ï¼Œä½†æ„å¿—é¡½å¼º', pointsModifier: 20, attributeEffects: { physique: -15, spirit: 15, fortune: -8, potential: 5 } }
        ];
        
        // ç°ä»£é£æ ¼å¤©èµ‹åˆ—è¡¨
        window.talents = [
            // æ­£é¢å¤©èµ‹
            { id: 'high_iq', name: 'é«˜æ™ºå•†', type: 'positive', cost: -15, description: 'æ™ºå•†è¶…ç¾¤ï¼Œå­¦ä¹ èƒ½åŠ›æå¼º', effects: { comprehension: 10, potential: 5 } },
            { id: 'athletic_talent', name: 'è¿åŠ¨å¤©èµ‹', type: 'positive', cost: -10, description: 'å¤©ç”Ÿè¿åŠ¨ç»†èƒå‘è¾¾ï¼Œä½“èƒ½å‡ºä¼—', effects: { physique: 12, spirit: 3 } },
            { id: 'born_lucky', name: 'å¤©ç”Ÿå¥½è¿', type: 'positive', cost: -10, description: 'æ€»èƒ½é‡åˆ°å¥½äº‹ï¼Œè¿æ°”æä½³', effects: { fortune: 15, charisma: 3 } },
            { id: 'photographic_memory', name: 'è¿‡ç›®ä¸å¿˜', type: 'positive', cost: -12, description: 'è®°å¿†åŠ›æƒŠäººï¼Œçœ‹è¿‡çš„ä¸œè¥¿éƒ½èƒ½è®°ä½', effects: { comprehension: 15 } },
            { id: 'natural_beauty', name: 'å¤©ç”Ÿä¸½è´¨', type: 'positive', cost: -10, description: 'å®¹è²Œå‡ºä¼—ï¼Œè‡ªå¸¦å…‰ç¯', effects: { charisma: 12, fortune: 3 } },
            { id: 'charming_aura', name: 'é­…åŠ›å…‰ç¯', type: 'positive', cost: -10, description: 'å¤©ç”Ÿå…·æœ‰å¸å¼•åŠ›ï¼Œå¼‚æ€§ç¼˜æä½³', effects: { charisma: 15, fortune: -3 } },
            { id: 'sixth_sense', name: 'ç¬¬å…­æ„Ÿ', type: 'positive', cost: -12, description: 'ç›´è§‰æ•é”ï¼Œèƒ½æ„ŸçŸ¥å±é™©', effects: { spirit: 12, comprehension: 3 } },
            { id: 'quick_learner', name: 'è§¦ç±»æ—é€š', type: 'positive', cost: -18, description: 'å­¦ä»€ä¹ˆéƒ½å¿«ï¼Œä¸¾ä¸€åä¸‰', effects: { comprehension: 12, potential: 8, spirit: 3 } },
            { id: 'iron_will', name: 'é’¢é“æ„å¿—', type: 'positive', cost: -15, description: 'æ„å¿—åšå®šï¼Œæ°¸ä¸æ”¾å¼ƒ', effects: { spirit: 12, physique: 5, potential: 3 } },
            { id: 'genius_programmer', name: 'ç¼–ç¨‹å¤©æ‰', type: 'positive', cost: -20, description: 'å¯¹ä»£ç æœ‰ç€å¤©ç”Ÿçš„ç†è§£åŠ›', effects: { comprehension: 15, spirit: 8, potential: 5 } },
            { id: 'financial_genius', name: 'ç†è´¢å¤©æ‰', type: 'positive', cost: -18, description: 'å¯¹é‡‘é’±æœ‰ç€æ•é”çš„å—…è§‰', effects: { fortune: 12, comprehension: 8, spirit: 5 } },
            { id: 'social_butterfly', name: 'ç¤¾äº¤è¾¾äºº', type: 'positive', cost: -15, description: 'å–„äºäº¤é™…ï¼Œäººè„‰å¹¿æ³›', effects: { charisma: 15, fortune: 5 } },
            { id: 'language_genius', name: 'è¯­è¨€å¤©èµ‹', type: 'positive', cost: -12, description: 'å­¦ä¹ è¯­è¨€æå¿«ï¼Œç²¾é€šå¤šå›½è¯­è¨€', effects: { comprehension: 10, charisma: 5, spirit: 3 } },
            { id: 'artistic_soul', name: 'è‰ºæœ¯ä¹‹é­‚', type: 'positive', cost: -15, description: 'å¯¹è‰ºæœ¯æœ‰ç€éå‡¡çš„æ„ŸçŸ¥åŠ›', effects: { spirit: 12, charisma: 8, comprehension: 5 } },
            { id: 'survival_instinct', name: 'æ±‚ç”Ÿæœ¬èƒ½', type: 'positive', cost: -12, description: 'å±æœºæ—¶åˆ»æ€»èƒ½åŒ–é™©ä¸ºå¤·', effects: { physique: 8, spirit: 8, fortune: 5 } },
            { id: 'night_owl', name: 'å¤œçŒ«å­', type: 'positive', cost: -8, description: 'å¤œé—´ç²¾åŠ›å……æ²›ï¼Œæ•ˆç‡å€å¢', effects: { spirit: 8, potential: 5 } },
            { id: 'health_freak', name: 'å¥åº·è¾¾äºº', type: 'positive', cost: -15, description: 'æ³¨é‡å…»ç”Ÿï¼Œèº«ä½“ç´ è´¨æä½³', effects: { physique: 15, spirit: 5 } },
            { id: 'tech_savvy', name: 'ç§‘æŠ€æ§', type: 'positive', cost: -12, description: 'å¯¹æ–°ç§‘æŠ€æœ‰ç€å¤©ç”Ÿçš„æ•æ„Ÿåº¦', effects: { comprehension: 12, spirit: 5, potential: 3 } },
            { id: 'street_smart', name: 'ç¤¾ä¼šç²¾è‹±', type: 'positive', cost: -15, description: 'æ·±è°™ç¤¾ä¼šè§„åˆ™ï¼Œå¤„äº‹åœ†æ»‘', effects: { charisma: 10, fortune: 8, spirit: 5 } },
            { id: 'born_leader', name: 'å¤©ç”Ÿé¢†è¢–', type: 'positive', cost: -20, description: 'å…·æœ‰é¢†å¯¼æ°”è´¨ï¼Œèƒ½å¤Ÿå·å¬ä»–äºº', effects: { charisma: 15, spirit: 8, potential: 5 } },
            { id: 'golden_voice', name: 'é‡‘å—“å­', type: 'positive', cost: -12, description: 'å£°éŸ³åŠ¨å¬ï¼Œæå…·æ„ŸæŸ“åŠ›', effects: { charisma: 12, spirit: 5, fortune: 3 } },
            { id: 'photogenic', name: 'ä¸Šé•œä½“è´¨', type: 'positive', cost: -10, description: 'é•œå¤´å‰ç‰¹åˆ«å¥½çœ‹ï¼Œå¤©ç”Ÿé€‚åˆåª’ä½“', effects: { charisma: 10, fortune: 5 } },
            { id: 'networking_master', name: 'äººè„‰ç‹', type: 'positive', cost: -18, description: 'è®¤è¯†å„è¡Œå„ä¸šçš„äººï¼Œèµ„æºä¸°å¯Œ', effects: { fortune: 12, charisma: 10, spirit: 3 } },
            { id: 'crisis_handler', name: 'å±æœºå¤„ç†ä¸“å®¶', type: 'positive', cost: -15, description: 'é¢å¯¹çªå‘æƒ…å†µå†·é™åº”å¯¹', effects: { spirit: 12, comprehension: 8, potential: 3 } },
            { id: 'jack_of_all_trades', name: 'ä¸‡äº‹é€š', type: 'positive', cost: -20, description: 'æ¶‰çŒå¹¿æ³›ï¼Œä»€ä¹ˆéƒ½æ‡‚ä¸€ç‚¹', effects: { comprehension: 10, potential: 10, spirit: 5 } },
            // è´Ÿé¢å¤©èµ‹
            { id: 'weak_constitution', name: 'ä½“å¼±å¤šç—…', type: 'negative', cost: 15, description: 'èº«ä½“ç´ è´¨å·®ï¼Œå®¹æ˜“ç”Ÿç—…', effects: { physique: -10, spirit: -3 } },
            { id: 'bad_luck', name: 'éœ‰è¿ç¼ èº«', type: 'negative', cost: 15, description: 'è¿æ°”ä¸ä½³ï¼Œå–æ°´éƒ½å¡ç‰™', effects: { fortune: -12 } },
            { id: 'slow_learner', name: 'å­¦ä¹ å›°éš¾', type: 'negative', cost: 12, description: 'å­¦ä¹ èƒ½åŠ›è¾ƒå·®ï¼Œç†è§£æ…¢', effects: { comprehension: -10 } },
            { id: 'social_anxiety', name: 'ç¤¾äº¤ææƒ§', type: 'negative', cost: 12, description: 'å®³æ€•ä¸äººäº¤æµï¼Œç¤¾äº¤å›°éš¾', effects: { charisma: -10, spirit: -3 } },
            { id: 'plain_looking', name: 'ç›¸è²Œå¹³å¹³', type: 'negative', cost: 10, description: 'é•¿ç›¸æ™®é€šï¼Œä¸èµ·çœ¼', effects: { charisma: -8 } },
            { id: 'debt_collector', name: 'è´Ÿå€ºä½“è´¨', type: 'negative', cost: 18, description: 'æ€»æ˜¯èŠ±é’±å¤§æ‰‹å¤§è„šï¼Œå®¹æ˜“è´Ÿå€º', effects: { fortune: -15, spirit: -5 } },
            { id: 'forgetful', name: 'å¥å¿˜ç—‡', type: 'negative', cost: 15, description: 'è®°æ€§å·®ï¼Œç»å¸¸å¿˜äº‹', effects: { comprehension: -8, spirit: -5, potential: -3 } },
            { id: 'chronic_fatigue', name: 'æ…¢æ€§ç–²åŠ³', type: 'negative', cost: 18, description: 'æ€»æ˜¯æ„Ÿè§‰ç´¯ï¼Œç²¾åŠ›ä¸æµ', effects: { physique: -8, spirit: -8, potential: -5 } },
            { id: 'procrastinator', name: 'æ‹–å»¶ç—‡', type: 'negative', cost: 12, description: 'åšäº‹æ‹–æ‹‰ï¼Œæ•ˆç‡ä½ä¸‹', effects: { potential: -10, spirit: -5 } },
            { id: 'pessimist', name: 'æ‚²è§‚ä¸»ä¹‰', type: 'negative', cost: 15, description: 'æ€»å¾€åå¤„æƒ³ï¼Œç¼ºä¹ä¿¡å¿ƒ', effects: { fortune: -10, spirit: -8 } },
            { id: 'tech_illiterate', name: 'ç§‘æŠ€å°ç™½', type: 'negative', cost: 12, description: 'å¯¹ç§‘æŠ€äº§å“ä¸€çªä¸é€š', effects: { comprehension: -8, potential: -5 } },
            { id: 'insomnia', name: 'å¤±çœ ç—‡', type: 'negative', cost: 15, description: 'ç¡çœ è´¨é‡å·®ï¼Œå½±å“ç²¾ç¥çŠ¶æ€', effects: { spirit: -10, physique: -5, comprehension: -3 } },
            { id: 'directionally_challenged', name: 'è·¯ç—´', type: 'negative', cost: 8, description: 'æ–¹å‘æ„Ÿæå·®ï¼Œç»å¸¸è¿·è·¯', effects: { spirit: -5, comprehension: -3 } },
            { id: 'stage_fright', name: 'æ€¯åœº', type: 'negative', cost: 12, description: 'é¢å¯¹äººç¾¤å°±ç´§å¼ ï¼Œå‘æŒ¥å¤±å¸¸', effects: { charisma: -8, spirit: -5, potential: -3 } },
            { id: 'addiction_prone', name: 'å®¹æ˜“ä¸Šç˜¾', type: 'negative', cost: 15, description: 'å¯¹å„ç§äº‹ç‰©å®¹æ˜“ä¸Šç˜¾ï¼Œè‡ªæ§åŠ›å·®', effects: { spirit: -10, potential: -8 } },
            { id: 'clumsy', name: 'æ‰‹è„šç¬¨æ‹™', type: 'negative', cost: 10, description: 'åŠ¨ä½œä¸åè°ƒï¼Œå®¹æ˜“å‡ºé”™', effects: { physique: -8, spirit: -3 } },
            { id: 'trust_issues', name: 'ä¿¡ä»»éšœç¢', type: 'negative', cost: 12, description: 'éš¾ä»¥ä¿¡ä»»ä»–äººï¼Œäººé™…å…³ç³»å·®', effects: { charisma: -10, fortune: -5 } },
            { id: 'perfectionist', name: 'å®Œç¾ä¸»ä¹‰', type: 'negative', cost: 10, description: 'è¿‡äºè¿½æ±‚å®Œç¾ï¼Œæ•ˆç‡ä½ä¸‹', effects: { potential: -8, spirit: -5 } }
        ];
        
        console.log('[xiandai] âœ… ç°ä»£é£æ ¼å‡ºèº«å’Œå¤©èµ‹å·²åŠ è½½');
        console.log('[xiandai] - origins æ•°é‡:', window.origins.length);
        console.log('[xiandai] - talents æ•°é‡:', window.talents.length);
    </script>
    
    <script src="../character-creation.js?v=20251118-2"></script>
    
    <script>
        // è§’è‰²åˆ›å»ºçŠ¶æ€ï¼ˆä»é…ç½®æ–‡ä»¶ä¸­è·å–ï¼‰
        // æ³¨æ„ï¼šè¿™ä¸ªå˜é‡ç°åœ¨ç”± xiuxian-config.js æä¾›ï¼Œå¦‚æœæœªåŠ è½½åˆ™ä½¿ç”¨å¤‡ç”¨æ•°æ®
        if (!window.characterCreation) {
            window.characterCreation = {
                difficulty: 'normal',
                maxPoints: 100,
                remainingPoints: 100,
                baseAttributes: {
                    physique: 10,      // ä½“è´¨
                    fortune: 10,       // æ°”è¿
                    comprehension: 10, // æ‚Ÿæ€§
                    spirit: 10,        // ç²¾ç¥
                    potential: 10,     // æ½œåŠ›
                    charisma: 10       // é­…åŠ›
                },
                selectedTalents: [],
                selectedGender: 'male',
                selectedOrigin: 'ordinary_citizen',
                usedPoints: 0
            };
        }
        // åˆ›å»ºå±€éƒ¨å¼•ç”¨ï¼Œæ–¹ä¾¿ä»£ç ä½¿ç”¨ï¼ˆä¸ä½¿ç”¨consté¿å…é‡å¤å£°æ˜ï¼‰
        var characterCreation = window.characterCreation;

        // æ¸¸æˆçŠ¶æ€ - è®¾ç½®ä¸ºå…¨å±€å˜é‡ä¾›äººç‰©å›¾è°±ä½¿ç”¨
        window.gameState = {
            variables: {
                currentDateTime: "",  // å½“å‰æ—¥æœŸæ—¶é—´
                name: "",
                age: 0,  // å¹´é¾„
                gender: "",
                identity: "",  // èº«ä»½
                spiritStones: 0,  // è´§å¸ï¼ˆç‹¬ç«‹å˜é‡ï¼‰
                hp: 100,  // ä½“åŠ›å½“å‰å€¼
                hpMax: 100,  // ä½“åŠ›æœ€å¤§å€¼
                mp: 100,  // æ³•åŠ›å½“å‰å€¼
                mpMax: 100,  // æ³•åŠ›æœ€å¤§å€¼
                talents: [],  // å¤©èµ‹åˆ—è¡¨
                // ğŸ†• åŠ¿åŠ›ä¿¡æ¯
                faction: null,  // åŠ¿åŠ›ä¿¡æ¯ {name: "åŠ¿åŠ›å", leader: "é¢†è¢–", location: "æ‰€åœ¨åœ°", members: ["æˆå‘˜1", "æˆå‘˜2"], description: "ä»‹ç»"}
                attributes: {
                    physique: 0,      // ä½“è´¨
                    fortune: 0,       // æ°”è¿
                    comprehension: 0, // æ‚Ÿæ€§
                    spirit: 0,        // ç²¾ç¥
                    potential: 0,     // æ½œåŠ›
                    charisma: 0       // é­…åŠ›
                },
                equipment: {
                    head: null,
                    clothes: null,
                    feet: null,
                    treasure1: null,
                    treasure2: null,
                    treasure3: null
                },
                items: [],
                relationships: [],
                location: "",
                history: []
            },
            previousVariables: null, // ç”¨äºè®¡ç®—å˜åŒ–
            conversationHistory: [], // åªå­˜å‚¨å‰§æƒ…ï¼Œä¸å«å˜é‡å’Œé€‰é¡¹
            variableSnapshots: [], // æ¯æ¡æ¶ˆæ¯å¯¹åº”çš„å˜é‡å¿«ç…§
            isGameStarted: false,
            isProcessing: false,
            localOps: { items: [], attrs: [], equip: [] },
            deleteMode: false, // åˆ é™¤æ¨¡å¼æ ‡å¿—
            // åŠ¨æ€ä¸–ç•Œç›¸å…³
            dynamicWorld: {
                enabled: false,
                history: [], // åŠ¨æ€ä¸–ç•Œç”Ÿæˆçš„å†å²è®°å½•
                floor: 0, // å½“å‰æ¥¼å±‚
                isProcessing: false,
                messageInterval: 1, // ç”Ÿæˆé—´éš”ï¼ˆæ¯Næ¬¡ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆä¸€æ¬¡ï¼‰
                messageCounter: 0 // ç”¨æˆ·æ¶ˆæ¯è®¡æ•°å™¨
            },
            // æ“ä½œç¼“å­˜ï¼šè®°å½•ç”¨æˆ·çš„UIæ“ä½œï¼Œåœ¨ä¸‹æ¬¡ä¸AIäº¤äº’æ—¶è‡ªåŠ¨é™„åŠ 
            pendingActions: {
                pills: {},      // è®°å½•æœç”¨çš„ä¸¹è¯ {ä¸¹è¯å: æ•°é‡}
                equipment: null // è®°å½•æœ€åè£…å¤‡çš„è£…å¤‡å
            }
        };

        // APIé…ç½®
        const apiConfig = {
            type: 'openai',
            endpoint: '',
            key: '',
            model: 'gpt-4o-mini',
            availableModels: []
        };

        // é¢å¤–APIé…ç½®
        const extraApiConfig = {
            enabled: false,
            type: 'openai',
            endpoint: '',
            key: '',
            model: 'gpt-4o-mini',
            availableModels: []
        };

        // ==================== æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿ ====================
        // å·²è¿ç§»åˆ° game-core-systems.js
        // åŒ…æ‹¬ï¼šinitDB, saveGameHistory, saveGameToSlot, loadGameHistory, 
        // loadGameFromSlot, getAllSaves, deleteSave, clearGameHistory,
        // exportSaveToFile, exportCurrentGame, importSaveFromFile,
        // loadSaveData, syncVectorLibraryFromHistory

        // ä»¥ä¸‹å‡½æ•°å·²è¿ç§»åˆ° game-core-systems.js:
        // - saveCurrentGame
        // - showLoadSaveMenu  
        // - loadSelectedSave
        // - deleteSelectedSave
        // - closeLoadSaveMenu

        // æ˜¾ç¤ºä¸»èœå•
        function showMainMenu() {
            const historyDiv = document.getElementById('gameHistory');
            historyDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px;">
                    <div style="display: flex; flex-direction: column; gap: 20px; max-width: 400px;">
                        <button onclick="startNewGame()" 
                                style="padding: 20px 40px; font-size: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                            ğŸŒŸ å¼€å§‹æ–°æ¸¸æˆ
                        </button>
                        
                        <button onclick="showLoadSaveMenu()" 
                                style="padding: 20px 40px; font-size: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(240, 147, 251, 0.6)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(240, 147, 251, 0.4)'">
                            ğŸ“‚ åŠ è½½å­˜æ¡£
                        </button>
                        
                        <button onclick="importSaveFromFile()" 
                                style="padding: 20px 40px; font-size: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(79, 172, 254, 0.6)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(79, 172, 254, 0.4)'">
                            ğŸ“¥ å¯¼å…¥å­˜æ¡£
                        </button>
                    </div>
                    
                    <p style="color: #999; font-size: 14px; margin-top: 50px;">æç¤ºï¼šè¯·å…ˆåœ¨è®¾ç½®é…ç½®APIè¿æ¥</p>
                </div>
            `;
        }

        // å¼€å§‹æ–°æ¸¸æˆ
        async function startNewGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.variables = {
                name: "",
                gender: "",
                realm: "",
                identity: "",
                karmaFortune: 0,
                karmaPunishment: 0,
                cultivationProgress: 0,
                cultivationProgressMax: 100,
                hp: 100,
                hpMax: 100,
                mp: 100,
                mpMax: 100,
                talents: [],
                attributes: {
                    physique: 0,
                    fortune: 0,
                    comprehension: 0,
                    spirit: 0,
                    potential: 0,
                    charisma: 0
                },
                equipment: {
                    head: null,
                    clothes: null,
                    feet: null,
                    treasure1: null,
                    treasure2: null,
                    treasure3: null
                },
                items: [],
                techniques: [],
                spells: [],
                relationships: [],
                location: "",
                history: []
            };
            gameState.previousVariables = null;
            gameState.conversationHistory = [];
            gameState.variableSnapshots = [];
            gameState.isGameStarted = false;
            gameState.characterInfo = null;

            // æ¸…ç©ºå‘é‡åº“ï¼ˆæ–°æ¸¸æˆä¸åº”ä¿ç•™æ—§å­˜æ¡£çš„è®°å¿†ï¼‰
            if (window.contextVectorManager) {
                window.contextVectorManager.clear();
                // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿IndexedDBæ¸…ç©ºå®Œæˆ
                try {
                    await window.contextVectorManager.saveToIndexedDB();
                    console.log('[æ–°æ¸¸æˆ] âœ… å·²æ¸…ç©ºå‘é‡åº“ï¼ˆå«IndexedDBï¼‰');
                } catch (err) {
                    console.error('[æ–°æ¸¸æˆ] âŒ æ¸…ç©ºå‘é‡åº“å¤±è´¥:', err);
                }
            }
            
            // ğŸ†• æ¸…ç©ºçŸ©é˜µï¼ˆæ–°æ¸¸æˆä¸åº”ä¿ç•™æ—§å­˜æ¡£çš„çŸ©é˜µæ•°æ®ï¼‰
            if (window.matrixManager) {
                window.matrixManager.clear();
                console.log('[æ–°æ¸¸æˆ] âœ… å·²æ¸…ç©ºçŸ©é˜µæ•°æ®');
            }
            
            // ğŸ†• æ¸…ç©ºäººç‰©å›¾è°±ï¼ˆæ–°æ¸¸æˆä¸åº”ä¿ç•™æ—§å­˜æ¡£çš„äººç‰©ï¼‰
            if (window.characterGraphManager) {
                window.characterGraphManager.characters.clear();
                window.characterGraphManager.vectors.clear();
                window.characterGraphManager.stats = {
                    totalCharacters: 0,
                    lastUpdate: null,
                    matchCount: 0,
                    avgMatchScore: 0
                };
                // æ¸…ç©ºIndexedDBä¸­çš„äººç‰©å›¾è°±æ•°æ®
                (async () => {
                    try {
                        const db = window.characterGraphManager.indexedDB;
                        if (db) {
                            const transaction = db.transaction(['characters'], 'readwrite');
                            const store = transaction.objectStore('characters');
                            await store.clear();
                            console.log('[æ–°æ¸¸æˆ] å·²æ¸…ç©ºäººç‰©å›¾è°±IndexedDB');
                        }
                    } catch (error) {
                        console.error('[æ–°æ¸¸æˆ] æ¸…ç©ºäººç‰©å›¾è°±å¤±è´¥:', error);
                    }
                })();
                console.log('[æ–°æ¸¸æˆ] å·²æ¸…ç©ºäººç‰©å›¾è°±');
            }

            // é‡ç½®åŠ¨æ€ä¸–ç•Œæ•°æ®
            gameState.dynamicWorld = {
                enabled: gameState.dynamicWorld?.enabled || false, // ä¿ç•™å¯ç”¨çŠ¶æ€è®¾ç½®
                history: [],
                floor: 0,
                isProcessing: false,
                messageInterval: gameState.dynamicWorld?.messageInterval || 1, // ä¿ç•™é—´éš”è®¾ç½®
                messageCounter: 0 // é‡ç½®è®¡æ•°å™¨
            };
            console.log('[æ–°æ¸¸æˆ] å·²é‡ç½®åŠ¨æ€ä¸–ç•Œæ•°æ®');
            
            // æ›´æ–°åŠ¨æ€ä¸–ç•ŒTabæ˜¾ç¤º
            displayDynamicWorldHistory();

            // é‡ç½®è§’è‰²åˆ›å»ºçŠ¶æ€
            characterCreation.difficulty = 'normal';
            characterCreation.maxPoints = 100;
            characterCreation.remainingPoints = 100;
            characterCreation.baseAttributes = {
                physique: 10,
                fortune: 10,
                comprehension: 10,
                spirit: 10,
                potential: 10,
                charisma: 10
            };
            characterCreation.selectedTalents = [];
            
            // ğŸ†• æç¤ºç”¨æˆ·æ•°æ®å·²æ¸…ç©º
            console.log('[æ–°æ¸¸æˆ] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('[æ–°æ¸¸æˆ] âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼ŒåŒ…æ‹¬ï¼š');
            console.log('[æ–°æ¸¸æˆ]   - æ¸¸æˆå˜é‡');
            console.log('[æ–°æ¸¸æˆ]   - å¯¹è¯å†å²');
            console.log('[æ–°æ¸¸æˆ]   - å‘é‡åº“ï¼ˆåŒ…æ‹¬IndexedDBï¼‰');
            console.log('[æ–°æ¸¸æˆ]   - çŸ©é˜µæ•°æ®');
            console.log('[æ–°æ¸¸æˆ]   - äººç‰©å›¾è°±');
            console.log('[æ–°æ¸¸æˆ] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            characterCreation.selectedGender = 'male';
            characterCreation.selectedOrigin = 'commoner';
            characterCreation.usedPoints = 0;

            // æ˜¾ç¤ºè§’è‰²åˆ›å»ºç•Œé¢
            displayCharacterCreationInHistory();
        }

        // ========== è§’è‰²åˆ›å»ºç³»ç»Ÿå‡½æ•° ==========
        // âœ… å·²å®Œæ•´è¿ç§»åˆ° character-creation.js
        // åŒ…æ‹¬æ‰€æœ‰è§’è‰²åˆ›å»ºç›¸å…³å‡½æ•°ï¼š
        // - initializeOrigins, selectOrigin
        // - initializeTalents, toggleTalent
        // - selectDifficulty, selectGender
        // - adjustAttribute, updateAttributesDisplay, updatePointsDisplay
        // - confirmCharacterCreation, displayCharacterCreationInHistory
        // - getAttributeName

        // ========== æ¸¸æˆä¸»é€»è¾‘ ==========
        // å·²è¿ç§»åˆ° game-initialization.js

        // æ„å»ºå‘é€ç»™AIçš„æ¶ˆæ¯
        async function buildAIMessages(userMessage, originalUserInput = null) {
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¿®ä»™æ¸¸æˆè§„åˆ™åœ¨æœ€é¡¶éƒ¨ï¼Œç›´æ¥ä½¿ç”¨ defaultSystemPrompt ä½œä¸ºç³»ç»Ÿæç¤ºè¯
            let systemPrompt;
            
            // ä¼˜å…ˆä½¿ç”¨ defaultSystemPromptï¼ˆä¿®ä»™æ¸¸æˆæ ¸å¿ƒè§„åˆ™ï¼‰
            if (typeof defaultSystemPrompt !== 'undefined') {
                systemPrompt = defaultSystemPrompt;
                console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ§¾ ä½¿ç”¨ defaultSystemPromptï¼ˆä¿®ä»™æ ¸å¿ƒè§„åˆ™ï¼‰ä½œä¸ºæœ€é¡¶éƒ¨ç³»ç»Ÿæç¤ºè¯');
            } else if (typeof getSystemPrompt === 'function') {
                systemPrompt = getSystemPrompt();
                console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ® ä½¿ç”¨ getSystemPrompt() ä½œä¸ºç³»ç»Ÿæç¤ºè¯');
            } else {
                systemPrompt = document.getElementById('systemPrompt').value || 'ä½ æ˜¯ä¸€ä¸ªä¿®ä»™ä¸–ç•Œçš„æ¸¸æˆä¸»æŒäººã€‚';
                console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ“ ä½¿ç”¨ textarea å†…å®¹ä½œä¸ºç³»ç»Ÿæç¤ºè¯');
            }
            
            console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ“ æœ€ç»ˆç³»ç»Ÿæç¤ºè¯é•¿åº¦:', systemPrompt.length);
            console.log('[ç³»ç»Ÿæç¤ºè¯] ğŸ“‹ å‰100å­—ç¬¦:', systemPrompt.substring(0, 100));
            const historyDepthInput = document.getElementById('historyDepth');
            const historyDepth = historyDepthInput ? parseInt(historyDepthInput.value) : 10;
            const minWordCountInput = document.getElementById('minWordCount');
            const minWordCount = minWordCountInput ? parseInt(minWordCountInput.value) : 0;
            
            // è·å–å™äº‹è§†è§’è®¾ç½®
            const narrativePerspectiveInput = document.getElementById('narrativePerspective');
            const narrativePerspective = narrativePerspectiveInput ? narrativePerspectiveInput.value : 'first';
            
            console.log('[å™äº‹è§†è§’] å½“å‰è®¾ç½®çš„è§†è§’:', narrativePerspective);
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨å‘é‡æ£€ç´¢
            const enableVectorRetrieval = document.getElementById('enableVectorRetrieval')?.checked || false;
            
            let messages = [];

            // æ·»åŠ ç³»ç»Ÿæç¤º
            let finalSystemPrompt = systemPrompt;
            
            // å™äº‹è§†è§’åœ¨éå‘é‡æ£€ç´¢æ¨¡å¼ä¸‹ä½œä¸ºç‹¬ç«‹æ¶ˆæ¯ï¼ˆæœ€ä¼˜å…ˆçº§ï¼‰
            if (!enableVectorRetrieval) {
                const perspectivePrompts = {
                    'first': 'ã€æå…¶é‡è¦ã€‘å™äº‹è§†è§’å¼ºåˆ¶è¦æ±‚ï¼šæ•…äº‹æå†™éœ€è¦ä»¥ä¸»è§’ç¬¬ä¸€äººç§°è§†è§’ä¸ºä¸»ï¼Œå…è®¸è‡ªç„¶å™è¿°ä¸å¯¹è¯',
            'second': 'ã€æå…¶é‡è¦ã€‘å™äº‹è§†è§’å¼ºåˆ¶è¦æ±‚ï¼šæ•…äº‹æå†™éœ€è¦ä»¥ä¸»è§’ç¬¬äºŒäººç§°è§†è§’ä¸ºä¸»ï¼Œå…è®¸è‡ªç„¶å™è¿°ä¸å¯¹è¯',
            'third': 'ã€æå…¶é‡è¦ã€‘å™äº‹è§†è§’å¼ºåˆ¶è¦æ±‚ï¼šæ•…äº‹æå†™éœ€è¦ä»¥ä¸»è§’ç¬¬ä¸‰äººç§°è§†è§’ä¸ºä¸»ï¼Œå…è®¸è‡ªç„¶å™è¿°ä¸å¯¹è¯'
                };
                
                // å™äº‹è§†è§’ä½œä¸ºç¬¬ä¸€ä¸ªç³»ç»Ÿæ¶ˆæ¯
                messages.unshift({
                    role: 'system',
                    content: perspectivePrompts[narrativePerspective]
                });
                
                console.log('[å™äº‹è§†è§’] æ·»åŠ çš„æç¤ºè¯:', perspectivePrompts[narrativePerspective]);
            }
            
            // è®¾ç½®å…¨å±€å™äº‹è§†è§’å˜é‡ï¼Œä¾›å‘é‡æ£€ç´¢æ¨¡å¼ä½¿ç”¨
            window.currentNarrativePerspective = narrativePerspective;
            
            if (minWordCount > 0) {
                finalSystemPrompt += `\n\nã€é‡è¦ã€‘å­—æ•°è¦æ±‚ï¼šä½ çš„å›å¤ä¸­"story"å­—æ®µå¿…é¡»è‡³å°‘åŒ…å«${minWordCount}ä¸ªä¸­æ–‡å­—ç¬¦ã€‚è¯·ç¡®ä¿å‰§æƒ…æå†™è¯¦ç»†ã€ç”ŸåŠ¨ã€å……å®ï¼Œè¾¾åˆ°å­—æ•°è¦æ±‚ã€‚`;
            }
            
            // å†æ¬¡å¼ºåŒ–å™äº‹è§†è§’è¦æ±‚ï¼ˆåœ¨ç³»ç»Ÿæç¤ºè¯æœ«å°¾ï¼‰
            const reinforcementText = {
                'first': '\n\nã€æœ€ç»ˆæé†’ã€‘ä¸¥æ ¼éµå®ˆå™äº‹è§†è§’ï¼šå¿…é¡»ä½¿ç”¨ç¬¬ä¸€äººç§°"æˆ‘"ï¼Œç»å¯¹ç¦æ­¢ä½¿ç”¨"ä½ "æˆ–"ä»–/å¥¹"æè¿°ä¸»è§’ï¼å¥½çš„ï¼Œæˆ‘å·²å®Œæ•´è¾“å‡ºï¼Œè°¢è°¢æ‚¨çš„ä½¿ç”¨ï¼',
                'second': '\n\nã€æœ€ç»ˆæé†’ã€‘ä¸¥æ ¼éµå®ˆå™äº‹è§†è§’ï¼šå¿…é¡»ä½¿ç”¨ç¬¬äºŒäººç§°"ä½ "ï¼Œç»å¯¹ç¦æ­¢ä½¿ç”¨"æˆ‘"æˆ–"ä»–/å¥¹"æè¿°ä¸»è§’ï¼å¥½çš„ï¼Œæˆ‘å·²å®Œæ•´è¾“å‡ºï¼Œè°¢è°¢æ‚¨çš„ä½¿ç”¨ï¼',
                'third': '\n\nã€æœ€ç»ˆæé†’ã€‘ä¸¥æ ¼éµå®ˆå™äº‹è§†è§’ï¼šå¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°"ä»–/å¥¹"ï¼Œç»å¯¹ç¦æ­¢ä½¿ç”¨"æˆ‘"æˆ–"ä½ "æè¿°ä¸»è§’ï¼å¥½çš„ï¼Œæˆ‘å·²å®Œæ•´è¾“å‡ºï¼Œè°¢è°¢æ‚¨çš„ä½¿ç”¨ï¼'
            };
            finalSystemPrompt += reinforcementText[narrativePerspective];
            
            // ã€æ–°å¢ã€‘å¦‚æœå¯ç”¨å‘é‡æ£€ç´¢ï¼Œä½¿ç”¨ä¼˜åŒ–åçš„ä¸Šä¸‹æ–‡æ„å»º
            if (enableVectorRetrieval && window.contextVectorManager) {
                console.log('[å‘é‡æ£€ç´¢æ¨¡å¼] ä½¿ç”¨æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º');
                // æ„å»ºåŒ…å«å®é™…å±æ€§çš„å˜é‡çŠ¶æ€
                const variablesForAI = {
                    ...gameState.variables,
                    attributes: calculateActualAttributes() // ä½¿ç”¨å®é™…å±æ€§ï¼ˆåŒ…å«è£…å¤‡åŠ æˆï¼‰
                };
                // ğŸ”§ å…³é”®ä¿®å¤ï¼šä¼ å…¥åŸå§‹ç”¨æˆ·è¾“å…¥ç”¨äºå‘é‡æ£€ç´¢
                const inputForRetrieval = originalUserInput || userMessage;
                messages = await window.contextVectorManager.buildOptimizedMessages(
                    finalSystemPrompt,
                    variablesForAI,
                    userMessage,
                    historyDepth,
                    gameState.conversationHistory,
                    inputForRetrieval  // ğŸ‘ˆ æ–°å¢ï¼šç”¨äºå‘é‡æ£€ç´¢çš„åŸå§‹è¾“å…¥
                );
                return messages;
            }
            
            // ã€åŸæœ‰é€»è¾‘ã€‘ä¸ä½¿ç”¨å‘é‡æ£€ç´¢çš„æƒ…å†µ
            messages.push({
                role: 'system',
                content: finalSystemPrompt
            });

            // æ·»åŠ å½“å‰å˜é‡çŠ¶æ€ï¼ˆä½¿ç”¨å®é™…å±æ€§ï¼ŒåŒ…å«è£…å¤‡åŠ æˆï¼‰
            const variablesForAI = {
                ...gameState.variables,
                attributes: calculateActualAttributes() // ä½¿ç”¨å®é™…å±æ€§ï¼ˆåŒ…å«è£…å¤‡åŠ æˆï¼‰
            };
            messages.push({
                role: 'system',
                content: 'å½“å‰è§’è‰²å˜é‡çŠ¶æ€ï¼š\n```json\n' + JSON.stringify(variablesForAI, null, 2) + '\n```'
            });

            // æ ¹æ®å†å²å±‚æ•°æ§åˆ¶æ·»åŠ å¯¹è¯å†å²
            if (historyDepth > 0) {
                // å‘é€æœ€è¿‘Nå±‚çš„å¯¹è¯ï¼ˆåªå‘é€å‰§æƒ…å†…å®¹ï¼Œä¸å‘é€é€‰é¡¹ï¼‰
                const recentHistory = gameState.conversationHistory.slice(-historyDepth * 2); // ä¹˜2å› ä¸ºåŒ…å«ç”¨æˆ·å’ŒAIçš„æ¶ˆæ¯
                messages = messages.concat(recentHistory);
            }
            // å¦‚æœhistoryDepthä¸º0ï¼Œåˆ™ä¸æ·»åŠ ä»»ä½•å¯¹è¯å†å²

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            messages.push({
                role: 'user',
                content: userMessage
            });

            return messages;
        }







        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            if (gameState.isProcessing) return;

            if (!apiConfig.endpoint || !apiConfig.key) {
                alert('è¯·å…ˆé…ç½®APIè¿æ¥');
                return;
            }

            gameState.isProcessing = true;

            // ğŸ”§ å°† initPrompt æå‡åˆ°å¤–éƒ¨ä½œç”¨åŸŸï¼Œä¾› catch ä½¿ç”¨
            let initPrompt = 'å¼€å§‹æ¸¸æˆï¼Œç”Ÿæˆå‰§æƒ…åŠé€‰é¡¹ã€‚';

            try {
                // æ„å»ºè§’è‰²åˆå§‹åŒ–æç¤º
                if (gameState.characterInfo) {
                    const info = gameState.characterInfo;
                    initPrompt = `å¼€å§‹æ¸¸æˆã€‚è§’è‰²ä¿¡æ¯ï¼šå§“å${info.name}ï¼Œå¹´é¾„${info.age}å²ï¼Œæ€§åˆ«${info.gender}ï¼Œæ€§æ ¼${info.personality}ã€‚å‡ºèº«ï¼š${info.origin}ã€‚éš¾åº¦ï¼š${info.difficulty}ã€‚`;
                    if (info.talents && info.talents.length > 0) {
                        initPrompt += `å¤©èµ‹ï¼š${info.talents.join('ã€')}ã€‚`;
                    }
                    if (info.customSettings) {
                        initPrompt += `ç‰¹æ®Šè®¾å®šï¼š${info.customSettings}ã€‚`;
                    }
                    initPrompt += `è¯·æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªå¼•äººå…¥èƒœçš„å¼€å±€å‰§æƒ…å’Œé€‰é¡¹ã€‚`;
                    
                    // ã€å…³é”®è¦æ±‚ã€‘å¿…é¡»ç”Ÿæˆçš„åˆå§‹å˜é‡å’Œæ•°æ®ç»“æ„
                    initPrompt += `\n\nã€æå…¶é‡è¦ã€‘å¿…é¡»åœ¨è¿”å›çš„JSONä¸­åŒ…å«ä»¥ä¸‹å®Œæ•´å­—æ®µç»“æ„ï¼š`;
                    initPrompt += `\n1. equipmentå­—æ®µï¼šæ ¹æ®è§’è‰²å‡ºèº«å’Œèº«ä»½è‡ªåŠ¨ç”Ÿæˆåˆé€‚çš„åˆå§‹è£…å¤‡`;
                    initPrompt += `   - è£…å¤‡å“è´¨å’Œå±æ€§è¦ä¸èº«ä»½åŒ¹é…`;
                    initPrompt += `\n2. variableså­—æ®µï¼šå¿…é¡»è®¾ç½®currentDateTimeã€factionå’ŒminWordCountå­—æ®µ`;
                    initPrompt += `   - currentDateTimeï¼šä¸–ç•Œæ—¥æœŸæ—¶é—´ï¼ˆæ ¼å¼ï¼šå†œå†XXXXå¹´XæœˆXæ—¥ ä¸Šåˆï¼‰`;
                    initPrompt += `   - factionï¼šã€æå…¶é‡è¦ã€‘è§’è‰²æ‰€å±åŠ¿åŠ›ï¼Œæ ¹æ®å‡ºèº«è‡ªåŠ¨åˆ†é…`;
                    initPrompt += `   - åŠ¿åŠ›ä¿¡æ¯å½±å“åç»­å‰§æƒ…å‘å±•å’ŒNPCå…³ç³»`;
                    initPrompt += `   - minWordCountï¼š${document.getElementById('minWordCount').value}`;
                    initPrompt += `   - æ‰€æœ‰åç»­å‰§æƒ…å›å¤éƒ½å¿…é¡»è¾¾åˆ°æˆ–è¶…è¿‡æ­¤å­—æ•°è¦æ±‚`;
                    initPrompt += `\n3. statså­—æ®µï¼šè§’è‰²åŸºç¡€å±æ€§`;
                    initPrompt += `   - åŒ…å«ï¼šç”Ÿå‘½å€¼ã€ç²¾åŠ›å€¼ç­‰åŸºç¡€æ•°æ®`;
                    initPrompt += `   - æ ¹æ®å‡ºèº«å’Œå¤©èµ‹åˆç†åˆ†é…åˆå§‹å±æ€§`;                    
                }

                // å°†åˆå§‹åŒ–æç¤ºæ·»åŠ åˆ°å†å²è®°å½•ä¸­ï¼Œä»¥ä¾¿é‡æ–°ç”ŸæˆåŠŸèƒ½èƒ½æ­£å¸¸å·¥ä½œ
                gameState.conversationHistory.push({
                    role: 'user',
                    content: initPrompt
                });

                const response = await callAI(initPrompt);

                // æ¸…ç©ºæ¸¸æˆå†å²åŒºåŸŸï¼ˆç§»é™¤åŠ è½½æç¤ºï¼‰
                document.getElementById('gameHistory').innerHTML = '';

                // æ˜¾ç¤ºåˆå§‹åŒ–æ¶ˆæ¯
                displayUserMessage(initPrompt);

                handleAIResponse(response);
                gameState.isGameStarted = true;

                // ä¿å­˜æ¸¸æˆå†å²ï¼ˆæ ‡è®°æ¸¸æˆå·²å¼€å§‹ï¼‰
                await saveGameHistory();

                // è§¦å‘åŠ¨æ€ä¸–ç•Œç”Ÿæˆï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                generateDynamicWorld().catch(err => console.error('[åŠ¨æ€ä¸–ç•Œ] ç”Ÿæˆå¼‚å¸¸:', err));

            } catch (error) {
                // âŒ ä¸è¦æ¸…ç©ºå†å²ï¼åªç§»é™¤åŠ è½½æç¤º
                const loadingMsg = document.querySelector('#gameHistory .message.ai-message');
                if (loadingMsg && loadingMsg.textContent.includes('AIç”Ÿæˆå¼€å±€å‰§æƒ…ä¸­')) {
                    loadingMsg.remove();
                }

                // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆå¦‚æœè¿˜æ²¡æ˜¾ç¤ºï¼‰
                if (document.getElementById('gameHistory').children.length === 0) {
                    displayUserMessage(initPrompt);
                }

                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å’Œé‡è¯•æŒ‰é’®
                displayErrorMessageWithRetry('æ¸¸æˆå¯åŠ¨å¤±è´¥ï¼š' + error.message + '\n\nå¯èƒ½åŸå› ï¼šç½‘ç»œè¶…æ—¶ã€APIå¯†é’¥é”™è¯¯ã€æ¨¡å‹ä¸å¯ç”¨', async () => {
                    // ç§»é™¤é”™è¯¯æ¶ˆæ¯
                    dismissError();
                    
                    // ğŸ”§ ä»å†å²è®°å½•ä¸­ç§»é™¤å¤±è´¥çš„è¯·æ±‚ï¼ˆé¿å…é‡å¤ï¼‰
                    const lastMsg = gameState.conversationHistory[gameState.conversationHistory.length - 1];
                    if (lastMsg && lastMsg.role === 'user' && lastMsg.content === initPrompt) {
                        gameState.conversationHistory.pop();
                        gameState.variableSnapshots.pop(); // åŒæ—¶ç§»é™¤å¿«ç…§
                    }
                    
                    // é‡æ–°å¼€å§‹æ¸¸æˆ
                    await startGame();
                });
            }

            gameState.isProcessing = false;
        }

        /**
         * ğŸ†• æå–å¹¶æ·»åŠ historyåˆ°çŸ©é˜µ
         * @param {string} variableUpdate - variableUpdateå­—ç¬¦ä¸²
         * @param {number} turnIndex - è½®æ¬¡ç´¢å¼•
         */
        async function extractAndAddHistoryToMatrix(variableUpdate, turnIndex) {
            if (!window.contextVectorManager || !window.matrixManager) {
                return;
            }
            
            try {
                // ä»variableUpdateä¸­æå–history
                const historyItems = [];
                
                // åŒ¹é… >>history: æ–‡æœ¬ æ ¼å¼
                const singleHistoryRegex = />>history:\s*(.+)/g;
                let match;
                while ((match = singleHistoryRegex.exec(variableUpdate)) !== null) {
                    historyItems.push(match[1].trim());
                }
                
                // åŒ¹é… history:\n  - æ–‡æœ¬ æ ¼å¼
                const multiHistoryRegex = /history:\s*\n\s*-\s*(.+)/g;
                while ((match = multiHistoryRegex.exec(variableUpdate)) !== null) {
                    historyItems.push(match[1].trim());
                }
                
                if (historyItems.length === 0) {
                    console.log('[HistoryçŸ©é˜µ] æœ¬è½®æœªæ‰¾åˆ°historyå­—æ®µ');
                    return;
                }
                
                console.log(`[HistoryçŸ©é˜µ] ğŸ“¥ æå–åˆ° ${historyItems.length} æ¡history`);
                
                // æ·»åŠ åˆ°çŸ©é˜µ
                for (const historyText of historyItems) {
                    await window.contextVectorManager.addHistoryEntry(
                        historyText,
                        turnIndex,
                        gameState.variables
                    );
                }
                
                console.log(`[HistoryçŸ©é˜µ] âœ… å·²æ·»åŠ  ${historyItems.length} æ¡historyåˆ°çŸ©é˜µ`);
            } catch (error) {
                console.error('[HistoryçŸ©é˜µ] âŒ æ·»åŠ å¤±è´¥:', error);
            }
        }

        // å¤„ç†AIå“åº”
        function handleAIResponse(response) {
            // è°ƒè¯•æ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºåŸå§‹å“åº”ï¼Œä¸åšä»»ä½•è§£ææˆ–æ¸²æŸ“å¤„ç†
            const debugCheckbox = document.getElementById('debugMode');
            if (debugCheckbox && debugCheckbox.checked) {
                appendDebug('AI', response);
                // è°ƒè¯•æ¨¡å¼ä¸‹ä»…å±•ç¤ºï¼Œä¸å…¥åº“ä¸å˜é‡æ›´æ–°
                return;
            }

            // âœ… ä½¿ç”¨å¢å¼ºç‰ˆJSONå¤„ç†å·¥å…·ï¼ˆä¿è¯ä¸ä¼šå¤±è´¥ï¼‰
            let data;
            try {
                data = processAIResponse(response);
            } catch (error) {
                console.error('âŒ processAIResponseå¼‚å¸¸:', error);
                // é™çº§æ–¹æ¡ˆï¼šæ„é€ æœ€å°å¯ç”¨æ•°æ®
                data = {
                    reasoning: { situation: 'è§£æå¼‚å¸¸', playerChoice: '', logicChain: [], outcome: '' },
                    variableChanges: { analysis: 'Parse error', changes: {} },
                    story: 'ç³»ç»Ÿé”™è¯¯ï¼šAIå“åº”è§£æå¤±è´¥\n\n' + response.substring(0, 500),
                    options: ['é‡æ–°ç”Ÿæˆ', 'å°è¯•ç»§ç»­', 'æŸ¥çœ‹æ—¥å¿—', 'è¿”å›èœå•', 'ä¿å­˜é€€å‡º']
                };
            }

            // æ›´æ–°å˜é‡ï¼ˆæ”¯æŒä¸‰ç§æ ¼å¼ï¼‰
            console.log('[game.html] å¼€å§‹å¤„ç†å˜é‡æ›´æ–°ï¼Œdataå¯¹è±¡:', data);
            console.log('[game.html] data.variableUpdate å­˜åœ¨:', !!data.variableUpdate);
            console.log('[game.html] data.variableChanges å­˜åœ¨:', !!data.variableChanges);
            console.log('[game.html] data.variables å­˜åœ¨:', !!data.variables);
            
            if (data.variableUpdate) {
                try {
                    // v3.1 ç®€åŒ–æ ¼å¼ï¼ˆæ¨èï¼‰
                    console.log('[v3.1] ğŸ¯ ä½¿ç”¨ v3.1 ç®€åŒ–æ ¼å¼æ›´æ–°å˜é‡');
                    console.log('[v3.1] variableUpdate å†…å®¹:', data.variableUpdate);
                    
                    // åˆå§‹åŒ– v3.1 è§£æå™¨
                    if (!window.v31Parser) {
                        console.log('[v3.1] åˆå§‹åŒ–è§£æå™¨...');
                        window.v31Parser = new VariableInstructionParserV31(gameState, {
                            debug: true,
                            enableRollback: false
                        });
                        console.log('[v3.1] è§£æå™¨åˆå§‹åŒ–å®Œæˆ');
                    }
                    
                    // è§£æå¹¶æ‰§è¡Œå˜é‡æ›´æ–°
                    const result = window.v31Parser.execute(data.variableUpdate);
                    console.log('[v3.1] âœ… æ›´æ–°ç»“æœ:', result);
                    
                    // ğŸ†• è‡ªåŠ¨æå–äººç‰©åˆ°å›¾è°±
                    if (window.characterGraphIntegration && 
                        window.characterGraphIntegration.isEnabled && 
                        gameState.variables && 
                        gameState.variables.relationships && 
                        Array.isArray(gameState.variables.relationships)) {
                        console.log(`[äººç‰©å›¾è°±] ğŸ“¥ è‡ªåŠ¨æå– ${gameState.variables.relationships.length} ä¸ªäººç‰©åˆ°å›¾è°±...`);
                        window.characterGraphIntegration.extractCharactersFromResponse(gameState.variables.relationships)
                            .catch(err => console.error('[äººç‰©å›¾è°±] æå–å¤±è´¥:', err));
                    }
                    
                    updateStatusPanel();
                    showAttributeChanges();
                } catch (error) {
                    console.error('âŒ v3.1 å˜é‡æ›´æ–°å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    console.error('variableUpdateå†…å®¹:', data.variableUpdate);
                }
            } else if (data.variableChanges) {
                try {
                    // æ—§æ–¹æ¡ˆï¼šå¢é‡æ›´æ–°
                    applyVariableChanges(data.variableChanges);
                    
                    // ğŸ†• è‡ªåŠ¨æå–äººç‰©åˆ°å›¾è°±
                    if (window.characterGraphIntegration && 
                        window.characterGraphIntegration.isEnabled && 
                        gameState.variables && 
                        gameState.variables.relationships && 
                        Array.isArray(gameState.variables.relationships)) {
                        console.log(`[äººç‰©å›¾è°±] ğŸ“¥ è‡ªåŠ¨æå– ${gameState.variables.relationships.length} ä¸ªäººç‰©åˆ°å›¾è°±...`);
                        window.characterGraphIntegration.extractCharactersFromResponse(gameState.variables.relationships)
                            .catch(err => console.error('[äººç‰©å›¾è°±] æå–å¤±è´¥:', err));
                    }
                    
                    updateStatusPanel();
                    showAttributeChanges();
                } catch (error) {
                    console.error('âŒ å˜é‡æ›´æ–°å¤±è´¥:', error);
                }
            } else if (data.variables) {
                try {
                    // æ—§æ–¹æ¡ˆï¼šå®Œæ•´å˜é‡è¡¨å•ï¼ˆå‘åå…¼å®¹ï¼‰
                    updateVariables(data.variables);
                    
                    // ğŸ†• è‡ªåŠ¨æå–äººç‰©åˆ°å›¾è°±
                    if (window.characterGraphIntegration && 
                        window.characterGraphIntegration.isEnabled && 
                        gameState.variables && 
                        gameState.variables.relationships && 
                        Array.isArray(gameState.variables.relationships)) {
                        console.log(`[äººç‰©å›¾è°±] ğŸ“¥ è‡ªåŠ¨æå– ${gameState.variables.relationships.length} ä¸ªäººç‰©åˆ°å›¾è°±...`);
                        window.characterGraphIntegration.extractCharactersFromResponse(gameState.variables.relationships)
                            .catch(err => console.error('[äººç‰©å›¾è°±] æå–å¤±è´¥:', err));
                    }
                    
                    updateStatusPanel();
                    showAttributeChanges();
                } catch (error) {
                    console.error('âŒ å˜é‡æ›´æ–°å¤±è´¥ï¼ˆæ—§æ–¹æ¡ˆï¼‰:', error);
                }
            }

            // æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆä¿å­˜å‰§æƒ… + åŸå§‹å“åº”/JSONï¼‰
            if (data.story) {
                gameState.conversationHistory.push({
                    role: 'assistant',
                    content: data.story,
                    rawResponse: response,
                    parsed: data
                });

                // ä¿å­˜å½“å‰å˜é‡å¿«ç…§
                gameState.variableSnapshots.push(JSON.parse(JSON.stringify(gameState.variables)));
                
                // ã€æ–°å¢ã€‘å¦‚æœå¯ç”¨å‘é‡æ£€ç´¢ï¼Œæ·»åŠ åˆ°å‘é‡åº“
                const enableVectorRetrieval = document.getElementById('enableVectorRetrieval')?.checked || false;
                if (enableVectorRetrieval && window.contextVectorManager && gameState.conversationHistory.length >= 2) {
                    const turnIndex = Math.floor(gameState.conversationHistory.length / 2);
                    const userMessage = gameState.conversationHistory[gameState.conversationHistory.length - 2].content;
                    const aiResponse = data.story;
                    
                    // å¼‚æ­¥æ·»åŠ åˆ°å‘é‡åº“ï¼ˆä¸é˜»å¡æ¸¸æˆæµç¨‹ï¼‰
                    window.contextVectorManager.addConversation(
                        userMessage,
                        aiResponse,
                        turnIndex,
                        gameState.variables
                    ).then(async () => {
                        // ğŸ†• æå–å¹¶æ·»åŠ historyåˆ°çŸ©é˜µ
                        if (data.variableUpdate) {
                            await extractAndAddHistoryToMatrix(data.variableUpdate, turnIndex);
                        }
                        
                        // ä¿å­˜å‘é‡åº“åˆ°IndexedDB
                        return window.contextVectorManager.saveToIndexedDB();
                    }).catch(err => {
                        console.error('âŒ å‘é‡åº“æ·»åŠ å¤±è´¥:', err);
                        console.error('é”™è¯¯è¯¦æƒ…:', err.stack);
                        
                        // è‡ªåŠ¨å›é€€åˆ°å…³é”®è¯æ–¹æ³•
                        const currentMethod = window.contextVectorManager.embeddingMethod;
                        if (currentMethod !== 'keyword') {
                            console.warn(`[å‘é‡åº“] ${currentMethod}æ–¹æ³•å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å…³é”®è¯æ–¹æ³•`);
                            window.contextVectorManager.setEmbeddingMethod('keyword');
                            document.getElementById('vectorMethod').value = 'keyword';
                            
                            // æç¤ºç”¨æˆ·
                            setTimeout(() => {
                                alert(`âš ï¸ å‘é‡åŒ–å¤±è´¥\n\n${currentMethod}æ–¹æ³•å‡ºç°é”™è¯¯ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°"å…³é”®è¯åŒ¹é…"æ–¹æ³•\n\né”™è¯¯ï¼š${err.message}\n\næ¸¸æˆå°†æ­£å¸¸ç»§ç»­ï¼Œä¸å½±å“ä½¿ç”¨ã€‚`);
                            }, 1000);
                        }
                    });
                }
            }

            // æˆ˜æ–—åœºæ™¯æ£€æµ‹å·²ç¦ç”¨
            // æ¸…é™¤å¾…å¤„ç†çš„æˆ˜æ–—ä¿¡æ¯
            window.pendingCombatInfo = null;
            
            // æ­£å¸¸æ˜¾ç¤ºæ¶ˆæ¯
            displayAIMessage(data.story, data.options, data.reasoning);
            
            // ä¿å­˜æ¸¸æˆå†å²
            saveGameHistory().catch(err => console.error('ä¿å­˜å†å²å¤±è´¥:', err));

            if (gameState && gameState.localOps) {
                gameState.localOps = { items: [], attrs: [], equip: [] };
            }
        }

        // è°ƒè¯•æ¨¡å¼ï¼šåˆ‡æ¢æ˜¾ç¤ºåŒºåŸŸ
        // è°ƒè¯•æ¨¡å¼ç›¸å…³å‡½æ•°å·²è¿ç§»åˆ° game-initialization.js

        // æ¢å¤å¯¹è¯å†å²æ˜¾ç¤º
        // restoreConversationHistory å·²è¿ç§»åˆ° game-initialization.js

        /**
         * åº”ç”¨å¢é‡å˜é‡æ›´æ–°ï¼ˆæ–°æ–¹æ¡ˆï¼‰
         * @param {Object} variableChanges - AIè¿”å›çš„variableChangeså¯¹è±¡
         * @returns {Object} æ›´æ–°åçš„å˜é‡çŠ¶æ€
         */
        function applyVariableChanges(variableChanges) {
            if (!variableChanges) {
                console.warn('[å˜é‡æ›´æ–°] æ²¡æœ‰å˜é‡å˜åŒ–æ•°æ®');
                return gameState.variables;
            }

            const { analysis, changes = {}, arrayChanges, newFields = [], removedFields = [] } = variableChanges;

            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('[å˜é‡æ›´æ–°] å¼€å§‹åº”ç”¨å¢é‡æ›´æ–°');
            if (analysis) {
                console.log('[å˜é‡æ›´æ–°] åˆ†æ:', analysis);
            }
            if (Object.keys(changes).length > 0) {
                console.log('[å˜é‡æ›´æ–°] å˜åŒ–å­—æ®µ:', Object.keys(changes));
            }
            if (arrayChanges) {
                console.log('[å˜é‡æ›´æ–°] æ•°ç»„å¢é‡æ›´æ–°:', Object.keys(arrayChanges));
            }
            if (newFields.length > 0) {
                console.log('[å˜é‡æ›´æ–°] æ–°å¢å­—æ®µ:', newFields);
            }
            if (removedFields.length > 0) {
                console.log('[å˜é‡æ›´æ–°] åˆ é™¤å­—æ®µ:', removedFields);
            }

            // ä¿å­˜ä¹‹å‰çš„å˜é‡çŠ¶æ€ç”¨äºè®¡ç®—å˜åŒ–
            gameState.previousVariables = JSON.parse(JSON.stringify(gameState.variables));

            // 1. å¤„ç†æ™®é€šå­—æ®µå˜åŒ–
            for (const [key, value] of Object.entries(changes)) {
                applyFieldChange(key, value);
            }

            // 2. å¤„ç†æ•°ç»„å­—æ®µå¢é‡æ›´æ–°ï¼ˆæ–°åŠŸèƒ½ï¼‰
            if (arrayChanges) {
                applyArrayChanges(arrayChanges);
            }

            // 3. åˆ é™¤æ ‡è®°ä¸ºç§»é™¤çš„å­—æ®µ
            removedFields.forEach(field => {
                if (gameState.variables.hasOwnProperty(field)) {
                    delete gameState.variables[field];
                    console.log(`[å˜é‡æ›´æ–°] âŒ åˆ é™¤å­—æ®µ: ${field}`);
                }
            });

            console.log('[å˜é‡æ›´æ–°] âœ… å¢é‡æ›´æ–°å®Œæˆ');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            return gameState.variables;
        }

        /**
         * åº”ç”¨æ•°ç»„å­—æ®µçš„å¢é‡æ›´æ–°ï¼ˆadd/remove/updateæ¨¡å¼ï¼‰
         * @param {Object} arrayChanges - æ•°ç»„å¢é‡æ›´æ–°å¯¹è±¡
         */
        function applyArrayChanges(arrayChanges) {
            for (const [arrayName, operations] of Object.entries(arrayChanges)) {
                if (!gameState.variables[arrayName]) {
                    gameState.variables[arrayName] = [];
                }

                const array = gameState.variables[arrayName];
                const emoji = {
                    'items': 'ğŸ’',
                    'relationships': 'ğŸ‘¥',
                    'techniques': 'ğŸ“–',
                    'spells': 'âœ¨'
                }[arrayName] || 'ğŸ“';

                console.log(`[æ•°ç»„æ›´æ–°] ${emoji} å¤„ç† ${arrayName}:`);

                // 1. å¤„ç†åˆ é™¤æ“ä½œ
                if (operations.remove && operations.remove.length > 0) {
                    operations.remove.forEach(item => {
                        removeFromArray(array, item, arrayName);
                    });
                }

                // 2. å¤„ç†æ–°å¢æ“ä½œ
                if (operations.add && operations.add.length > 0) {
                    operations.add.forEach(item => {
                        addToArray(array, item, arrayName);
                    });
                }

                // 3. å¤„ç†æ›´æ–°æ“ä½œ
                if (operations.update && operations.update.length > 0) {
                    operations.update.forEach(item => {
                        updateInArray(array, item, arrayName);
                    });
                }
            }
        }

        /**
         * ä»æ•°ç»„ä¸­åˆ é™¤å…ƒç´ æˆ–å‡å°‘æ•°é‡
         * @param {Array} array - ç›®æ ‡æ•°ç»„
         * @param {Object} item - è¦åˆ é™¤çš„å…ƒç´ 
         * @param {string} arrayName - æ•°ç»„åç§°
         */
        function removeFromArray(array, item, arrayName) {
            const index = array.findIndex(el => el.name === item.name);

            if (index === -1) {
                console.warn(`  âš ï¸ å°è¯•åˆ é™¤ä¸å­˜åœ¨çš„${arrayName}: ${item.name}`);
                return;
            }

            // å¦‚æœæ˜¯itemsä¸”æŒ‡å®šäº†countï¼Œåˆ™å‡å°‘æ•°é‡
            if (arrayName === 'items' && item.count !== undefined) {
                const oldCount = array[index].count;
                array[index].count -= item.count;
                console.log(`  â– ${item.name}: æ•°é‡ -${item.count} (${oldCount} â†’ ${array[index].count})`);

                // å¦‚æœæ•°é‡<=0ï¼Œåˆ™å®Œå…¨åˆ é™¤
                if (array[index].count <= 0) {
                    array.splice(index, 1);
                    console.log(`  âŒ ${item.name}: æ•°é‡å½’é›¶ï¼Œå·²ä»ç‰©å“åˆ—è¡¨åˆ é™¤`);
                }
            } else {
                // å®Œå…¨åˆ é™¤
                array.splice(index, 1);
                console.log(`  âŒ åˆ é™¤ ${item.name}`);
            }
        }

        /**
         * å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ æˆ–å¢åŠ æ•°é‡
         * @param {Array} array - ç›®æ ‡æ•°ç»„
         * @param {Object} item - è¦æ·»åŠ çš„å…ƒç´ 
         * @param {string} arrayName - æ•°ç»„åç§°
         */
        function addToArray(array, item, arrayName) {
            const existingIndex = array.findIndex(el => el.name === item.name);

            // å¦‚æœæ˜¯itemsä¸”å·²å­˜åœ¨ï¼Œåˆ™å¢åŠ æ•°é‡
            if (arrayName === 'items' && existingIndex !== -1) {
                const oldCount = array[existingIndex].count;
                array[existingIndex].count += item.count;
                console.log(`  â• ${item.name}: æ•°é‡ +${item.count} (${oldCount} â†’ ${array[existingIndex].count})`);

                // æ›´æ–°å…¶ä»–å­—æ®µï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
                Object.assign(array[existingIndex], item);
            } else if (existingIndex !== -1) {
                // å…¶ä»–æ•°ç»„ç±»å‹ï¼Œå¦‚æœå·²å­˜åœ¨åˆ™æ›¿æ¢
                array[existingIndex] = item;
                console.log(`  ğŸ”„ æ›¿æ¢ ${item.name}`);
            } else {
                // ä¸å­˜åœ¨åˆ™æ–°å¢
                array.push(item);
                const extra = arrayName === 'items' ? ` (æ•°é‡: ${item.count})` : '';
                console.log(`  âœ… æ–°å¢ ${item.name}${extra}`);
            }
        }

        /**
         * æ›´æ–°æ•°ç»„ä¸­å·²å­˜åœ¨çš„å…ƒç´ 
         * @param {Array} array - ç›®æ ‡æ•°ç»„
         * @param {Object} item - è¦æ›´æ–°çš„å…ƒç´ ï¼ˆåŒ…å«nameå’Œè¦æ›´æ–°çš„å­—æ®µï¼‰
         * @param {string} arrayName - æ•°ç»„åç§°
         */
        function updateInArray(array, item, arrayName) {
            const existingIndex = array.findIndex(el => el.name === item.name);

            if (existingIndex === -1) {
                console.warn(`  âš ï¸ å°è¯•æ›´æ–°ä¸å­˜åœ¨çš„${arrayName}: ${item.name}`);
                return;
            }

            // è®°å½•æ—§å€¼
            const oldValues = {};
            const updatedFields = Object.keys(item).filter(k => k !== 'name');
            updatedFields.forEach(field => {
                oldValues[field] = array[existingIndex][field];
            });

            // ç‰¹æ®Šå¤„ç†ï¼šrelationshipsæ•°ç»„çš„historyå­—æ®µéœ€è¦è¿½åŠ è€Œä¸æ˜¯è¦†ç›–
            if (arrayName === 'relationships' && item.history) {
                const existingHistory = array[existingIndex].history || [];
                const newHistory = item.history || [];
                
                // å»é‡åˆå¹¶ï¼šåªæ·»åŠ ä¸é‡å¤çš„å†å²è®°å½•
                const mergedHistory = [...existingHistory];
                let addedCount = 0;
                
                newHistory.forEach(newItem => {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå†…å®¹ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼åæ¯”è¾ƒï¼‰
                    const trimmedNew = newItem.trim();
                    const isDuplicate = mergedHistory.some(existing => existing.trim() === trimmedNew);
                    
                    if (!isDuplicate && trimmedNew) {
                        mergedHistory.push(newItem);
                        addedCount++;
                    }
                });
                
                // æ›´æ–°historyå­—æ®µä¸ºåˆå¹¶åçš„æ•°ç»„
                item.history = mergedHistory;
                
                if (addedCount > 0) {
                    console.log(`    - history: è¿½åŠ äº† ${addedCount} æ¡æ–°è®°å½•ï¼ˆæ€»è®¡ï¼š${mergedHistory.length}æ¡ï¼‰`);
                }
            }

            // åˆå¹¶æ›´æ–°å­—æ®µ
            Object.assign(array[existingIndex], item);

            // è¾“å‡ºè¯¦ç»†æ—¥å¿—
            console.log(`  ğŸ”§ æ›´æ–° ${item.name}:`);
            updatedFields.forEach(field => {
                if (field === 'history' && arrayName === 'relationships') {
                    // historyå­—æ®µå·²ç»åœ¨ä¸Šé¢ç‰¹æ®Šå¤„ç†è¿‡äº†ï¼Œè·³è¿‡è¯¦ç»†æ—¥å¿—
                    return;
                }
                console.log(`    - ${field}: ${JSON.stringify(oldValues[field])} â†’ ${JSON.stringify(item[field])}`);
            });
        }

        /**
         * åº”ç”¨å•ä¸ªå­—æ®µçš„å˜åŒ–
         * @param {string} key - å­—æ®µå
         * @param {any} value - æ–°å€¼
         */
        function applyFieldChange(key, value) {
            // ========== ç‰¹æ®Šå¤„ç†1ï¼šhistoryå­—æ®µä½¿ç”¨è¿½åŠ æ¨¡å¼ ==========
            if (key === 'history') {
                if (!gameState.variables.history) {
                    gameState.variables.history = [];
                }
                if (Array.isArray(value)) {
                    let addedCount = 0;
                    value.forEach(newRecord => {
                        const trimmed = newRecord.trim();
                        const isDuplicate = gameState.variables.history.some(
                            existing => existing.trim() === trimmed
                        );
                        if (!isDuplicate && trimmed) {
                            gameState.variables.history.push(newRecord);
                            addedCount++;
                            console.log(`[å˜é‡æ›´æ–°] ğŸ“œ æ–°å¢å†å²: ${newRecord.substring(0, 50)}...`);
                        }
                    });
                    console.log(`[å˜é‡æ›´æ–°] history: è¿½åŠ äº† ${addedCount} æ¡æ–°è®°å½•`);
                }
                return;
            }

            // ========== ç‰¹æ®Šå¤„ç†2ï¼šå¯¹è±¡å­—æ®µä½¿ç”¨éƒ¨åˆ†æ›´æ–°æ¨¡å¼ ==========
            if (key === 'attributes' || key === 'equipment') {
                if (!gameState.variables[key]) {
                    gameState.variables[key] = {};
                }
                const changedKeys = Object.keys(value);
                Object.assign(gameState.variables[key], value);
                console.log(`[å˜é‡æ›´æ–°] ğŸ”§ éƒ¨åˆ†æ›´æ–° ${key}: [${changedKeys.join(', ')}]`);

                // è¯¦ç»†è®°å½•æ¯ä¸ªå­å­—æ®µçš„å˜åŒ–
                changedKeys.forEach(subKey => {
                    const oldValue = gameState.previousVariables?.[key]?.[subKey];
                    const newValue = value[subKey];
                    if (oldValue !== undefined) {
                        console.log(`  - ${subKey}: ${JSON.stringify(oldValue)} -> ${JSON.stringify(newValue)}`);
                    } else {
                        console.log(`  - ${subKey}: (æ–°å¢) ${JSON.stringify(newValue)}`);
                    }
                });
                return;
            }

            // ========== ç‰¹æ®Šå¤„ç†3ï¼šæ•°ç»„å­—æ®µä½¿ç”¨å®Œæ•´æ›¿æ¢æ¨¡å¼ï¼ˆå¸¦å®‰å…¨æ£€æŸ¥ï¼‰==========
            if (key === 'items' || key === 'relationships' || key === 'techniques' || key === 'spells') {
                const oldCount = gameState.variables[key] ? gameState.variables[key].length : 0;
                const newCount = Array.isArray(value) ? value.length : 0;

                // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢æ•°æ®ä¸¢å¤±
                if (oldCount > 5 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ ${key}æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                    console.warn(`âš ï¸ å»ºè®®æ£€æŸ¥AIè¿”å›çš„${key}æ•°ç»„æ˜¯å¦å®Œæ•´`);
                }

                gameState.variables[key] = value;

                const emoji = {
                    'items': 'ğŸ’',
                    'relationships': 'ğŸ‘¥',
                    'techniques': 'ğŸ“–',
                    'spells': 'âœ¨'
                }[key] || 'ğŸ“';

                console.log(`[å˜é‡æ›´æ–°] ${emoji} å®Œæ•´æ›¿æ¢ ${key}: ${oldCount} -> ${newCount}`);

                // å¦‚æœæ˜¯itemsï¼Œè¯¦ç»†è®°å½•æ–°å¢å’Œåˆ é™¤çš„ç‰©å“
                if (key === 'items' && gameState.previousVariables?.items) {
                    const oldItems = new Set(gameState.previousVariables.items.map(i => i.name));
                    const newItems = new Set(value.map(i => i.name));

                    const added = [...newItems].filter(name => !oldItems.has(name));
                    const removed = [...oldItems].filter(name => !newItems.has(name));

                    if (added.length > 0) {
                        console.log(`  âœ… æ–°å¢ç‰©å“: ${added.join(', ')}`);
                    }
                    if (removed.length > 0) {
                        console.log(`  âŒ ç§»é™¤ç‰©å“: ${removed.join(', ')}`);
                    }
                }

                // å¦‚æœæ˜¯relationshipsï¼Œè¯¦ç»†è®°å½•æ–°å¢å’Œåˆ é™¤çš„å…³ç³»
                if (key === 'relationships' && gameState.previousVariables?.relationships) {
                    const oldRels = new Set(gameState.previousVariables.relationships.map(r => r.name));
                    const newRels = new Set(value.map(r => r.name));

                    const added = [...newRels].filter(name => !oldRels.has(name));
                    const removed = [...oldRels].filter(name => !newRels.has(name));

                    if (added.length > 0) {
                        console.log(`  âœ… æ–°å¢å…³ç³»: ${added.join(', ')}`);
                    }
                    if (removed.length > 0) {
                        console.log(`  âŒ ç§»é™¤å…³ç³»: ${removed.join(', ')}`);
                    }
                }

                return;
            }

            // ========== é»˜è®¤å¤„ç†ï¼šç›´æ¥æ›¿æ¢ ==========
            const oldValue = gameState.variables[key];
            gameState.variables[key] = value;

            // æ ¹æ®å­—æ®µç±»å‹é€‰æ‹©åˆé€‚çš„emoji
            const emoji = {
                'hp': 'â¤ï¸',
                'mp': 'ğŸ’™',
                'spiritStones': 'ğŸ’°',
                'age': 'ğŸ“…',
                'realm': 'âš¡',
                'location': 'ğŸ“',
                'karmaFortune': 'ğŸ€',
                'karmaPunishment': 'âš ï¸',
                'cultivationProgress': 'ğŸ“ˆ',
                'faction': 'ğŸ›ï¸'
            }[key] || 'ğŸ”„';

            if (oldValue !== undefined && oldValue !== value) {
                console.log(`[å˜é‡æ›´æ–°] ${emoji} ${key}: ${JSON.stringify(oldValue)} -> ${JSON.stringify(value)}`);
            } else {
                console.log(`[å˜é‡æ›´æ–°] ${emoji} ${key}: (æ–°å¢) ${JSON.stringify(value)}`);
            }
        }

        // æ›´æ–°å˜é‡ï¼ˆæ—§æ–¹æ¡ˆï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹ï¼‰
        function updateVariables(newVars) {
            // ä¿å­˜ä¹‹å‰çš„å˜é‡çŠ¶æ€ç”¨äºè®¡ç®—å˜åŒ–
            gameState.previousVariables = JSON.parse(JSON.stringify(gameState.variables));

            // åˆå¹¶å˜é‡
            if (newVars.currentDateTime !== undefined) gameState.variables.currentDateTime = newVars.currentDateTime;
            if (newVars.name !== undefined) gameState.variables.name = newVars.name;
            if (newVars.age !== undefined) gameState.variables.age = newVars.age;
            if (newVars.gender !== undefined) gameState.variables.gender = newVars.gender;
            if (newVars.realm !== undefined) gameState.variables.realm = newVars.realm;
            if (newVars.identity !== undefined) gameState.variables.identity = newVars.identity;
            if (newVars.spiritStones !== undefined) gameState.variables.spiritStones = newVars.spiritStones;
            if (newVars.location !== undefined) gameState.variables.location = newVars.location;
            if (newVars.karmaFortune !== undefined) gameState.variables.karmaFortune = newVars.karmaFortune;
            if (newVars.karmaPunishment !== undefined) gameState.variables.karmaPunishment = newVars.karmaPunishment;
            if (newVars.cultivationProgress !== undefined) gameState.variables.cultivationProgress = newVars.cultivationProgress;
            if (newVars.cultivationProgressMax !== undefined) gameState.variables.cultivationProgressMax = newVars.cultivationProgressMax;
            if (newVars.hp !== undefined) gameState.variables.hp = newVars.hp;
            if (newVars.hpMax !== undefined) gameState.variables.hpMax = newVars.hpMax;
            if (newVars.mp !== undefined) gameState.variables.mp = newVars.mp;
            if (newVars.mpMax !== undefined) gameState.variables.mpMax = newVars.mpMax;
            if (newVars.talents !== undefined) gameState.variables.talents = newVars.talents;

            // æ›´æ–°ç‚¼ä¸¹ç‚¼å™¨ç­‰çº§
            if (newVars.alchemyLevel !== undefined) gameState.variables.alchemyLevel = newVars.alchemyLevel;
            if (newVars.craftingLevel !== undefined) gameState.variables.craftingLevel = newVars.craftingLevel;

            // æ›´æ–°åŠ¿åŠ›ä¿¡æ¯
            if (newVars.faction !== undefined) gameState.variables.faction = newVars.faction;

            // æ›´æ–°å±æ€§
            if (newVars.attributes) {
                Object.assign(gameState.variables.attributes, newVars.attributes);
            }

            // æ›´æ–°è£…å¤‡
            if (newVars.equipment) {
                Object.assign(gameState.variables.equipment, newVars.equipment);
            }

            // æ›´æ–°é“å…·ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
            if (newVars.items) {
                const oldCount = gameState.variables.items ? gameState.variables.items.length : 0;
                const newCount = newVars.items.length;
                if (oldCount > 5 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ é“å…·æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                }

                if (!Array.isArray(gameState.variables.items)) {
                    gameState.variables.items = [];
                }

                const nameIndex = new Map(gameState.variables.items.map(i => [i.name, i]));
                const equippedNames = new Set(Object.values(gameState.variables.equipment || {})
                    .filter(e => e && e.name)
                    .map(e => e.name));
                for (const incoming of newVars.items) {
                    if (!incoming || !incoming.name) continue;
                    const existing = nameIndex.get(incoming.name);
                    const isEquipped = equippedNames.has(incoming.name);
                    if (existing) {
                        if (incoming.type !== undefined) existing.type = incoming.type;
                        if (incoming.effects !== undefined) existing.effects = incoming.effects;
                        if (incoming.count !== undefined) {
                            if (incoming._op === 'set') {
                                existing.count = incoming.count;
                            } else if (incoming._op === 'decrease') {
                                existing.count = Math.max(0, (existing.count || 0) - incoming.count);
                            } else if (incoming._op === 'increase') {
                                existing.count = (existing.count || 0) + (incoming.count || 1);
                            } else {
                                // é»˜è®¤ä¸ºå¿«ç…§ï¼šä¸å¯¹å·²è£…å¤‡ç‰©å“å›ä»“ï¼Œä¸”ä¸å‡å°‘æœ¬åœ°æ¶ˆè´¹
                                if (isEquipped) {
                                    existing.count = Math.max((existing.count || 0), 0);
                                } else {
                                    existing.count = Math.max((existing.count || 0), incoming.count || 0);
                                }
                            }
                        }
                    } else {
                        // æ²¡æœ‰æœ¬åœ°è®°å½•ï¼šè‹¥è¯¥ç‰©å“å½“å‰å·²è£…å¤‡ä¸”AIæœªæä¾›_opï¼Œåˆ™è§†ä¸ºè£…å¤‡æ¥æºï¼Œé¿å…å›ä»“é‡å¤
                        if (isEquipped && !incoming._op) {
                            continue;
                        }
                        gameState.variables.items.push({
                            name: incoming.name,
                            count: incoming._op === 'set' ? (incoming.count ?? 1) : (incoming.count ?? 1),
                            type: incoming.type,
                            effects: incoming.effects
                        });
                    }
                }
            }

            // æ›´æ–°åŠŸæ³•ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
            if (newVars.techniques) {
                const oldCount = gameState.variables.techniques ? gameState.variables.techniques.length : 0;
                const newCount = newVars.techniques.length;
                if (oldCount > 3 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ åŠŸæ³•æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                }
                gameState.variables.techniques = newVars.techniques;
            }

            // æ›´æ–°æ³•æœ¯ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
            if (newVars.spells) {
                const oldCount = gameState.variables.spells ? gameState.variables.spells.length : 0;
                const newCount = newVars.spells.length;
                if (oldCount > 3 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ æ³•æœ¯æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                }
                gameState.variables.spells = newVars.spells;
            }

            // æ›´æ–°äººé™…å…³ç³»ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
            if (newVars.relationships) {
                const oldCount = gameState.variables.relationships ? gameState.variables.relationships.length : 0;
                const newCount = newVars.relationships.length;
                if (oldCount > 3 && newCount < oldCount / 2 && newCount > 0) {
                    console.warn(`âš ï¸ äººé™…å…³ç³»æ•°é‡å¼‚å¸¸å‡å°‘ï¼šä»${oldCount}ä¸ªå‡å°‘åˆ°${newCount}ä¸ªï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±ï¼`);
                }
                gameState.variables.relationships = newVars.relationships;
            }

            // æ›´æ–°å†å²ï¼ˆè¿½åŠ æ¨¡å¼ - åªæ·»åŠ æ–°è®°å½•ï¼Œä¸åˆ é™¤æ—§è®°å½•ï¼‰
            if (newVars.history && Array.isArray(newVars.history)) {
                // ç¡®ä¿historyæ•°ç»„å­˜åœ¨
                if (!gameState.variables.history) {
                    gameState.variables.history = [];
                }
                
                // è¿½åŠ æ–°å†å²è®°å½•ï¼ˆå»é‡ï¼šé¿å…æ·»åŠ å®Œå…¨ç›¸åŒçš„è®°å½•ï¼‰
                newVars.history.forEach(newRecord => {
                    const trimmedNew = newRecord.trim();
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå†…å®¹ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼åæ¯”è¾ƒï¼‰
                    const isDuplicate = gameState.variables.history.some(existing => 
                        existing.trim() === trimmedNew
                    );
                    
                    if (!isDuplicate && trimmedNew) {
                        gameState.variables.history.push(newRecord);
                        console.log('[å†å²è®°å½•] æ–°å¢:', newRecord.substring(0, 50) + '...');
                    }
                });
            }

            // æ›´æ–°UI
            updateStatusPanel();

            // æ˜¾ç¤ºå±æ€§å˜åŒ–
            showAttributeChanges();
        }

        // æ›´æ–°çŠ¶æ€é¢æ¿
        function updateStatusPanel() {
            const vars = gameState.variables;

            // ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„æ¸²æŸ“å‡½æ•°
            if (window.XiuxianGameConfig && window.XiuxianGameConfig.renderStatus) {
                window.XiuxianGameConfig.renderStatus(vars);
                return;
            }

            // ä»¥ä¸‹æ˜¯å¤‡ç”¨æ¸²æŸ“ä»£ç ï¼ˆå¦‚æœé…ç½®æ–‡ä»¶æœªåŠ è½½ï¼‰

            // æ—¶é—´
            document.getElementById('currentDateTime').textContent = vars.currentDateTime || '-';

            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('charName').textContent = vars.name || 'æœªçŸ¥';
            document.getElementById('charAge').textContent = vars.age || '-';
            document.getElementById('charGender').textContent = vars.gender || '-';
            document.getElementById('charIdentity').textContent = vars.identity || '-';
            document.getElementById('charRealm').textContent = vars.realm || '-';
            document.getElementById('charLocation').textContent = vars.location || '-';
            document.getElementById('charTalents').textContent = vars.talents && vars.talents.length > 0 ? vars.talents.join('ã€') : '-';

            // è´§å¸
            document.getElementById('spiritStones').textContent = vars.spiritStones || 0;

            // ä½“åŠ›æ³•åŠ›
            const hp = vars.hp || 0;
            const hpMax = vars.hpMax || 100;
            const mp = vars.mp || 0;
            const mpMax = vars.mpMax || 100;
            document.getElementById('hp').textContent = `${hp}/${hpMax}`;
            document.getElementById('mp').textContent = `${mp}/${mpMax}`;

            // ç‰¹æ®Šå±æ€§
            document.getElementById('karmaFortune').textContent = vars.karmaFortune || 0;
            document.getElementById('karmaPunishment').textContent = vars.karmaPunishment || 0;
            const cultivationProgress = vars.cultivationProgress || 0;
            const cultivationProgressMax = vars.cultivationProgressMax || 100;
            document.getElementById('cultivationProgress').textContent = `${cultivationProgress}/${cultivationProgressMax}`;

            // ç‚¼ä¸¹ç‚¼å™¨ç­‰çº§
            const alchemyLevel = vars.alchemyLevel || "æœªå…¥é—¨";
            const craftingLevel = vars.craftingLevel || "æœªå…¥é—¨";
            
            // ç‚¼ä¸¹ç­‰çº§
            document.getElementById('alchemyLevel').textContent = alchemyLevel;
            
            // ç‚¼å™¨ç­‰çº§
            document.getElementById('craftingLevel').textContent = craftingLevel;

            // åŠ¿åŠ›ä¿¡æ¯
            const factionInfo = document.getElementById('factionInfo');
            if (vars.faction && vars.faction.name) {
                const faction = vars.faction;
                const membersText = faction.members && faction.members.length > 0
                    ? faction.members.join('ã€')
                    : 'æ— ';

                factionInfo.innerHTML = `
                    <div class="relationship-detail-row">
                        <span class="relationship-detail-label">åŠ¿åŠ›åï¼š</span>
                        <span class="relationship-detail-value">${faction.name}</span>
                    </div>
                    ${faction.leader ? `<div class="relationship-detail-row">
                        <span class="relationship-detail-label">é¢†è¢–ï¼š</span>
                        <span class="relationship-detail-value">${faction.leader}</span>
                    </div>` : ''}
                    ${faction.location ? `<div class="relationship-detail-row">
                        <span class="relationship-detail-label">æ‰€åœ¨åœ°ï¼š</span>
                        <span class="relationship-detail-value">${faction.location}</span>
                    </div>` : ''}
                    ${faction.members && faction.members.length > 0 ? `<div class="relationship-detail-row">
                        <span class="relationship-detail-label">ä¸»è¦æˆå‘˜ï¼š</span>
                        <span class="relationship-detail-value">${membersText}</span>
                    </div>` : ''}
                    ${faction.description ? `<div class="relationship-detail-row" style="flex-direction: column; align-items: flex-start;">
                        <span class="relationship-detail-label">ä»‹ç»ï¼š</span>
                        <span class="relationship-detail-value" style="margin-top: 5px; line-height: 1.6;">${faction.description}</span>
                    </div>` : ''}
                `;
            } else {
                factionInfo.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— åŠ¿åŠ›</div>';
            }

            // æ›´æ–°é›·è¾¾å›¾ï¼ˆé›·è¾¾å›¾å†…éƒ¨ä¼šè®¡ç®—å®é™…å±æ€§ï¼‰
            drawRadarChart();

            // è£…å¤‡æ 
            updateEquipmentDisplay();

            // åŠŸæ³•åˆ—è¡¨
            const techniquesList = document.getElementById('techniquesList');
            if (vars.techniques && vars.techniques.length > 0) {
                techniquesList.innerHTML = vars.techniques.map((tech, index) => {
                    return `<div class="item-entry" style="flex-direction: column; align-items: flex-start;">
                        <div style="width: 100%;">
                            <div style="font-weight: bold; color: #667eea;">${tech.name}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">${tech.description || ''}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 3px;">
                                å¨åŠ›: ${tech.power || 0} | æ¶ˆè€—æ³•åŠ›: ${tech.mpCost || 0}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                techniquesList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— åŠŸæ³•</div>';
            }

            // æ³•æœ¯åˆ—è¡¨
            const spellsList = document.getElementById('spellsList');
            if (vars.spells && vars.spells.length > 0) {
                spellsList.innerHTML = vars.spells.map((spell, index) => {
                    return `<div class="item-entry" style="flex-direction: column; align-items: flex-start;">
                        <div style="width: 100%;">
                            <div style="font-weight: bold; color: #764ba2;">${spell.name}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">${spell.description || ''}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 3px;">
                                å¨åŠ›: ${spell.power || 0} | æ¶ˆè€—æ³•åŠ›: ${spell.mpCost || 0}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                spellsList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— æ³•æœ¯</div>';
            }

            // é“å…·
            const itemsList = document.getElementById('itemsList');
            if (vars.items && vars.items.length > 0) {
                itemsList.innerHTML = vars.items.map((item, index) => {
                    const isEquipment = item.type && item.type.startsWith('è£…å¤‡-');
                    const isPill = item.type && (item.type.includes('ä¸¹è¯') || item.type.includes('ä¸¹'));
                    
                    const equipBtn = isEquipment ? `<button class="equip-btn" onclick="equipItem('${item.name}')">è£…å¤‡</button>` : '';
                    const usePillBtn = isPill ? `<button class="equip-btn" onclick="usePill(${index})" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">æœç”¨</button>` : '';
                    
                    const effectsText = item.effects ? Object.entries(item.effects).map(([attr, value]) => {
                        if (attr === 'cultivationProgress') {
                            return `ä¿®ç‚¼è¿›åº¦+${value}`;
                        } else if (attr === 'hp') {
                            return `ä½“åŠ›${value > 0 ? '+' : ''}${value}`;
                        } else if (attr === 'mp') {
                            return `æ³•åŠ›${value > 0 ? '+' : ''}${value}`;
                        } else if (attr === 'hpMax') {
                            return `ä½“åŠ›ä¸Šé™${value > 0 ? '+' : ''}${value}`;
                        } else if (attr === 'mpMax') {
                            return `æ³•åŠ›ä¸Šé™${value > 0 ? '+' : ''}${value}`;
                        }
                        return `${getAttributeName(attr)}${value > 0 ? '+' : ''}${value}`;
                    }).join(' ') : '';

                    return `<div class="item-entry">
                        <div>
                            <div>${item.name} x${item.count}</div>
                            <div style="font-size: 11px; color: #666;">${item.type || ''} ${effectsText}</div>
                        </div>
                        <div class="item-actions">
                            ${equipBtn}
                            ${usePillBtn}
                        </div>
                    </div>`;
                }).join('');
            } else {
                itemsList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— é“å…·</div>';
            }

            // äººé™…å…³ç³»
            const relationshipsList = document.getElementById('relationshipsList');
            if (vars.relationships && vars.relationships.length > 0) {
                relationshipsList.innerHTML = vars.relationships.map((rel, index) => {
                    // æ ¹æ®å¥½æ„Ÿåº¦è®¾ç½®é¢œè‰²ç±»
                    let favorClass = '';
                    if (rel.favor >= 60) {
                        favorClass = 'high';
                    } else if (rel.favor <= -30) {
                        favorClass = 'low';
                    }

                    // æ„å»ºå†å²äº’åŠ¨è®°å½•
                    let historyHtml = '';
                    if (rel.history && rel.history.length > 0) {
                        historyHtml = `
                            <div class="relationship-history">
                                <div class="relationship-history-title">ğŸ“œ å†å²äº’åŠ¨</div>
                                ${rel.history.map(h => `<div class="relationship-history-item">â€¢ ${h}</div>`).join('')}
                            </div>
                        `;
                    }

                    return `
                        <div class="relationship-card" onclick="toggleRelationshipDetails(${index})">
                            <div class="relationship-header">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <button class="equip-btn" onclick="event.stopPropagation(); deleteRelationship(${index})" 
                                        style="background: linear-gradient(135deg, #c85a54 0%, #a84842 100%); padding: 3px 8px;">
                                        ğŸ—‘ï¸
                                    </button>
                                    <span class="relationship-name">${rel.name} (${rel.relation})</span>
                                </div>
                                <span class="relationship-favor ${favorClass}">å¥½æ„Ÿ: ${rel.favor}</span>
                            </div>
                            <div class="relationship-details" id="relationship-details-${index}">
                                ${rel.age ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">å¹´é¾„ï¼š</span>
                                    <span class="relationship-detail-value">${rel.age}å²</span>
                                </div>` : ''}
                                ${rel.realm ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">å¢ƒç•Œï¼š</span>
                                    <span class="relationship-detail-value">${rel.realm}</span>
                                </div>` : ''}
                                ${rel.personality ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">æ€§æ ¼ï¼š</span>
                                    <span class="relationship-detail-value">${rel.personality}</span>
                                </div>` : ''}
                                ${rel.opinion ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">çœ‹æ³•ï¼š</span>
                                    <span class="relationship-detail-value">${rel.opinion}</span>
                                </div>` : ''}
                                ${rel.appearance ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">å¤–è²Œï¼š</span>
                                    <span class="relationship-detail-value">${rel.appearance}</span>
                                </div>` : ''}
                                ${rel.sexualPreference ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">æ€§ç™–ï¼š</span>
                                    <span class="relationship-detail-value">${rel.sexualPreference}</span>
                                </div>` : ''}
                                ${rel.isVirgin !== undefined ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">æ˜¯å¦ä¸ºå¤„ï¼š</span>
                                    <span class="relationship-detail-value">${rel.isVirgin ? 'æ˜¯' : 'å¦'}</span>
                                </div>` : ''}
                                ${rel.firstSex ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">é¦–æ¬¡æ€§çˆ±ï¼š</span>
                                    <span class="relationship-detail-value">${rel.firstSex}</span>
                                </div>` : ''}
                                ${rel.lastSex ? `<div class="relationship-detail-row">
                                    <span class="relationship-detail-label">æœ€è¿‘æ€§çˆ±ï¼š</span>
                                    <span class="relationship-detail-value">${rel.lastSex}</span>
                                </div>` : ''}
                                ${historyHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                relationshipsList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— å…³ç³»</div>';
            }

            // å†å²
            const historyList = document.getElementById('historyList');
            if (vars.history && vars.history.length > 0) {
                historyList.innerHTML = vars.history.map((event, index) =>
                    `<div style="margin-bottom: 5px;">â€¢ ${event}</div>`
                ).join('');
            } else {
                historyList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— å†å²</div>';
            }
        }


        // è®¡ç®—å®é™…å±æ€§ï¼ˆåŸºç¡€ + è£…å¤‡åŠ æˆï¼‰
        // è®¡ç®—å½“å‰å®é™…å±æ€§ï¼ˆåŒ…å«è£…å¤‡åŠ æˆï¼‰- å·²è¿ç§»åˆ° game-core-systems.js

        // ç»˜åˆ¶å…­ç»´å±æ€§é›·è¾¾å›¾
        function drawRadarChart() {
            const canvas = document.getElementById('radarChart');
            if (!canvas) return;

            // è®¾ç½® Canvas å“åº”å¼å°ºå¯¸
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            
            // åŠ¨æ€è®¡ç®—å°ºå¯¸ï¼Œè®¾ç½®æœ€å°å€¼200pxï¼Œæœ€å¤§å€¼300px
            let size = Math.max(Math.min(containerWidth - 20, 300), 200);
            
            // æ ¹æ®å°ºå¯¸åŠ¨æ€è°ƒæ•´æ ‡ç­¾ç•™ç™½ç©ºé—´
            let labelPadding = 40; // é»˜è®¤ç•™ç™½
            let fontSize = 12; // é»˜è®¤å­—ä½“å¤§å°
            let valueFontSize = 10; // æ•°å€¼å­—ä½“å¤§å°
            
            if (size < 220) {
                labelPadding = 30;
                fontSize = 10;
                valueFontSize = 9;
            } else if (size < 260) {
                labelPadding = 35;
                fontSize = 11;
                valueFontSize = 9;
            }
            
            // è®¾ç½® Canvas å®é™…åƒç´ å°ºå¯¸ï¼ˆé«˜åˆ†è¾¨ç‡æ”¯æŒï¼‰
            const dpr = window.devicePixelRatio || 1;
            canvas.width = size * dpr;
            canvas.height = size * dpr;
            
            // è®¾ç½® CSS æ˜¾ç¤ºå°ºå¯¸
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            // è·å–å®é™…å±æ€§å€¼
            const actualAttributes = calculateActualAttributes();
            
            // å…­ç»´å±æ€§é…ç½®
            const attributes = [
                { key: 'physique', label: 'ä½“è´¨', value: actualAttributes.physique || 0 },
                { key: 'fortune', label: 'æ°”è¿', value: actualAttributes.fortune || 0 },
                { key: 'comprehension', label: 'æ‚Ÿæ€§', value: actualAttributes.comprehension || 0 },
                { key: 'spirit', label: 'ç²¾ç¥', value: actualAttributes.spirit || 0 },
                { key: 'potential', label: 'æ½œåŠ›', value: actualAttributes.potential || 0 },
                { key: 'charisma', label: 'é­…åŠ›', value: actualAttributes.charisma || 0 }
            ];

            // è®¡ç®—æœ€å¤§å€¼ï¼ˆç”¨äºç¼©æ”¾ï¼‰
            const maxValue = Math.max(...attributes.map(a => a.value), 100);
            const levels = 5; // 5ä¸ªå±‚çº§
            const center = size / 2;
            const radius = size / 2 - labelPadding; // åŠ¨æ€è°ƒæ•´æ ‡ç­¾ç©ºé—´

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, size, size);

            // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
            ctx.strokeStyle = 'rgba(139, 69, 19, 0.2)';
            ctx.fillStyle = 'rgba(139, 69, 19, 0.05)';
            
            for (let i = levels; i > 0; i--) {
                ctx.beginPath();
                const r = (radius / levels) * i;
                
                for (let j = 0; j < 6; j++) {
                    const angle = (Math.PI * 2 / 6) * j - Math.PI / 2;
                    const x = center + r * Math.cos(angle);
                    const y = center + r * Math.sin(angle);
                    
                    if (j === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }

            // ç»˜åˆ¶åˆ†éš”çº¿
            ctx.strokeStyle = 'rgba(139, 69, 19, 0.3)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI * 2 / 6) * i - Math.PI / 2;
                const x = center + radius * Math.cos(angle);
                const y = center + radius * Math.sin(angle);
                
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            // ç»˜åˆ¶å±æ€§æ•°æ®åŒºåŸŸ
            ctx.fillStyle = 'rgba(139, 69, 19, 0.3)';
            ctx.strokeStyle = 'rgba(139, 69, 19, 0.8)';
            ctx.lineWidth = 2;
            ctx.beginPath();

            attributes.forEach((attr, index) => {
                const angle = (Math.PI * 2 / 6) * index - Math.PI / 2;
                const valueRadius = (attr.value / maxValue) * radius;
                const x = center + valueRadius * Math.cos(angle);
                const y = center + valueRadius * Math.sin(angle);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ç»˜åˆ¶æ•°æ®ç‚¹
            ctx.fillStyle = 'rgba(139, 69, 19, 0.9)';
            attributes.forEach((attr, index) => {
                const angle = (Math.PI * 2 / 6) * index - Math.PI / 2;
                const valueRadius = (attr.value / maxValue) * radius;
                const x = center + valueRadius * Math.cos(angle);
                const y = center + valueRadius * Math.sin(angle);
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });

            // ç»˜åˆ¶å±æ€§æ ‡ç­¾å’Œæ•°å€¼
            ctx.fillStyle = '#8b4513';
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            attributes.forEach((attr, index) => {
                const angle = (Math.PI * 2 / 6) * index - Math.PI / 2;
                const labelRadius = radius + (labelPadding * 0.75); // æ ‡ç­¾è·ç¦»ç¨å¾®è°ƒæ•´
                let x = center + labelRadius * Math.cos(angle);
                let y = center + labelRadius * Math.sin(angle);
                
                // è°ƒæ•´æ–‡æœ¬å¯¹é½æ–¹å¼
                if (Math.abs(angle) < 0.1) {
                    ctx.textAlign = 'center';
                } else if (Math.cos(angle) > 0) {
                    ctx.textAlign = 'left';
                } else {
                    ctx.textAlign = 'right';
                }
                
                // ç»˜åˆ¶æ ‡ç­¾
                ctx.fillText(attr.label, x, y - (fontSize * 0.6));
                
                // ç»˜åˆ¶æ•°å€¼
                ctx.font = `${valueFontSize}px Arial`;
                ctx.fillStyle = '#666';
                ctx.fillText(attr.value.toString(), x, y + (valueFontSize * 0.5));
                
                // æ¢å¤å­—ä½“
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.fillStyle = '#8b4513';
            });
        }

        // æ›´æ–°è£…å¤‡æ˜¾ç¤º
        function updateEquipmentDisplay() {
            const equipment = gameState.variables.equipment;

            document.getElementById('equipHead').textContent = equipment.head ? equipment.head.name : 'ç©º';
            document.getElementById('equipClothes').textContent = equipment.clothes ? equipment.clothes.name : 'ç©º';
            document.getElementById('equipFeet').textContent = equipment.feet ? equipment.feet.name : 'ç©º';
            document.getElementById('equipTreasure1').textContent = equipment.treasure1 ? equipment.treasure1.name : 'ç©º';
            document.getElementById('equipTreasure2').textContent = equipment.treasure2 ? equipment.treasure2.name : 'ç©º';
            document.getElementById('equipTreasure3').textContent = equipment.treasure3 ? equipment.treasure3.name : 'ç©º';
        }

        // è£…å¤‡é“å…·
        function equipItem(itemName) {
            const item = gameState.variables.items.find(i => i.name === itemName);
            if (!item || !item.type || !item.type.startsWith('è£…å¤‡-')) {
                alert('è¯¥ç‰©å“ä¸èƒ½è£…å¤‡');
                return;
            }

            let equipSlot = null;
            switch (item.type) {
                case 'è£…å¤‡-å¤´éƒ¨':
                    equipSlot = 'head';
                    break;
                case 'è£…å¤‡-è¡£æœ':
                    equipSlot = 'clothes';
                    break;
                case 'è£…å¤‡-è„šéƒ¨':
                    equipSlot = 'feet';
                    break;
                case 'è£…å¤‡-ç‰¹æ®Š':
                    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºçš„ç‰¹æ®Šä½
                    if (!gameState.variables.equipment.treasure1) {
                        equipSlot = 'treasure1';
                    } else if (!gameState.variables.equipment.treasure2) {
                        equipSlot = 'treasure2';
                    } else if (!gameState.variables.equipment.treasure3) {
                        equipSlot = 'treasure3';
                    } else {
                        alert('ç‰¹æ®Šä½å·²æ»¡ï¼Œè¯·å…ˆå¸ä¸‹ä¸€ä¸ªç‰¹æ®Šè£…å¤‡');
                        return;
                    }
                    break;
                default:
                    alert('æœªçŸ¥çš„è£…å¤‡ç±»å‹');
                    return;
            }

            // å¸ä¸‹åŸæœ‰è£…å¤‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (gameState.variables.equipment[equipSlot]) {
                const oldItem = gameState.variables.equipment[equipSlot];
                // å°†æ—§è£…å¤‡æ”¾å›èƒŒåŒ…
                const existingItem = gameState.variables.items.find(i => i.name === oldItem.name);
                if (existingItem) {
                    existingItem.count++;
                } else {
                    gameState.variables.items.push({
                        name: oldItem.name,
                        count: 1,
                        type: oldItem.type || 'è£…å¤‡-æœªçŸ¥',
                        effects: oldItem.effects
                    });
                }
            }

            // è£…å¤‡æ–°ç‰©å“
            gameState.variables.equipment[equipSlot] = {
                name: item.name,
                type: item.type,
                effects: item.effects || {}
            };

            // ä»èƒŒåŒ…ä¸­ç§»é™¤ä¸€ä¸ª
            item.count--;
            if (item.count <= 0) {
                const index = gameState.variables.items.indexOf(item);
                gameState.variables.items.splice(index, 1);
            }

            // ğŸ†• è®°å½•è£…å¤‡æ“ä½œåˆ°ç¼“å­˜ï¼ˆåªè®°å½•æœ€åè£…å¤‡çš„ï¼‰
            gameState.pendingActions.equipment = item.name;

            // æ›´æ–°UI
            updateStatusPanel();

            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));
        }

        // å¸ä¸‹è£…å¤‡
        function unequipItem(slot) {
            const equipment = gameState.variables.equipment[slot];
            if (!equipment) {
                return; // æ²¡æœ‰è£…å¤‡ï¼Œä¸åšä»»ä½•æ“ä½œ
            }

            // å°†è£…å¤‡æ”¾å›èƒŒåŒ…
            const existingItem = gameState.variables.items.find(i => i.name === equipment.name);
            if (existingItem) {
                existingItem.count++;
            } else {
                gameState.variables.items.push({
                    name: equipment.name,
                    count: 1,
                    type: equipment.type || 'è£…å¤‡-æœªçŸ¥',
                    effects: equipment.effects
                });
            }

            // æ¸…ç©ºè£…å¤‡æ 
            gameState.variables.equipment[slot] = null;

            // æ›´æ–°UI
            updateStatusPanel();

            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));
        }

        // æœç”¨ä¸¹è¯
        function usePill(itemIndex) {
            const item = gameState.variables.items[itemIndex];
            if (!item || !item.type || !(item.type.includes('ä¸¹è¯') || item.type.includes('ä¸¹'))) {
                alert('è¯¥ç‰©å“ä¸æ˜¯ä¸¹è¯');
                return;
            }

            if (item.count <= 0) {
                alert('ä¸¹è¯æ•°é‡ä¸è¶³');
                return;
            }

            // åº”ç”¨ä¸¹è¯æ•ˆæœ
            if (item.effects) {
                let effectMessages = [];

                Object.entries(item.effects).forEach(([attr, value]) => {
                    if (attr === 'cultivationProgress') {
                        // å¢åŠ ä¿®ç‚¼è¿›åº¦
                        gameState.variables.cultivationProgress = (gameState.variables.cultivationProgress || 0) + value;
                        effectMessages.push(`ä¿®ç‚¼è¿›åº¦+${value}`);

                        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°çªç ´æ¡ä»¶
                        if (gameState.variables.cultivationProgress >= gameState.variables.cultivationProgressMax) {
                            effectMessages.push('å·²è¾¾åˆ°çªç ´æ¡ä»¶ï¼è¯·åœ¨å‰§æƒ…ä¸­é€‰æ‹©çªç ´é€‰é¡¹');
                        }
                    } else if (attr === 'hp') {
                        // æ¢å¤ä½“åŠ›
                        gameState.variables.hp = Math.min(
                            (gameState.variables.hp || 0) + value,
                            gameState.variables.hpMax || 100
                        );
                        effectMessages.push(`ä½“åŠ›+${value}`);
                    } else if (attr === 'mp') {
                        // æ¢å¤æ³•åŠ›
                        gameState.variables.mp = Math.min(
                            (gameState.variables.mp || 0) + value,
                            gameState.variables.mpMax || 100
                        );
                        effectMessages.push(`æ³•åŠ›+${value}`);
                    } else if (attr === 'hpMax') {
                        // å¢åŠ ä½“åŠ›ä¸Šé™
                        gameState.variables.hpMax = (gameState.variables.hpMax || 100) + value;
                        effectMessages.push(`ä½“åŠ›ä¸Šé™+${value}`);
                    } else if (attr === 'mpMax') {
                        // å¢åŠ æ³•åŠ›ä¸Šé™
                        gameState.variables.mpMax = (gameState.variables.mpMax || 100) + value;
                        effectMessages.push(`æ³•åŠ›ä¸Šé™+${value}`);
                    } else if (gameState.variables.attributes && attr in gameState.variables.attributes) {
                        // å¢åŠ å±æ€§
                        gameState.variables.attributes[attr] = (gameState.variables.attributes[attr] || 0) + value;
                        effectMessages.push(`${getAttributeName(attr)}+${value}`);
                    }
                });

                // å‡å°‘ä¸¹è¯æ•°é‡
                item.count--;
                if (item.count <= 0) {
                    gameState.variables.items.splice(itemIndex, 1);
                }

                // ğŸ†• è®°å½•æœç”¨ä¸¹è¯åˆ°ç¼“å­˜ï¼ˆç´¯åŠ æ•°é‡ï¼‰
                if (!gameState.pendingActions.pills[item.name]) {
                    gameState.pendingActions.pills[item.name] = 0;
                }
                gameState.pendingActions.pills[item.name]++;

                // æ›´æ–°UI
                updateStatusPanel();

                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));

                // æ˜¾ç¤ºæ•ˆæœæç¤º
                alert(`æœç”¨${item.name}æˆåŠŸï¼\n${effectMessages.join('\n')}`);
            } else {
                alert('è¯¥ä¸¹è¯æ²¡æœ‰æ•ˆæœ');
            }
        }

        // åˆ é™¤äººé™…å…³ç³»
        function deleteRelationship(relIndex) {
            const relationship = gameState.variables.relationships[relIndex];
            if (!relationship) {
                alert('è¯¥äººé™…å…³ç³»ä¸å­˜åœ¨');
                return;
            }

            // ç¡®è®¤åˆ é™¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¸"${relationship.name}"çš„å…³ç³»å—ï¼Ÿ\n\nå…³ç³»ï¼š${relationship.relation}\nå¥½æ„Ÿåº¦ï¼š${relationship.favor}`)) {
                return;
            }

            // ä»æ•°ç»„ä¸­åˆ é™¤
            gameState.variables.relationships.splice(relIndex, 1);

            // æ›´æ–°UI
            updateStatusPanel();

            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameHistory().catch(err => console.error('ä¿å­˜å¤±è´¥:', err));

            // æ˜¾ç¤ºæç¤º
            alert(`å·²åˆ é™¤ä¸"${relationship.name}"çš„å…³ç³»ï¼`);
        }

        // è·å–å±æ€§ä¸­æ–‡å
        function getAttributeName(attr) {
            const names = {
                physique: 'ä½“è´¨',
                fortune: 'æ°”è¿',
                comprehension: 'æ‚Ÿæ€§',
                spirit: 'ç²¾ç¥',
                potential: 'æ½œåŠ›',
                charisma: 'é­…åŠ›',
                karmaFortune: 'æœºç¼˜å€¼',
                karmaPunishment: 'å¤©è°´å€¼'
            };
            return names[attr] || attr;
        }

        // è§£æé€‰é¡¹ä¸­çš„å±æ€§è¦æ±‚
        // æ ¼å¼ï¼šé€‰é¡¹æ–‡æœ¬ï¼ˆå±æ€§>æ•°å€¼ï¼‰æˆ– é€‰é¡¹æ–‡æœ¬ï¼ˆå±æ€§å>æ•°å€¼ï¼‰
        // ä»¥ä¸‹å‡½æ•°å·²è¿ç§»åˆ° game-core-systems.js:
        // - parseAttributeRequirement
        // - checkAttributeRequirement
        // - showAttributeChanges
        // - calculateActualAttributesFor
        // - showChange
        // - calculateActualAttributes

        // æ£€æŸ¥å±æ€§æ˜¯å¦æ»¡è¶³è¦æ±‚ - å·²è¿ç§»åˆ° game-core-systems.js

        // æ˜¾ç¤ºå±æ€§å˜åŒ– - å·²è¿ç§»åˆ° game-core-systems.js

        // è®¡ç®—æŒ‡å®šçŠ¶æ€çš„å®é™…å±æ€§ - å·²è¿ç§»åˆ° game-core-systems.js

        // æ˜¾ç¤ºå•ä¸ªå±æ€§å˜åŒ– - å·²è¿ç§»åˆ° game-core-systems.js

        // ==================== æ¶ˆæ¯ç®¡ç†ç³»ç»Ÿ ====================
        // toggleDeleteMode, confirmDelete, cancelDelete å·²è¿ç§»åˆ° game-core-systems.js
        
        // å¤„ç†æ¶ˆæ¯å‹¾é€‰ï¼ˆè‡ªåŠ¨é€‰ä¸­ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼‰- ä¿ç•™åœ¨game.htmlä¸­
        function handleMessageCheck(messageDiv) {
            const checkbox = messageDiv.querySelector('.message-checkbox');
            const allMessages = Array.from(document.querySelectorAll('.message'));
            const currentIndex = allMessages.indexOf(messageDiv);

            if (checkbox.checked) {
                // å‹¾é€‰å½“å‰æ¶ˆæ¯ï¼Œè‡ªåŠ¨å‹¾é€‰ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
                for (let i = currentIndex; i < allMessages.length; i++) {
                    const msg = allMessages[i];
                    const cb = msg.querySelector('.message-checkbox');
                    if (cb) {
                        cb.checked = true;
                        msg.classList.add('selected-for-delete');
                    }
                }
            } else {
                // å–æ¶ˆå‹¾é€‰å½“å‰æ¶ˆæ¯ï¼Œè‡ªåŠ¨å–æ¶ˆä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯
                for (let i = 0; i <= currentIndex; i++) {
                    const msg = allMessages[i];
                    const cb = msg.querySelector('.message-checkbox');
                    if (cb) {
                        cb.checked = false;
                        msg.classList.remove('selected-for-delete');
                    }
                }
            }
        }

        // ğŸ¯ ç»Ÿä¸€æ„å»ºå¢å¼ºæç¤ºçš„å‡½æ•°
        function buildEnhancedPrompt(userMessage, options = {}) {
            // è·å–é…ç½®
            const saved = localStorage.getItem('gameConfig');
            const config = saved ? JSON.parse(saved) : {};

            // ğŸ†• æ˜ç¡®æ ‡è¯†è¿™æ˜¯ç”¨æˆ·çš„è¦æ±‚
            let enhancedPrompt = `ã€åç»­æƒ…èŠ‚ã€‘${userMessage}`;

            // 1. æ ¹æ®æœºç¼˜å€¼å’Œå¤©è°´å€¼æ·»åŠ æç¤º
            if (gameState.variables.karmaFortune >= 80) {
                enhancedPrompt += '\n\n[æœºç¼˜é«˜â†’å¥½å‰§æƒ…]';
            } else if (gameState.variables.karmaPunishment >= 80) {
                enhancedPrompt += '\n\n[å¤©è°´é«˜â†’åå‰§æƒ…]';
            }

            // 2. è·å–æœ€å°å­—æ•°è¦æ±‚
            const minWordCount = config.minWordCount || 0;

            // 3. å¦‚æœæ˜¯é€‰é¡¹æ¨¡å¼ï¼Œæ·»åŠ å±æ€§åˆ¤å®šç»“æœ
            if (options.attributeCheck) {
                const { requirement, checkResult } = options.attributeCheck;
                if (requirement.hasRequirement) {
                    if (checkResult.met) {
                        enhancedPrompt += `\n\n[åˆ¤å®šé€šè¿‡ï¼š${checkResult.attributeName}${checkResult.currentValue}${requirement.operator}${checkResult.requiredValue}â†’æˆåŠŸå‰§æƒ…]`;
                    } else {
                        enhancedPrompt += `\n\n[åˆ¤å®šå¤±è´¥ï¼š${checkResult.attributeName}${checkResult.currentValue}ä¸è¶³${checkResult.requiredValue}â†’å¤±è´¥å‰§æƒ…]`;
                    }
                }
            }

            // 4. å¼ºåˆ¶è¦æ±‚æ›´æ–°å˜é‡å’Œç”Ÿæˆé€‰é¡¹
            enhancedPrompt += '\n\n[å¿…é¡»è¿”å›4é€‰é¡¹(å«å±æ€§åˆ¤å®š)ï¼Œé¡ºåºï¼š1.å¯¹è¯ 2.ç¦»å¼€ 3.è¡ŒåŠ¨ 4.R18]';

            // 5. æ·»åŠ æœ€å°å­—æ•°è¦æ±‚
            if (minWordCount > 0) {
                enhancedPrompt += `\n\n[storyâ‰¥${minWordCount}å­—]`;
            }

            // 6. æ€§çˆ±åœºæ™¯æå†™è¦æ±‚
            enhancedPrompt += '\n\n[R18åœºæ™¯è¯¦å†™è¿‡ç¨‹ï¼Œè¯­è¨€åŠ¨ä½œè¡¨æƒ…å¤šæ–¹é¢æå†™ï¼Œä¸å‡†ä¸»åŠ¨ç»“æŸæ€§çˆ±åœºæ™¯ï¼Œéœ€è¦ç©å®¶ä¸»åŠ¨ç»“æŸ]';

            // 8. äººé™…å…³ç³»æé†’ï¼ˆv3.1æ ¼å¼ï¼‰
            enhancedPrompt += '\n\n[NPCäº’åŠ¨åœ¨variableUpdateä¸­æ›´æ–°ï¼šrelationships.NPCåå­—={favor:æ•°å€¼,opinion:"è¯„ä»·",history:["äº‹ä»¶"]}ã€‚R18å¿…æ›´æ–°ï¼šisVirgin/firstSex/lastSex/sexualPreference/appearance]';

            // 9. å˜é‡æ›´æ–°è¯´æ˜ï¼ˆv3.1æ ¼å¼ï¼‰
            enhancedPrompt += '\n\n[ä½¿ç”¨variableUpdateå­—æ®µï¼Œæ ¼å¼ï¼š{"å±æ€§è·¯å¾„":å€¼}ã€‚ä¾‹ï¼š{"hp":100,"items.çµçŸ³":50,"relationships.æŸ³å¦‚çƒŸ.favor":80}]';

            // 10. å†å²è®°å½•è¦æ±‚
            enhancedPrompt += '\n\n[historyè¿”å›1æ¡â‰¥40å­—ã€‚]';

            // 12. ç‚¼ä¸¹ç‚¼å™¨ç­‰çº§æç¤º
            const alchemyLevel = gameState.variables.alchemyLevel || "æœªå…¥é—¨";
            const craftingLevel = gameState.variables.craftingLevel || "æœªå…¥é—¨";
            
            // ç‚¼ä¸¹ç­‰çº§æç¤º
            if (alchemyLevel !== "æœªå…¥é—¨") {
                enhancedPrompt += `\n\n[å½“å‰ç‚¼ä¸¹ç­‰çº§ï¼š${alchemyLevel}ï¼Œæ ¹æ®ç­‰çº§åˆ¤æ–­æˆåŠŸç‡å’Œä¸¹è¯å“è´¨]`;
            }
            
            // ç‚¼å™¨ç­‰çº§æç¤º
            if (craftingLevel !== "æœªå…¥é—¨") {
                enhancedPrompt += `\n\n[å½“å‰ç‚¼å™¨ç­‰çº§ï¼š${craftingLevel}ï¼Œæ ¹æ®ç­‰çº§åˆ¤æ–­æˆåŠŸç‡å’Œç‰¹æ®Šè£…å¤‡å“è´¨]`;
            }

            // 13. æ·»åŠ æœ¬åœ°æ“ä½œæ‘˜è¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const hasLocalOps = gameState.localOps && (
                (gameState.localOps.items && gameState.localOps.items.length > 0) ||
                (gameState.localOps.attrs && gameState.localOps.attrs.length > 0) ||
                (gameState.localOps.equip && gameState.localOps.equip.length > 0)
            );
            
            if (hasLocalOps) {
                const localOpsSummary = {
                    items: gameState.localOps.items || [],
                    attrs: gameState.localOps.attrs || [],
                    equip: gameState.localOps.equip || []
                };
                enhancedPrompt += '\n\n[æœ¬åœ°æ“ä½œè®°å½•]' + JSON.stringify(localOpsSummary);
            }

            return enhancedPrompt;
        }

        // å‘é€ç”¨æˆ·è‡ªå®šä¹‰è¾“å…¥
        async function sendUserInput() {
            const inputBox = document.getElementById('userInput');
            let userText = inputBox.value.trim();

            if (!userText) {
                alert('è¯·è¾“å…¥å†…å®¹ï¼');
                return;
            }

            if (gameState.isProcessing) return;

            if (!gameState.isGameStarted) {
                alert('è¯·å…ˆåˆ›å»ºè§’è‰²å¹¶å¼€å§‹æ¸¸æˆï¼');
                return;
            }

            // ğŸ†• è‡ªåŠ¨é™„åŠ æ“ä½œç¼“å­˜
            const actionsSummary = getPendingActionsSummary();
            if (actionsSummary) {
                userText = actionsSummary + userText;
            }

            // ğŸ†• åœ¨æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´çš„ç”¨æˆ·è¾“å…¥
            console.log('ğŸ“¤ [ç”¨æˆ·è¾“å…¥]', userText);

            // æ¸…ç©ºè¾“å…¥æ¡†
            inputBox.value = '';

            gameState.isProcessing = true;

            // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
            displayUserMessage(userText);

            // æ·»åŠ åˆ°å†å²è®°å½•
            gameState.conversationHistory.push({
                role: 'user',
                content: userText
            });

            // ä¿å­˜å½“å‰å˜é‡å¿«ç…§ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰
            gameState.variableSnapshots.push(JSON.parse(JSON.stringify(gameState.variables)));

            // ğŸ†• æ¸…ç©ºæ“ä½œç¼“å­˜
            clearPendingActions();

            // ä¿å­˜æ¸¸æˆå†å²
            saveGameHistory().catch(err => console.error('ä¿å­˜å†å²å¤±è´¥:', err));

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const historyDiv = document.getElementById('gameHistory');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai-message';
            loadingDiv.innerHTML = '<div class="message-content"><span class="loading"></span> AIæ€è€ƒä¸­...</div>';
            loadingDiv.id = 'loading-message';
            historyDiv.appendChild(loadingDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            try {
                // ğŸ¯ ä½¿ç”¨ç»Ÿä¸€å‡½æ•°æ„å»ºå¢å¼ºæç¤º
                const enhancedInput = buildEnhancedPrompt(userText);

                // ğŸ†• åœ¨æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´çš„å¢å¼ºæç¤º
                console.log('ğŸ¤– [å‘é€ç»™AIçš„å®Œæ•´Prompt]', enhancedInput);

                // ğŸ”§ ä¼ å…¥åŸå§‹ç”¨æˆ·è¾“å…¥ï¼ˆç”¨äºå‘é‡æ£€ç´¢ï¼‰
                const response = await callAI(enhancedInput, false, userText);

                // ç§»é™¤åŠ è½½æç¤º
                const loading = document.getElementById('loading-message');
                if (loading) loading.remove();

                handleAIResponse(response);

                // è§¦å‘åŠ¨æ€ä¸–ç•Œç”Ÿæˆï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                generateDynamicWorld().catch(err => console.error('[åŠ¨æ€ä¸–ç•Œ] ç”Ÿæˆå¼‚å¸¸:', err));

            } catch (error) {
                // ç§»é™¤åŠ è½½æç¤º
                const loading = document.getElementById('loading-message');
                if (loading) loading.remove();

                // âŒ ä¸è¦ç§»é™¤ç”¨æˆ·æ¶ˆæ¯ï¼æ˜¾ç¤ºé”™è¯¯å’Œé‡è¯•æŒ‰é’®
                displayErrorMessageWithRetry('AIå“åº”å¤±è´¥ï¼š' + error.message, async () => {
                    // ç§»é™¤é”™è¯¯æ¶ˆæ¯
                    const errorDiv = document.getElementById('error-message-with-retry');
                    if (errorDiv) errorDiv.remove();
                    
                    // é‡æ–°ç”Ÿæˆæœ€åçš„å“åº”
                    await regenerateLastResponse();
                });
            }

            gameState.isProcessing = false;
        }


        // ==================== æ ¼å¼åŒ–æ¸¸æˆ ====================
        // formatGame åœ¨ game-core-systems.js æœ‰ç®€åŒ–ç‰ˆæœ¬
        // ä½†è¿™é‡Œä¿ç•™å®Œæ•´ç‰ˆæœ¬ï¼ŒåŒ…å«æ¸¸æˆçŠ¶æ€é‡ç½®é€»è¾‘
        async function formatGame() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ ¼å¼åŒ–å°†æ¸…é™¤æ‰€æœ‰å­˜æ¡£å’Œè¿›åº¦ï¼ŒåŒ…æ‹¬DLCçŸ¥è¯†åŒ…ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nâœ… å°†ä¿ç•™ï¼š\n- APIé…ç½®\n- æ¸¸æˆè®¾ç½®\n- åŠ¨æ€ä¸–ç•Œè®¾ç½®\n\nç¡®å®šè¦æ ¼å¼åŒ–å—ï¼Ÿ')) {
                return;
            }

            console.log('[æ ¼å¼åŒ–] å¼€å§‹æ ¼å¼åŒ–ï¼Œå°†ä¿ç•™ API é…ç½®ã€æ¸¸æˆè®¾ç½®å’ŒåŠ¨æ€ä¸–ç•Œè®¾ç½®');
            
            // é‡ç½®çŠ¶æ€
            gameState.variables = {
                name: "",
                gender: "",
                realm: "",
                identity: "",
                karmaFortune: 0,
                karmaPunishment: 0,
                cultivationProgress: 0,
                cultivationProgressMax: 100,
                hp: 100,
                hpMax: 100,
                mp: 100,
                mpMax: 100,
                talents: [],
                attributes: {
                    physique: 0,
                    fortune: 0,
                    comprehension: 0,
                    spirit: 0,
                    potential: 0,
                    charisma: 0
                },
                equipment: {
                    head: null,
                    clothes: null,
                    feet: null,
                    treasure1: null,
                    treasure2: null,
                    treasure3: null
                },
                items: [],
                techniques: [],
                spells: [],
                relationships: [],
                location: "",
                history: []
            };
            gameState.previousVariables = null;
            gameState.conversationHistory = [];
            gameState.variableSnapshots = [];
            gameState.isGameStarted = false;
            gameState.isProcessing = false;
            gameState.characterInfo = null;

            // æ¸…é™¤ IndexedDB ä¸­çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬æ‰€æœ‰å­˜æ¡£ï¼‰
            try {
                await clearGameHistory();
            } catch (error) {
                console.error('æ¸…é™¤æ•°æ®å¤±è´¥:', error);
            }
            
            // ã€æ–°å¢ã€‘æ¸…ç©ºå‘é‡åº“
            if (window.contextVectorManager) {
                window.contextVectorManager.clear();
                window.contextVectorManager.saveToIndexedDB().catch(err => {
                    console.error('æ¸…ç©ºå‘é‡åº“å¤±è´¥:', err);
                });
                
                // æ¸…ç©ºé™æ€çŸ¥è¯†åº“
                window.contextVectorManager.clearStaticKB();
                window.contextVectorManager.saveStaticKBToIndexedDB().catch(err => {
                    console.error('æ¸…ç©ºé™æ€çŸ¥è¯†åº“å¤±è´¥:', err);
                });
            }

            // æ¸…ç©ºDLCæ•°æ®
            if (window.dlcManager) {
                try {
                    await window.dlcManager.clearAllDLCs();
                    console.log('[æ ¼å¼åŒ–] å·²æ¸…ç©ºæ‰€æœ‰DLCæ•°æ®');
                } catch (error) {
                    console.error('[æ ¼å¼åŒ–] æ¸…ç©ºDLCæ•°æ®å¤±è´¥:', error);
                }
            }

            // é‡ç½®åŠ¨æ€ä¸–ç•Œæ•°æ®ï¼ˆä¿ç•™ enabled å’Œ messageInterval è®¾ç½®ï¼‰
            gameState.dynamicWorld = {
                enabled: gameState.dynamicWorld?.enabled || false,
                history: [],
                floor: 0,
                isProcessing: false,
                messageInterval: gameState.dynamicWorld?.messageInterval || 1, // ä¿ç•™é—´éš”è®¾ç½®
                messageCounter: 0 // é‡ç½®è®¡æ•°å™¨
            };
            console.log('[æ ¼å¼åŒ–] å·²é‡ç½®åŠ¨æ€ä¸–ç•Œæ•°æ®ï¼ˆå·²ä¿ç•™ enabled å’Œ messageInterval è®¾ç½®ï¼‰');
            
            // æ›´æ–°åŠ¨æ€ä¸–ç•ŒTabæ˜¾ç¤º
            displayDynamicWorldHistory();

            // æ›´æ–°çŠ¶æ€é¢æ¿
            updateStatusPanel();

            // æ˜¾ç¤ºä¸»èœå•
            showMainMenu();
        }

        // åˆ‡æ¢ç§»åŠ¨ç«¯tab
        function switchMobileTab(tabName) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.game-panel').classList.remove('active');
            document.querySelector('.status-panel').classList.remove('active');

            // æ·»åŠ å¯¹åº”çš„activeç±»
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            if (tabName === 'game') {
                document.querySelector('.game-panel').classList.add('active');
            } else if (tabName === 'status') {
                document.querySelector('.status-panel').classList.add('active');
            }
        }

        // åˆ‡æ¢äººé™…å…³ç³»è¯¦æƒ…å±•å¼€/æŠ˜å 
        function toggleRelationshipDetails(index) {
            console.log('Toggle called for index:', index); // Debug log
            const detailsDiv = document.getElementById(`relationship-details-${index}`);
            console.log('Found details div:', detailsDiv); // Debug log
            
            if (!detailsDiv) {
                console.error('Details div not found for index:', index);
                return;
            }
            
            const cardDiv = detailsDiv.parentElement;
            console.log('Current classes - details:', detailsDiv.className, 'card:', cardDiv.className); // Debug log
            
            if (detailsDiv.classList.contains('show')) {
                // æŠ˜å 
                detailsDiv.classList.remove('show');
                cardDiv.classList.remove('expanded');
                console.log('Collapsed'); // Debug log
            } else {
                // å±•å¼€
                detailsDiv.classList.add('show');
                cardDiv.classList.add('expanded');
                console.log('Expanded'); // Debug log
            }
        }

       
    </script>


    <div id="combatModal" class="combat-modal"></div>

    <!-- æ‚¬æµ®æ‰‹æœºå›¾æ ‡ï¼ˆé»˜è®¤éšè—ï¼Œéœ€åœ¨è®¾ç½®ä¸­å¯ç”¨ï¼‰ -->
    <div id="mobileFloatBtn" class="mobile-float-btn" onclick="toggleMobilePopup()" style="display: none;">
        <div class="phone-icon">ğŸ“±</div>
        <div class="phone-pulse"></div>
    </div>

    <!-- æ‰‹æœºå¼¹çª— -->
    <div id="mobilePopupOverlay" class="mobile-popup-overlay" onclick="closeMobilePopup(event)">
        <div class="mobile-popup-container">

            <iframe id="mobileFrame" class="mobile-frame" src="../mobile/mobile.html"></iframe>
        </div>
    </div>

    <style>
        /* æ‚¬æµ®æ‰‹æœºæŒ‰é’® */
        .mobile-float-btn {
            position: fixed;
            right: 20px;
            bottom: 100px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 9998;
            transition: all 0.3s ease;
        }
        
        .mobile-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }
        
        .mobile-float-btn .phone-icon {
            font-size: 28px;
            z-index: 2;
        }
        
        .mobile-float-btn .phone-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: phonePulse 2s ease-out infinite;
            z-index: 1;
        }
        
        @keyframes phonePulse {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* å¼¹çª—é®ç½© */
        .mobile-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .mobile-popup-overlay.show {
            display: flex;
            opacity: 1;
        }
        
        /* æ‰‹æœºå®¹å™¨ */
        .mobile-popup-container {
            width: 380px;
            height: 780px;
           
            border-radius: 40px;
            overflow: hidden;
            
            transform: scale(0.8);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .mobile-popup-overlay.show .mobile-popup-container {
            transform: scale(1);
        }
        
        /* å¼¹çª—å¤´éƒ¨ */
        .mobile-popup-header {
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .mobile-popup-close {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .mobile-popup-close:hover {
            background: rgba(255,255,255,0.4);
            transform: rotate(90deg);
        }
        
        /* iframe æ¡†æ¶ */
        .mobile-frame {
            flex: 1;
            width: 100%;
            border: none;

        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-height: 850px) {
            .mobile-popup-container {
                height: 90vh;
                width: 340px;
            }
        }
        
        @media (max-width: 450px) {
            .mobile-popup-container {
                width: 95vw;
                height: 85vh;
                border-radius: 20px;
            }
            
            .mobile-float-btn {
                right: 15px;
                bottom: 80px;
                width: 50px;
                height: 50px;
            }
            
            .mobile-float-btn .phone-icon {
                font-size: 24px;
            }
        }
    </style>

    <script>
        // æ‰‹æœºå¼¹çª—æ§åˆ¶
        function toggleMobilePopup() {
            const overlay = document.getElementById('mobilePopupOverlay');
            if (overlay.classList.contains('show')) {
                closeMobilePopup(null, true);
            } else {
                openMobilePopup();
            }
        }
        
        function openMobilePopup() {
            const overlay = document.getElementById('mobilePopupOverlay');
            overlay.style.display = 'flex';
            // è§¦å‘é‡æ’ä»¥å¯ç”¨è¿‡æ¸¡åŠ¨ç”»
            overlay.offsetHeight;
            overlay.classList.add('show');
        }
        
        function closeMobilePopup(event, forceClose = false) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯é®ç½©å±‚æœ¬èº«ï¼Œæˆ–è€…å¼ºåˆ¶å…³é—­
            if (forceClose || (event && event.target.id === 'mobilePopupOverlay')) {
                const overlay = document.getElementById('mobilePopupOverlay');
                overlay.classList.remove('show');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        }
        
        // ESC é”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMobilePopup(null, true);
            }
        });
    </script>
    
</body>

</html> 